<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>טופס פתיחת פרויקט חדש</title>
<style>
/* ✅ **סגנון כללי לכל העמוד** */
body {
    font-family: Arial, sans-serif;
    direction: rtl; /* עברית – מימין לשמאל */
    text-align: center;
    background-color: rgba(0, 0, 0, 0.5); /* רקע כהה חצי-שקוף */
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

/* ✅ **תיבת הטופס הראשית** */
.form-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 820px; /* מבטיח שהתוכן לא יחרוג ממסכים קטנים */
    text-align: right;
    position: relative;
    margin: auto;
}

/* ✅ **עיצוב כללי לשדות קלט, בחירה ואזורים להקלדה** */
.form-container input,
.form-container select,
.form-container textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    appearance: none;
    background-color: white;
    cursor: pointer;
    box-sizing: border-box;
}

/* ✅ **סגנון לכותרות של שדות בטופס** */
label {
    font-weight: bold;
}

/* ✅ **קבוצת השדות בטופס** */
.form-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-bottom: 10px;
    position: relative;
    width: 100%;
}

/* ✅ **שדות קריאה בלבד – רקע אפור ומונעים עריכה** */
input[readonly] {
    background-color: #f0f0f0;
    cursor: not-allowed;
}

/* ✅ **שגיאות בטופס – תצוגה ברורה** */
.error-message {
    color: red;
    font-size: 12px;
    display: none;
    margin-top: 5px;
}

/* ✅ **תיבת הצעות אוטומטיות (autocomplete)** */
.autocomplete-suggestions {
    position: absolute;
    border: 1px solid #ccc;
    background: white;
    max-height: 150px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    top: 100%;
    right: 0;
    display: none;
    border-radius: 4px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

/* ✅ **תצוגת כל הצעה ברשימה הנפתחת** */
.autocomplete-suggestion {
    padding: 8px;
    cursor: pointer;
}

/* ✅ **שינוי צבע לרקע בהצעה שנבחרה או שמרחפים מעליה** */
.autocomplete-suggestion.selected,
.autocomplete-suggestion:hover {
    background: #f0f0f0;
}

/* ✅ **סגנון תיבות בחירה (SELECT) – מוסיף חץ קטן משמאל** */
select {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="gray"><path d="M7 10l5 5 5-5z"/></svg>'); 
    background-repeat: no-repeat;
    background-position: left 10px center;
    background-size: 16px;
    padding-right: 30px;
}

/* ✅ **חיווי טעינה (בהמתנה לנתונים מהשרת)** */
#loadingMessage {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: rgba(255, 255, 0, 0.8);
    color: black;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    padding: 10px;
    z-index: 1000;
    display: none;
}

/* ✅ **כפתורים – שחזור מלא של הצורה הקודמת** */
.button-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
}

/* ✅ **כל הכפתורים – שחזור העיצוב המקורי** */
button {
    padding: 12px 20px;
    font-size: 14px;
    font-weight: bold;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    width: auto; /* שומר על גמישות ברוחב */
    min-width: 120px; /* מבטיח שהם לא יהיו קטנים מדי */
    transition: background-color 0.3s ease;
}

/* ✅ **כפתור "אישור" – ירוק** */
#submitButton {
    background-color: #4CAF50;
    color: white;
}

/* ✅ **כפתור "אישור" מושבת – אפור ולא לחיץ** */
#submitButton:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

/* ✅ **כפתור "ביטול" – אדום** */
#cancelButton {
    background-color: #f44336;
    color: white;
}

/* ✅ **אנימציה בעת מעבר עכבר (hover)** */
button:hover:not(:disabled) {
    opacity: 0.8;
}

/* ✅ **ריווח תקין בין הכפתורים** */
.button-container button {
    margin: 0 5px;
}

/* ✅ **ספינר טעינה (אנימציה)** */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid black;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}

/* ✅ **התאמות מיוחדות לשדה "טלפון"** */
#newContactPhone {
    direction: rtl;
    text-align: right;
}

#newContactPhone::placeholder {
    text-align: right;
    direction: rtl;
}

/* ✅ **התאמות מיוחדות לשדה "דוא"ל"** */
#newContactEmail {
    direction: ltr;
    text-align: left;
    unicode-bidi: plaintext;
}

#newContactEmail::placeholder {
    direction: rtl;
    text-align: right;
}

/* ✅ **שדה "איש קשר" – שמירה על מבנה ברור** */
#contactPerson {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}


/*
body {
    font-family: Arial, sans-serif;
    direction: rtl;
    text-align: center;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

.form-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    width: 100%; /* ⬅️ עכשיו הטופס יתפוס את כל רוחב החלון 
    max-width: 820px; /* ⬅️ מבטיח שהתוכן לא יחרוג ממסכים קטנים 
    text-align: right;
    position: relative;
    margin: auto;
}

/* ✅ כל השדות ימלאו את כל רוחב הטופס 
.form-container input, 
.form-container select, 
.form-container textarea {
    width: 100%; /* כל השדות מתרחבים בהתאם לגודל הטופס 
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    appearance: none;
    background-color: white;
    cursor: pointer;
    box-sizing: border-box;
}

/* ✅ תיקון כיוון מחזיק המקום (Placeholder) של מספר הטלפון 
#newContactPhone {
    direction: rtl; /* מוודא שהכיוון הכללי הוא מימין לשמאל 
    text-align: right; /* מיישר את כל התוכן וגם את ה-Placeholder לימין 
}

#newContactPhone::placeholder {
    text-align: right; /* מוודא שה-placeholder גם מופיע בצד ימין 
    direction: rtl;
}

/* ✅ תיקון מחזיק המקום (Placeholder) של הדוא"ל 
#newContactEmail {
    direction: ltr;
    text-align: left;
    unicode-bidi: plaintext;
}

#newContactEmail::placeholder {
    direction: rtl; /* מבטיח שה-placeholder יוצמד לימין 
    text-align: right; /* מיישר את ה-placeholder לימין 
}

/* ✅ התאמה מיוחדת לשדה "איש קשר" כך שהוא יציג את כל הנתונים בצורה ברורה 
#contactPerson {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.loading-message {
    font-size: 16px;
    color: blue;
    text-align: center;
    margin-bottom: 10px;
    display: none;
}

.form-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-bottom: 10px;
    position: relative;
    width: 100%;
}


/* 🎡 אנימציה לספינר 
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 🎡 עיצוב הספינר 
.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid black;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}


label {
    font-weight: bold;
}

select {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="gray"><path d="M7 10l5 5 5-5z"/></svg>'); 
    background-repeat: no-repeat;
    background-position: left 10px center;
    background-size: 16px;
    padding-right: 30px;
}

.error-message {
    color: red;
    font-size: 12px;
    display: none;
    margin-top: 5px;
}

input[readonly] {
    background-color: #f0f0f0;
    cursor: not-allowed;
}

.autocomplete-suggestions {
    position: absolute;
    border: 1px solid #ccc;
    background: white;
    max-height: 150px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    top: 100%;
    right: 0;
    display: none;
    border-radius: 4px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

.autocomplete-suggestion {
    padding: 8px;
    cursor: pointer;
}

.autocomplete-suggestion.selected, .autocomplete-suggestion:hover {
    background: #f0f0f0;
}

button {
    margin-top: 15px;
    padding: 10px;
    font-size: 14px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    width: 48%;
}

#loadingMessage {
    position: fixed; /* קובע שהחיווי לא יזוז 
    top: 0; /* יוצמד לראש המסך 
    left: 0;
    width: 100%; /* כל הרוחב 
    background: rgba(255, 255, 0, 0.8); /* רקע צהוב כדי שיבלוט 
    color: black;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    padding: 10px;
    z-index: 1000; /* יבטיח שיופיע מעל הכל 
    display: none; /* יופיע רק כשצריך 
}


#submitButton {
    background-color: #4CAF50;
    color: white;
}

#submitButton:disabled {
    background-color: #cccccc;
}

#cancelButton {
    background-color: #f44336;
    color: white;
}

.button-container {
    display: flex;
    justify-content: space-between;
}
*/
  </style>

    <script>
        
        let existingCustomers = [];
        let existingProjects = [];
        let focusedField = null; // שדה אחרון שהפוקוס אמור לעבור אליו

document.addEventListener("DOMContentLoaded", function () {
  
    disableForm();

    // ✅ הכפתור מושבת מיד עם הטעינה
    let submitButton = document.getElementById("submitButton");
    submitButton.disabled = true;

    // ✅ טעינת רשימת הלקוחות
    google.script.run.withSuccessHandler(function(customers) {
        populateCustomerList(customers);
        enableForm();
             // ✅ הצבת פוקוס בשדה הראשון - "לקוח"
    let customerInput = document.getElementById("customerName");
    if (customerInput) {
        customerInput.focus();
        console.log("📌 הפוקוס הועבר לשדה 'לקוח' בעת טעינת הטופס.");
    } else {
        console.error("❌ שגיאה: אלמנט 'customerName' לא נמצא ב-DOM.");
    }
    }).getCustomersForProjectsForm();

    // ✅ מאזין לבחירת לקוח כדי להביא את רשימת הפרויקטים שלו
    document.getElementById("customerName").addEventListener("blur", function () {
        let customerID = document.getElementById("customerID").value.trim();
        if (customerID !== "") {
            console.log("📡 מבצע קריאה לפרויקטים של הלקוח:", customerID);
            google.script.run.withSuccessHandler(function(projects) {
                existingProjects = projects.map(p => p.toLowerCase()); // הפיכת הרשימה לאותיות קטנות להשוואה מדויקת
                console.log("✅ רשימת הפרויקטים נטענה:", existingProjects);
            }).getProjectsForCustomer(customerID);
        } else {
            console.warn("⚠️ אין מזהה לקוח - לא ניתן לטעון פרויקטים.");
        }
    });

        // ✅ קריאה לשדות אוטומטיים אחרי יציאה משדה הפרויקט
   let projectInput = document.getElementById("projectName").addEventListener("blur", function () {
    console.log("🟡 אירוע BLUR הופעל על projectInput!");

    setTimeout(() => {
        let projectName = this.value.trim();

        console.log("🔎 בודק תנאים לקריאה לשרת...");
        console.log("🔎 projectName:", projectName);
        console.log("🔎 data-duplicate:", this.getAttribute("data-duplicate"));

        if (projectName.length < 2) {  
            console.warn("⚠️ שם הפרויקט קצר מדי - לא מבצעים קריאה לשרת.");
            return;
        }

        if (this.getAttribute("data-duplicate") === "true") {
            console.warn("⛔ לא ניתן לשלוח נתונים לשרת - שם הפרויקט כבר קיים!");
            return;
        }

        console.log("✅ כל התנאים עברו, שולח קריאה לשרת...");

        // ✅ 🔹 השבתת הטופס והצגת חיווי למשתמש
        disableForm();
        let statusMessage = document.getElementById("loadingMessage");
        statusMessage.innerText = "⏳ טוען נתוני פרויקט...";
        statusMessage.style.display = "block";

        let customerID = document.getElementById("customerID").value;
        google.script.run.withSuccessHandler(function(data) {
            handleGeneratedFields(data);

            // ✅ 🔹 לאחר קבלת הנתונים – החזרת הטופס והסתרת החיווי
            enableForm();
            statusMessage.style.display = "none";

        }).getGeneratedFields("project", customerID);
        
    }, 150); // 🔹 עיכוב קל לוודא שהאירוע לא נחסם
});


    // ✅ מאזין לבחירת "איש קשר חדש" ומוסיף שדות דינאמית

    let contactSelect = document.getElementById("contactPerson");

    if (contactSelect) {
    contactSelect.addEventListener("change", function () {
        try {
            console.log("📌 שינוי בערך איש קשר:", this.value);

            // קריאה לפונקציה הקיימת שמוסיפה את השדות הדינאמיים
            toggleNewContactFields();

            // ✅ אם בוחרים להוסיף איש קשר חדש – נגלול לכפתור השליחה
            if (this.value === "new") {
                console.log("🔹 נוסף איש קשר חדש – גוללים לכפתור השליחה.");
                setTimeout(scrollToSubmitButton, 300); // גוללים אחרי 300ms כדי לאפשר לטופס להתארך
            }
        } catch (error) {
            console.error("❌ שגיאה בהאזנה לשדה 'איש קשר':", error);
        }
    });
  }

    // ✅ מאזין לכל שינוי בשדות כדי להפעיל/להשבית את כפתור השליחה
    document.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", validateForm);
    });
});

function disableForm() {
            document.getElementById("loadingMessage").style.display = "block";
            document.querySelectorAll("input, button").forEach(el => el.disabled = true);
            let submitButton = document.getElementById("submitButton");
            submitButton.disabled = true;
           // submitButton.style.backgroundColor = "#ccc"; // נוודא שהכפתור אפור
        }

        // ✅ נחזיר את הפוקוס **אחרי שהשרת יחזיר נתונים**
        function enableForm() {
        document.getElementById("loadingMessage").style.display = "none";
        document.querySelectorAll("input, button").forEach(el => el.disabled = false);

      // ✅ אם יש שדה שהוגדר לפוקוס - נחזיר אליו את הפוקוס
    // ✅ נחזיר את הפוקוס **רק עכשיו!**
        if (focusedField) {
        focusedField.focus();
        focusedField = null;
            }
      
            validateForm(); // ✅ בדיקה לאחר טעינת נתונים אוטומטיים
        }

      function handleGeneratedFields(data) {
      if (!data) {
        console.error("❌ שגיאה: נתוני הפרויקט לא התקבלו מהשרת.");
        return;
      }

      document.getElementById("creationDate").value = data.creationDate || "";
      document.getElementById("entryDate").value = data.entryDate || "";
      document.getElementById("projectID").value = data.projectID || "";

      console.log("✅ נתוני פרויקט נטענו בהצלחה:", data);

      // שלב 5: הפעלת הטופס רק אחרי שכל הנתונים נטענו
      enableForm();

      validateForm(); // ✅ בדיקה לאחר טעינת נתונים אוטומטיים

    }

     function populateCustomerList(customers) {
         if (!customers || customers.length === 0) {
             console.warn("⚠️ רשימת הלקוחות ריקה או לא תקינה.");
             enableForm();
             return;
      }

            customers.sort((a, b) => a.name.trim().localeCompare(b.name.trim(), 'he', { sensitivity: 'base' }));
            existingCustomers = customers;
            console.log("✅ רשימת הלקוחות נטענה ומוינה בסדר א-ב:", existingCustomers);

            enableForm();
            attachCustomerInputEvents();
        }

  function attachCustomerInputEvents() {
    let customerInput = document.getElementById("customerName");
    let projectInput = document.getElementById("projectName"); // ✅ הוספת ההגדרה למניעת שגיאה
    let suggestionsBox = document.getElementById("customerSuggestions");

    customerInput.addEventListener("focus", function () {
        showSuggestions(this.value.trim());
    });

    customerInput.addEventListener("input", function () {
        let value = this.value.trim();
        showSuggestions(value);
        hideError("customer"); // ✅ הסתרת הודעות שגיאה במקרה של שינוי
    });

    document.getElementById("customerName").addEventListener("keydown", function (event) {
    let selected = document.querySelector(".autocomplete-suggestion.selected");
    let suggestions = document.querySelectorAll(".autocomplete-suggestion");

    if (event.key === "ArrowDown") {
        event.preventDefault();
        if (selected) {
            let next = selected.nextElementSibling;
            if (next) {
                selected.classList.remove("selected");
                next.classList.add("selected");
                next.scrollIntoView({ block: "nearest" }); // ✅ גלילה אוטומטית
            }
        } else if (suggestions.length > 0) {
            suggestions[0].classList.add("selected");
            suggestions[0].scrollIntoView({ block: "nearest" }); // ✅ גלילה אוטומטית
        }
    } else if (event.key === "ArrowUp") {
        event.preventDefault();
        if (selected) {
            let prev = selected.previousElementSibling;
            if (prev) {
                selected.classList.remove("selected");
                prev.classList.add("selected");
                prev.scrollIntoView({ block: "nearest" }); // ✅ גלילה אוטומטית
            }
        }
    } else if (event.key === "Enter" || event.key === "Tab") {
        event.preventDefault();
        if (selected) {
            selectCustomer(selected.dataset.name, selected.dataset.id);
        }
    }
});

    customerInput.addEventListener("blur", function () {
        setTimeout(() => {
            let inputValue = customerInput.value.trim();
            let foundCustomer = existingCustomers.find(c => c.name === inputValue);
            if (!foundCustomer) {
                resetField(customerInput);
                displayError("customer", "⚠️ יש לבחור לקוח מהרשימה.");
            }
            suggestionsBox.style.display = "none";
        }, 200);
    });

    // ✅ בדיקה תוך כדי הקלדה בשדה "שם פרויקט"
    projectInput.addEventListener("input", function () {
        let value = this.value.trim();
        if (existingProjects.includes(value)) {
            displayError("project", "⚠️ שם הפרויקט כבר קיים! בחר שם אחר.");
        } else {
            hideError("project");
        }
    });
}
    
    function showSuggestions(filterText = "") {
    let suggestionsBox = document.getElementById("customerSuggestions");
    suggestionsBox.innerHTML = "";

    let filteredCustomers = existingCustomers.filter(customer =>
        customer.name.toLowerCase().includes(filterText.toLowerCase())
    );

    if (filteredCustomers.length === 0) {
        suggestionsBox.style.display = "none";
        return;
    }

    filteredCustomers.forEach((customer, index) => {
        let suggestion = document.createElement("div");
        suggestion.classList.add("autocomplete-suggestion");
        suggestion.textContent = customer.name;
        suggestion.dataset.name = customer.name;
        suggestion.dataset.id = customer.id;
        if (index === 0) {
            suggestion.classList.add("selected");
        }
        suggestion.onclick = function () {
            selectCustomer(customer.name, customer.id);
        };
        suggestionsBox.appendChild(suggestion);
    });

    suggestionsBox.style.display = "block";
}

// ✅ מניעת יציאה משדה עם כפילות, אבל קודם נותנים לדפדפן לבדוק
            function preventExitOnDuplicate(event, inputElement) {
                console.log(`🟡 בדיקת חסימת יציאה משדה: ${inputElement.id}, data-duplicate=${inputElement.getAttribute("data-duplicate")}`);

                // ✅ מאפשרים לדפדפן לבדוק תקינות קודם
                if (!inputElement.reportValidity()) {
                    console.warn(`⚠️ הדפדפן מזהה שהערך לא תקין - לא חוסמים יציאה משדה ${inputElement.id}.`);
                    return;
                }

                // ✅ חוסמים יציאה רק אם יש כפילות
                if (inputElement.getAttribute("data-duplicate") === "true") {
                    console.warn(`⛔ לא ניתן לצאת משדה ${inputElement.id} - יש כפילות!`);
                    event.preventDefault();
                    inputElement.focus();
                    console.log(`🔁 הפוקוס חזר לשדה: ${inputElement.id}`);
                }
            }


function selectCustomer(name, id) {
    let customerInput = document.getElementById("customerName");
    let customerIDInput = document.getElementById("customerID");

    customerInput.value = name;
    customerIDInput.value = id;

    hideError("customer");
    document.getElementById("customerSuggestions").style.display = "none";

    // ✅ השבתת הטופס בזמן שליפת הנתונים מהשרת
    disableForm();
    
    google.script.run.withSuccessHandler(function(data) {
        console.log("📡 נתוני לקוח שהתקבלו:", data);
        
        // ✅ נשלח את הנתונים לטיפול הכללי ב- handleCustomerData
        handleCustomerData(data);
        
        // // ✅ אוכלוס רשימת פרויקטים
        // existingProjects = data.projects || [];
        // console.log("✅ רשימת הפרויקטים נטענה:", existingProjects);

        // ✅ הוספת האזנות לשדה שם פרויקט **רק עכשיו לאחר טעינת הנתונים!**
        addProjectNameListeners();

        // ✅ קביעת פוקוס לשדה הבא הזמין
        moveToNextField(document.getElementById("customerName"));

    }).getCustomerData(id);
}

/**
 * מאזינה לשינויים בשדה "שם פרויקט" ומוודאת שאין כפילות.
 * 
 * 🚀 תהליך העבודה:
 * 1. מאזינה להקלדה בשדה "שם פרויקט" ומזהה אם השם כבר קיים ברשימת הפרויקטים של הלקוח.
 * 2. אם שם הפרויקט קיים → תוצג הודעת שגיאה, והשדה יסומן עם `data-duplicate="true"`.
 * 3. אם שם הפרויקט לא קיים → תוסר הודעת השגיאה, והשדה יסומן עם `data-duplicate="false"`.
 * 4. מאזינה לניסיון יציאה מהשדה (Tab או לחיצה מחוץ לשדה).
 *    - אם יש כפילות → מונעת יציאה ומחזירה את הפוקוס לשדה.
 *    - אם אין כפילות → מאפשרת מעבר לשדה הבא.
 */
function addProjectNameListeners() {
    try {
        let projectInput = document.getElementById("projectName");

        if (!projectInput) {
            console.error("❌ שגיאה: לא נמצא אלמנט בשם projectName!");
            return;
        }

        console.log("🔹 מאזינים נוספו לשדה 'שם פרויקט'.");

        // ✅ האזנה להקלדה בשדה הפרויקט
        projectInput.addEventListener("input", function () {
            let value = this.value.trim().toLowerCase(); // הבטחת השוואה אחידה

            if (existingProjects.length === 0) {
                console.warn("⚠️ רשימת הפרויקטים עדיין לא נטענה, לא ניתן לבדוק כפילות.");
                return;
            }

            if (existingProjects.includes(value)) {
                displayError("project", "⚠️ שם הפרויקט כבר קיים! בחר שם אחר.");
                projectInput.setAttribute("data-duplicate", "true"); // סימון השדה עם כפילות
                console.warn(`⚠️ שם הפרויקט "${this.value}" כבר קיים.`);
            } else {
                hideError("project");
                projectInput.setAttribute("data-duplicate", "false"); // אין כפילות
                console.log(`✅ שם הפרויקט "${this.value}" זמין.`);
            }
        });

        // ✅ מניעת יציאה משדה הפרויקט אם יש כפילות
        projectInput.addEventListener("keydown", function (event) {
            console.log(`🟡 מקש נלחץ בשדה 'שם פרויקט': ${event.key}`);
            if (event.key === "Tab" && projectInput.getAttribute("data-duplicate") === "true") {
                console.warn("⛔ לא ניתן לצאת משדה 'שם פרויקט' - יש כפילות!");
                event.preventDefault();
                projectInput.focus();
            }
        });

        projectInput.addEventListener("focusout", function (event) {
            console.log("🟡 focusout הופעל בשם פרויקט.");
            preventExitOnDuplicate(event, projectInput); // ✅ שימוש בפונקציה הכללית למניעת יציאה
        });

    } catch (error) {
        console.error("❌ שגיאה כללית בפונקציה addProjectNameListeners:", error);
    }
}



function moveToNextField(currentField) {
    let formElements = Array.from(document.querySelectorAll("input, select, button"));
    let currentIndex = formElements.indexOf(currentField);

    do {
        currentIndex++;
    } while (currentIndex < formElements.length && formElements[currentIndex].readOnly);

    if (currentIndex < formElements.length) {
        formElements[currentIndex].focus();
    }
}

// ✅ פונקציה שמחזירה את השדה הבא הפתוח להקלדה
function getNextField(currentField) {
    let formElements = Array.from(document.querySelectorAll("input:not([readonly]), select, button"));
    let currentIndex = formElements.indexOf(currentField);

    if (currentIndex >= 0 && currentIndex < formElements.length - 1) {
        return formElements[currentIndex + 1]; // מחזירה את השדה הבא
    }
    return null;
}

/**
 * 🚀 handleCustomerData - עדכון ממשק המשתמש עם נתוני לקוח שהתקבלו מהשרת.
 *
 * 📌 תהליך העבודה:
 * 1️⃣ בדיקה האם התקבלו נתונים תקינים.
 * 2️⃣ עדכון רשימת הפרויקטים של הלקוח.
 * 3️⃣ עדכון איש הקשר ברירת מחדל ואנשי הקשר לבחירה.
 * 4️⃣ עדכון שדות עמלה: מקבל עמלה, תאריך סיום ואחוז.
 * 5️⃣ הפעלת הטופס ופתיחת שדות נוספים.
 *
 * @param {Object} data - הנתונים שהתקבלו מהשרת עבור לקוח שנבחר.
 */
function handleCustomerData(data) {
    console.log("📥 התחלת הטיפול בנתוני לקוח שהתקבלו מהשרת...");
    console.log("📨 כל הנתונים שהתקבלו מהשרת:");
    console.log(JSON.stringify(data, null, 2));


    // 1️⃣ בדיקת תקינות הנתונים
    if (!data) {
        console.error("❌ שגיאה: לא התקבלו נתוני לקוח.");
        return;
    }

    // 2️⃣ עדכון רשימת הפרויקטים של הלקוח
    existingProjects = data.projects ? data.projects.map(p => p.projectName) : [];
    console.log("✅ רשימת הפרויקטים עודכנה:", existingProjects);

    // 3️⃣ טיפול באיש קשר ברירת מחדל ואנשי קשר
    let defaultContact = data.defaultContact || null;
    let contactsData = data.contacts || { contacts: [] };
    console.log("📇 איש קשר ברירת מחדל:", defaultContact);
    console.log("📇 אנשי קשר:", contactsData);
    populateContactDropdown(contactsData, defaultContact);

    // 4️⃣ עדכון שדות העמלה
    try {
        const recipientField = document.getElementById("commissionRecipient");
        const endDateField = document.getElementById("commissionEndDate");
        const rateField = document.getElementById("commissionRate");

        if (recipientField) {
            recipientField.value = data.commissionRecipient || "";
            console.log("✅ שדה 'מקבל עמלה' עודכן:", recipientField.value);
        } else {
            console.warn("⚠️ שדה 'commissionRecipient' לא נמצא ב-DOM.");
        }

        if (endDateField) {
            endDateField.value = data.commissionEndDate || "";
            console.log("✅ שדה 'תאריך סיום חובת עמלה' עודכן:", endDateField.value);
        } else {
            console.warn("⚠️ שדה 'commissionEndDate' לא נמצא ב-DOM.");
        }

         if (rateField) {
            const rate = parseFloat(data.commissionRate || 0);
            const today = new Date();
            const commissionEnd = parseDDMMYYYY(data.commissionEndDate);

            if (commissionEnd && commissionEnd < today) {
                rateField.value = 0;
                rateField.title = "⛔ תאריך סיום עמלה עבר";
                console.warn("⛔ תאריך סיום עמלה עבר – אחוז העמלה אופס ל-0.");
            } else {
                rateField.value = rate;
                console.log("✅ שדה 'אחוז עמלה' עודכן:", rate);
            }
        } else {
            console.warn("⚠️ שדה 'commissionRate' לא נמצא ב-DOM.");
        }


    } catch (error) {
        console.error("❌ שגיאה בעדכון שדות עמלה:", error);
    }

    // 5️⃣ הפעלת הטופס לאחר טעינה מלאה
    enableForm();
    console.log("✅ סיום הטיפול בנתוני לקוח.");
}


/**
 * 🧮 parseDDMMYYYY - ממירה מחרוזת תאריך בפורמט dd/mm/yyyy לאובייקט Date
 *
 * שלבים:
 * 1️⃣ פיצול המחרוזת לשלושה חלקים: יום, חודש, שנה.
 * 2️⃣ בניית מחרוזת תאריך סטנדרטית בפורמט yyyy-mm-dd.
 * 3️⃣ יצירת אובייקט Date מהתאריך המפורמט.
 *
 * @param {string} dateStr - מחרוזת תאריך בפורמט dd/mm/yyyy.
 * @returns {Date|null} - אובייקט תאריך תקני או null אם המחרוזת ריקה.
 */
function parseDDMMYYYY(dateStr) {
    try {
        console.log("🔍 התחלת המרת תאריך ממחרוזת לאובייקט Date:", dateStr);
        if (!dateStr) return null;

        const [day, month, year] = dateStr.split("/");
        const isoDateString = `${year}-${month}-${day}`;
        const parsedDate = new Date(isoDateString);

        console.log("📆 תאריך מומש כ- Date:", parsedDate.toISOString());
        return parsedDate;

    } catch (error) {
        console.error("❌ שגיאה בהמרת תאריך:", error);
        return null;
    }
}



function handleProjectsResponse(projects) {
    enableProjectInput(); // משחרר את שדה שם הפרויקט

    if (!projects || projects.length === 0) {
        console.warn("⚠️ אין פרויקטים ללקוח זה.");
        existingProjects = [];
        return;
    }

    console.log("✅ פרויקטים נטענו:", projects);
    existingProjects = projects;
}

function displayError(field, message) {
    let errorElement = document.getElementById(`${field}Error`);
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = "block";
    } else {
        console.warn(`⚠️ אלמנט השגיאה לא נמצא עבור השדה: ${field}`);
    }
}

function hideError(field) {
    let errorElement = document.getElementById(`${field}Error`);
    if (errorElement) {
        errorElement.textContent = "";
        errorElement.style.display = "none";
    }
}

function resetField(field) {
  field.value = "";
  showSuggestions("");
  field.focus();
}

/**
 * 🚀 validateForm - פונקציה לבדיקה אם כל תנאי הטופס מולאו כדי לאפשר שליחה.
 *
 * 🔍 תהליך העבודה:
 * 1️⃣ בודקת שכל השדות החיוניים מלאים (לפי הרשימה `requiredFields`).
 * 2️⃣ מוודאת ששדה "איש קשר" לא נשאר עם ערך ברירת מחדל.
 * 3️⃣ אם יש שדה חסר, תוצג הודעת שגיאה רלוונטית והשדה יסומן.
 * 4️⃣ אם כל הנתונים תקינים → כפתור השליחה יופעל ✅.
 * 5️⃣ אם יש חוסרים → כפתור השליחה יישאר מושבת ❌.
 *
 * 🛑 טיפול בשגיאות:
 * - אם אלמנט לא נמצא ב-DOM → תודפס שגיאה `console.error()`.
 * - כל שדה חסר → הודעת שגיאה תוצג עם `displayError()`.
 * - הודעות שגיאה ישנות מנוקות לפני הבדיקה כדי למנוע הצטברות שגיאות.
 */
function validateForm() {
    try {
        console.log("🔎 התחלת בדיקת הטופס...");

        // ✅ רשימת השדות החיוניים שצריכים להיות מלאים
        let requiredFields = [
            { id: "customerName", label: "שם לקוח" },
            { id: "customerID", label: "מזהה לקוח" },
            { id: "projectName", label: "שם פרויקט" },
            { id: "creationDate", label: "תאריך יצירה" },
            { id: "entryDate", label: "תאריך כניסה למערכת" },
            { id: "projectID", label: "מזהה פרויקט" }
        ];

        let submitButton = document.getElementById("submitButton");
        let contactPerson = document.getElementById("contactPerson"); // 📌 שדה "איש קשר"
        let allFieldsFilled = true;

        console.log("📜 בדיקה שכל השדות החיוניים מלאים...");

        // 🔹 ניקוי הודעות שגיאה ישנות
        requiredFields.forEach(field => hideError(field.id));
        hideError("contactPerson"); // מחיקת שגיאה ישנה גם משדה "איש קשר"

        // 🔹 בדיקה שכל השדות הרגילים מלאים
        for (let field of requiredFields) {
            let element = document.getElementById(field.id);
            if (!element) {
                console.error(`❌ שגיאה קריטית: האלמנט ${field.id} לא נמצא ב-DOM!`);
                continue; // ממשיכים לבדיקה הבאה
            }

            let value = element.value.trim();
            console.log(`🔹 בדיקת שדה "${field.label}":`, value);

            if (value === "") {
                allFieldsFilled = false;
                displayError(field.id, `⚠️ ${field.label} הוא שדה חובה!`);
                console.warn(`⚠️ השדה "${field.label}" ריק - טופס לא תקין.`);
            }
        }

        // 🔹 בדיקה מיוחדת לשדה "איש קשר"
        if (contactPerson) {
            let contactValue = contactPerson.value.trim();
            console.log(`🔹 בדיקת שדה "איש קשר":`, contactValue);

            if (contactValue === "" || contactValue === "בחר איש קשר...") {
                allFieldsFilled = false;
                displayError("contactPerson", "⚠️ יש לבחור איש קשר!");
                console.warn(`⚠️ איש קשר לא נבחר - טופס לא תקין.`);
            }
        } else {
            console.error("❌ שגיאה קריטית: אלמנט 'contactPerson' לא נמצא!");
        }

        // 🔹 הפעלת או השבתת כפתור השליחה
        if (allFieldsFilled) {
            submitButton.disabled = false;
            console.log("✅ כל השדות מלאים, כפתור 'אישור' הופעל.");
        } else {
            submitButton.disabled = true;
            console.warn("⚠️ חלק מהשדות חסרים או לא תקינים, כפתור 'אישור' נשאר מושבת.");
        }

        console.log("🔎 סיום בדיקת הטופס.");

    } catch (error) {
        console.error("❌ שגיאה כללית בפונקציה validateForm:", error);
    }
}

/**
 * 🚀 גולל אוטומטית לכפתור השליחה כאשר מוסיפים איש קשר חדש
 */
function scrollToSubmitButton() {
    try {
        let submitButton = document.getElementById("submitButton");
        if (!submitButton) {
            console.warn("⚠️ כפתור 'שלח' לא נמצא ב-DOM.");
            return;
        }

        console.log("📜 מבצע גלילה אוטומטית לכפתור השליחה.");
        submitButton.scrollIntoView({ behavior: "smooth", block: "center" });
    } catch (error) {
        console.error("❌ שגיאה בגלילה לכפתור השליחה:", error);
    }
}

// מאזין לשינוי בשדה "איש קשר"
document.getElementById("contactPerson").addEventListener("change", function () {
    try {
        console.log("📌 שינוי בערך איש קשר:", this.value);
        if (this.value === "new") {
            setTimeout(scrollToSubmitButton, 300); // גוללים אחרי 300ms כדי לאפשר לטופס להתארך
        }
    } catch (error) {
        console.error("❌ שגיאה בהאזנה לשדה 'איש קשר':", error);
    }
});

/**
 * 🚀 submitForm - שולח את נתוני הטופס לשרת ומתחיל את תהליך השמירה.
 *
 * 📌 תהליך העבודה:
 * 1️⃣ מבצע בדיקת תקינות ראשונית.
 * 2️⃣ משבית את כפתור השליחה כדי למנוע שליחה כפולה.
 * 3️⃣ מציג הודעת טעינה למשתמש.
 * 4️⃣ אוסף את הנתונים מהשדות בטופס, כולל שדות עמלה (גם אם ריקים).
 * 5️⃣ שולח את הנתונים לשרת באמצעות google.script.run.
 * 6️⃣ מטפל בתגובה מהשרת.
 */
function submitForm() {
    try {
        console.log("📩 התחלת שליחת הנתונים לשרת...");

        // 1️⃣ גלילה למעלה להצגת הודעת טעינה
        scrollToTop();

        let submitButton = document.getElementById("submitButton");
        let statusMessage = document.getElementById("loadingMessage");

        // 2️⃣ השבתת כפתור שליחה והצגת הודעת טעינה
        submitButton.disabled = true;
        statusMessage.innerText = "⏳ שולח נתונים... אנא המתן";
        statusMessage.style.display = "block";

        // 3️⃣ איסוף נתוני הטופס
        let formData = {
            creationDate: document.getElementById("creationDate").value.trim(),
            entryDate: document.getElementById("entryDate").value.trim(),
            projectID: document.getElementById("projectID").value.trim(),
            customerID: document.getElementById("customerID").value.trim(),
            customerName: document.getElementById("customerName").value.trim(),
            projectName: document.getElementById("projectName").value.trim(),
            contactPerson: document.getElementById("contactPerson").value.trim(),

            // 4️⃣ נתוני עמלה – מועברים גם אם ריקים
            commissionRecipient: document.getElementById("commissionRecipient").value.trim(),
            commissionRate: document.getElementById("commissionRate").value.trim(),
            commissionEndDate: document.getElementById("commissionEndDate").value.trim()
        };

        // 5️⃣ טיפול במקרה של איש קשר חדש
        if (formData.contactPerson === "new") {
            formData.newContact = {
                name: document.getElementById("newContactName").value.trim(),
                phone: document.getElementById("newContactPhone").value.trim(),
                email: document.getElementById("newContactEmail").value.trim()
            };
        }

        console.log("📊 שולח את הנתונים לשרת:", formData);

        // 6️⃣ שליחת הנתונים לשרת
        google.script.run
            .withSuccessHandler(formSubmissionSuccess)
            .withFailureHandler(formSubmissionFailure)
            .saveProjectData(formData);

    } catch (error) {
        console.error("❌ שגיאה כללית בפונקציה submitForm:", error);
        alert("❌ שגיאה כללית בשליחת הנתונים. נסה שוב.");

        // שיחזור מצב לאחר שגיאה
        document.getElementById("submitButton").disabled = false;
        document.getElementById("loadingMessage").style.display = "none";
    }
}




/**
 * 🚀 גולל אוטומטית לראש הדף כדי להציג את חיווי השליחה
 */
function scrollToTop() {
    try {
        console.log("📜 מבצע גלילה אוטומטית לראש הדף.");
        window.scrollTo({ top: 0, behavior: "smooth" });
    } catch (error) {
        console.error("❌ שגיאה בגלילה לראש הדף:", error);
    }
}

// מאזין ללחיצה על כפתור "שלח"
let submitButton = document.getElementById("submitButton");

if (submitButton) {
    submitButton.addEventListener("click", function () {
        try {
            console.log("📌 לחיצה על 'שלח' – מבצע גלילה למעלה.");
            scrollToTop();
        } catch (error) {
            console.error("❌ שגיאה בהאזנה ללחיצה על 'שלח':", error);
        }
    });
}

/**
 * 🚀 attachNewContactListeners - מוסיפה מאזינים לשדות של איש קשר חדש.
 *
 * 🔍 **מה הפונקציה עושה?**
 * 1️⃣ מאזין לשדה "שם איש קשר":
 *     ✅ מוודא שהוזנו לפחות **2 תווים באותיות עברית או אנגלית** (לא כולל רווחים בלבד).
 *     ✅ מאפשר **שמות עם רווחים** (למשל: "דוד לוי").
 *     ✅ אם הערך לא תקין, מוצגת הודעת שגיאה, והמשתמש לא יכול לעזוב את השדה.
 * 2️⃣ מאזין לשדות "טלפון" ו-"דוא"ל":
 *     ✅ קודם הדפדפן בודק שהשדה חוקי (`reportValidity()`).
 *     ✅ לאחר מכן, אם שני השדות ריקים – מחזירים את הפוקוס ולא מאפשרים יציאה.
 * 3️⃣ אם השדה תקין – מסתירים את הודעת השגיאה.
 */
function attachNewContactListeners() {
    try {
        console.log("🔹 attachNewContactListeners() הופעלה – הוספת מאזינים לשדות איש קשר חדש.");

        // ✅ שליפת השדות של איש קשר חדש
        let nameInput = document.getElementById("newContactName");
        let phoneInput = document.getElementById("newContactPhone");
        let emailInput = document.getElementById("newContactEmail");

        if (!nameInput || !phoneInput || !emailInput) {
            console.error("❌ שגיאה: אחד משדות איש הקשר החדש לא נמצא!");
            return;
        }

        console.log("✅ כל השדות נמצאו - מוסיפים מאזינים.");

        // ✅ מאזין יציאה לשם איש קשר – מוודא לפחות 2 תווים משמעותיים (אותיות בלבד, אבל מאפשר רווחים)
        nameInput.addEventListener("blur", function (event) {
            let value = this.value.trim();
            let regex = /^[\p{L}][\p{L} ]{1,}$/u; // ✅ לפחות 2 תווים משמעותיים, אך מאפשר רווחים בין מילים
            if (!regex.test(value)) {
                displayError("newContactName", "⚠️ יש להזין לפחות 2 אותיות בעברית או באנגלית (רווחים מותרים).");
                console.warn("⚠️ שם איש קשר לא עומד בדרישות.");
                event.preventDefault();
                this.focus();
            } else {
                hideError("newContactName");
                console.log("✅ שם איש קשר תקין.");
            }
        });

        // ✅ בדיקה אם לפחות אחד משדות "טלפון" או "דוא"ל" מולא
        function validateContactMethods(event) {
            let phoneValue = phoneInput.value.trim();
            let emailValue = emailInput.value.trim();

            // ✅ קודם ניתן לדפדפן לבדוק את השדה – אם הוא לא תקין, לא נבצע את הבדיקה שלנו.
            if (!event.target.reportValidity()) {
                console.warn(`⚠️ השדה '${event.target.id}' אינו תקין לפי בדיקת הדפדפן.`);
                return;
            }

            // ✅ אם שני השדות ריקים – מניעת יציאה
            if (phoneValue === "" && emailValue === "") {
                displayError("newContactPhone", "⚠️ חובה להזין טלפון או דוא\"ל!");
                displayError("newContactEmail", "⚠️ חובה להזין טלפון או דוא\"ל!");
                console.warn("⚠️ טלפון ודוא\"ל חסרים. לא ניתן לעזוב את השדה.");
                event.preventDefault();
                event.target.focus();
            } else {
                hideError("newContactPhone");
                hideError("newContactEmail");
                console.log("✅ לפחות אחד משדות טלפון/דוא\"ל מולא.");
            }
        }

        // ✅ מאזין יציאה (blur) לשדות טלפון ודוא"ל - לאחר שהדפדפן בדק תקינות
        phoneInput.addEventListener("blur", validateContactMethods);
        emailInput.addEventListener("blur", validateContactMethods);

        console.log("✅ מאזינים נוספו בהצלחה לשדות איש קשר חדש.");
    } catch (error) {
        console.error("❌ שגיאה כללית בפונקציה attachNewContactListeners:", error);
    }
}




/**
 * 🚀 addNewContactFields - פונקציה שיוצרת שדות דינאמיים להזנת איש קשר חדש.
 *
 * 🔍 **מה הפונקציה עושה?**
 * 1️⃣ מוסיפה שלושה שדות חדשים: "שם איש קשר", "טלפון" ו"דוא"ל".
 * 2️⃣ מוסיפה לכל שדה אזור שגיאה (שיציג הודעת שגיאה מתחתיו).
 * 3️⃣ קוראת ל-`attachNewContactListeners()` כדי להוסיף מאזינים לשדות החדשים.
 * 4️⃣ **שמה פוקוס אוטומטי על שדה "שם איש קשר" לאחר יצירת השדות.**
 */
function addNewContactFields() {
    let newContactFields = document.getElementById("newContactFields");

    // ✅ הוספת השדות רק אם הם עדיין לא קיימים
    if (!document.getElementById("newContactPhone")) {
        console.log("🔹 יצירת שדות חדשים לאיש קשר...");

        newContactFields.innerHTML = `
            <div class="form-group">
                <label>שם איש קשר:</label>
                <input type="text" id="newContactName" placeholder="הכנס שם איש קשר" required>
                <div id="newContactNameError" class="error-message" style="display: none;"></div>
            </div>
            <div class="form-group">
                <label>טלפון איש קשר:</label>
                <input type="tel" id="newContactPhone" placeholder="הכנס מספר טלפון" pattern="[0-9]{9,10}" >
                <div id="newContactPhoneError" class="error-message" style="display: none;"></div>
            </div>
            <div class="form-group">
                <label>דוא"ל איש קשר:</label>
                <input type="email" id="newContactEmail" placeholder="הכנס דוא&quot;ל" style="direction: rtl; text-align: left;">
                <div id="newContactEmailError" class="error-message" style="display: none;"></div>
            </div>
        `;

        console.log("✅ שדות חדשים לאיש קשר נוספו לטופס.");

        // ✅ הוספת מאזינים לשדות החדשים
        attachNewContactListeners();

        // ✅ הצבת פוקוס אוטומטי בשדה "שם איש קשר"
        let nameInput = document.getElementById("newContactName");
        if (nameInput) {
            nameInput.focus();
            console.log("📌 פוקוס הועבר לשדה 'שם איש קשר'.");
        } else {
            console.error("❌ שגיאה: לא נמצא שדה 'שם איש קשר' להצבת פוקוס.");
        }
    }
}

/**
 * מטפל בתגובה מהשרת לאחר שליחת הנתונים.
 * 
 * תהליך העבודה:
 * 1. בודק את התוצאה שהוחזרה מהשרת (`result`).
 * 2. אם התוצאה היא `"success"` - מציג הודעת הצלחה, ממתין 2 שניות, וסוגר את הטופס.
 * 3. אם התוצאה היא `"error"` - מציג הודעת שגיאה למשתמש ומפעיל מחדש את כפתור השליחה.
 *
 * @param {string} result - תוצאת הבקשה מהשרת ("success" או "error").
 */
function formSubmissionSuccess(result) {
    console.log("📩 קיבלנו תשובה מ-Google Apps Script:", result);

    let statusMessage = document.getElementById("loadingMessage");
    let submitButton = document.getElementById("submitButton");

    if (result === "success") {
        statusMessage.innerText = "✅ הנתונים נשמרו בהצלחה!";
        console.log("✅ הנתונים נשמרו בהצלחה בטבלה.");
        setTimeout(() => google.script.host.close(), 2000); // ⏳ סגירת הטופס אחרי 2 שניות
    } else {
        statusMessage.innerText = "❌ שגיאה בשמירת הנתונים, נסה שוב.";
        submitButton.disabled = false; // 🔄 הפעלת הכפתור מחדש
    }
}

/**
 * מאכלס את שדה הבחירה של איש קשר עם נתונים בפורמט "שם | טלפון | מייל"
 * 
 * @param {Array} contactsList - רשימת אנשי הקשר (מערך של אובייקטים עם שם, טלפון, דוא"ל)
 * @param {String} mainContact - איש קשר ברירת מחדל (אם קיים)
 */

function populateContactDropdown(contactsData, defaultContact) {
    let contactSelect = document.getElementById("contactPerson");

    console.log("📡 נתוני אנשי קשר שהתקבלו:", contactsData);
    console.log("📡 איש הקשר הדיפולטי (defaultContact):", defaultContact);

    let contactsList = contactsData.contacts || [];

    contactSelect.innerHTML = '<option value="">בחר איש קשר...</option>';

    let foundDefaultContact = false;

    console.log("📜 אנשי קשר מהרשימה:");
    contactsList.forEach(contact => console.log(`🔹 ${contact.name}`)); // הדפסת כל השמות מהרשימה

    contactsList.forEach(contact => {
        let name = contact.name.trim();
        let phone = contact.phone || "ללא טלפון";
        let email = contact.email || "ללא דוא\"ל";

        let option = document.createElement("option");
        option.value = name;
        option.textContent = `${name} | ${phone} |  \u200E${email}`;
        option.dataset.phone = phone;
        option.dataset.email = email;

        if (defaultContact && defaultContact.trim() === name) {
            option.selected = true;
            foundDefaultContact = true;
            console.log(`✅ איש הקשר הדיפולטי "${defaultContact}" נמצא ונבחר כברירת מחדל.`);
        }

        contactSelect.appendChild(option);
    });

    // ✅ אם איש הקשר הדיפולטי לא נמצא - נרשום אזהרה בלבד ולא נוסיף אותו
    if (defaultContact && !foundDefaultContact) {
        console.warn(`⚠️ שגיאה: איש הקשר הדיפולטי "${defaultContact}" לא נמצא ברשימה.`);
    }

    let addNewOption = document.createElement("option");
    addNewOption.value = "new";
    addNewOption.textContent = "➕ הוסף איש קשר חדש";
    contactSelect.appendChild(addNewOption);
}


/**
 * 🚀 toggleNewContactFields - פונקציה שמוסיפה או מסירה שדות דינאמיים להזנת איש קשר חדש.
 *
 * 🔍 **מה הפונקציה עושה?**
 * 1️⃣ אם המשתמש בוחר "➕ הוסף איש קשר חדש", קוראת ל-`addNewContactFields()`.
 * 2️⃣ אם המשתמש מחליף לאיש קשר קיים, מסירה את השדות הדינאמיים.
 */
function toggleNewContactFields() {
    console.log("🔹 הפעלת toggleNewContactFields() – טיפול בשדות איש קשר חדש.");

    let contactSelect = document.getElementById("contactPerson");
    let newContactFields = document.getElementById("newContactFields");

    if (contactSelect.value === "new") {
        console.log("📌 המשתמש בחר להוסיף איש קשר חדש – מוסיפים שדות.");
        addNewContactFields();
        newContactFields.style.display = "block";
    } else {
        console.log("📌 המשתמש חזר לבחירת איש קשר קיים – מסירים את השדות.");
        newContactFields.innerHTML = "";
        newContactFields.style.display = "none";
    }
}

/**
 * מבצע בדיקה אוטומטית למניעת כפילות של אנשי קשר בטופס.
 * 
 * תהליך העבודה:
 * 1. המשתמש מקליד טלפון או דוא"ל בשדה הדינאמי.
 * 2. נשלפת רשימת אנשי הקשר הקיימים מתוך ה-<select id="contactPerson">.
 * 3. אם נמצא איש קשר עם אותו טלפון / דוא"ל - מוצגת למשתמש הודעת אזהרה.
 * 4. אם אין כפילות - האזהרה מוסרת.
 */

function checkDuplicateContact() {
    console.log("🔍 בדיקת כפילות טלפון ודוא\"ל הופעלה!");

    let phoneInput = document.getElementById("newContactPhone");
    let emailInput = document.getElementById("newContactEmail");

    let phoneValue = phoneInput ? phoneInput.value.trim() : "";
    let emailValue = emailInput ? emailInput.value.trim() : "";

    let phoneError = document.getElementById("newContactPhoneError");
    let emailError = document.getElementById("newContactEmailError");

    // ניקוי הודעות קיימות
    phoneError.style.display = "none";
    emailError.style.display = "none";

    // שליפת אנשי הקשר הקיימים
    let existingContacts = Array.from(document.querySelectorAll("#contactPerson option"))
        .map(option => ({
            phone: option.dataset.phone ? option.dataset.phone.replace(/\D/g, "") : "",
            email: option.dataset.email ? option.dataset.email.replace(/\s+/g, "").replace(/\u200E/g, "").toLowerCase() : ""
        }))
        .filter(contact => contact.email || contact.phone);

    // ניקוי טלפון ודוא"ל מהמשתמש
    let cleanPhoneInput = phoneValue.replace(/\D/g, "");
    let cleanEmailInput = emailValue.replace(/\s+/g, "").replace(/\u200E/g, "").toLowerCase(); // ניקוי תווים לא רצויים

    console.log("📞 טלפון שנבדק:", cleanPhoneInput);
    console.log("📧 דוא\"ל שנבדק:", cleanEmailInput);

    // 🔹 בדיקת כפילות טלפון
    let isPhoneDuplicate = existingContacts.some(contact =>
        cleanPhoneInput && contact.phone === cleanPhoneInput
    );

    if (isPhoneDuplicate) {
        console.log("🚨 טלפון כפול נמצא!");
        phoneError.textContent = "⚠️ מספר טלפון זה כבר קיים!";
        phoneError.style.display = "block";
        phoneInput.setAttribute("data-duplicate", "true");
    } else {
        phoneInput.setAttribute("data-duplicate", "false");
    }
    console.log(`🔴 phoneInput data-duplicate לאחר עדכון: ${phoneInput.getAttribute("data-duplicate")}`);

    // 🔹 בדיקת כפילות דוא"ל
    let isEmailDuplicate = existingContacts.some(contact =>
        cleanEmailInput && contact.email === cleanEmailInput
    );

    if (isEmailDuplicate) {
        console.log("🚨 דוא\"ל כפול נמצא!");
        emailError.textContent = "⚠️ כתובת דוא\"ל זו כבר קיימת!";
        emailError.style.display = "block";
        emailInput.setAttribute("data-duplicate", "true");
    } else {
        emailInput.setAttribute("data-duplicate", "false");
    }
    console.log(`🔴 emailInput data-duplicate לאחר עדכון: ${emailInput.getAttribute("data-duplicate")}`);
}


/**
 * מטפל בכשל תקשורת עם השרת.
 * 
 * תהליך העבודה:
 * 1. מציג הודעת שגיאה למשתמש.
 * 2. מאפשר ניסיון חוזר על ידי הפעלת כפתור השליחה מחדש.
 *
 * @param {Object} error - הודעת השגיאה שחזרה מהשרת.
 */
function formSubmissionFailure(error) {
    console.error("❌ כשל בתקשורת עם השרת:", error);

    let statusMessage = document.getElementById("loadingMessage");
    let submitButton = document.getElementById("submitButton");

    statusMessage.innerText = "❌ שגיאה בתקשורת עם השרת. נסה שוב.";
    submitButton.disabled = false; // 🔄 הפעלת הכפתור מחדש כדי לאפשר ניסיון חוזר
}
    </script>
</head>

 <!-- ✅ תיבת הטופס הראשית -->
    <div class="form-container">
        <h2>פתיחת פרויקט חדש</h2>

        <!-- ✅ חיווי טעינה -->
        <div id="loadingMessage" class="loading-message">
            🔄 טוען נתונים... אנא המתן
            <span class="spinner"></span>
        </div>

        <!-- ✅ שדה בחירת לקוח -->
        <div class="form-group">
            <label>שם לקוח:</label>
            <input type="text" id="customerName" autocomplete="off">
            <div id="customerSuggestions" class="autocomplete-suggestions"></div>
            <div id="customerError" class="error-message"></div>
        </div>

        <!-- ✅ מזהה לקוח (לא ניתן לעריכה) -->
        <div class="form-group">
            <label>מזהה לקוח:</label>
            <input type="text" id="customerID" readonly>
        </div>
        <!-- ✅ מקבל עמלה (קריאה בלבד) -->
        <div class="form-group">
            <label>מקבל עמלה:</label>
            <input type="text" id="commissionRecipient" readonly>
        </div>

        <!-- ✅ תאריך סיום חובת עמלה (קריאה בלבד) -->
        <div class="form-group">
            <label>תאריך סיום חובת עמלה:</label>
            <input type="text" id="commissionEndDate" readonly>
        </div>

        <!-- ✅ אחוז עמלה (קריאה בלבד) -->
        <div class="form-group">
            <label>אחוז עמלה (%):</label>
            <input type="number" id="commissionRate" readonly>
        </div>

        <!-- ✅ בחירת איש קשר -->
        <div class="form-group">
            <label>איש קשר:</label>
            <select id="contactPerson">
                <option value="">בחר איש קשר...</option>
                <option value="new">➕ הוסף איש קשר חדש</option>
            </select>
            <div id="contactPersonError" class="error-message"></div>
        </div>

        <!-- ✅ שדות דינמיים להוספת איש קשר חדש -->
        <div id="newContactFields"></div>

        <!-- ✅ שדה "שם פרויקט" -->
        <div class="form-group">
            <label>שם פרויקט:</label>
            <input type="text" id="projectName" required>
            <div id="projectError" class="error-message"></div>
        </div>

        <!-- ✅ תאריך יצירה (לא ניתן לעריכה) -->
        <div class="form-group">
            <label>תאריך יצירה:</label>
            <input type="text" id="creationDate" readonly>
        </div>

        <!-- ✅ מזהה פרויקט (לא ניתן לעריכה) -->
        <div class="form-group">
            <label>מזהה פרויקט:</label>
            <input type="text" id="projectID" readonly>
        </div>

        <!-- ✅ תאריך כניסה למערכת (לא ניתן לעריכה) -->
        <div class="form-group">
            <label>תאריך כניסה למערכת:</label>
            <input type="text" id="entryDate" readonly>
        </div>

        <!-- ✅ כפתורי הטופס -->
        <div class="button-container">
            <button id="cancelButton" onclick="google.script.host.close()">ביטול</button>
            <button id="submitButton" type="button" disabled onclick="submitForm()">אישור</button>
        </div>
    </div>

