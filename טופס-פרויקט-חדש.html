<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>×˜×•×¤×¡ ×¤×ª×™×—×ª ×¤×¨×•×™×§×˜ ×—×“×©</title>
<style>
/* âœ… **×¡×’× ×•×Ÿ ×›×œ×œ×™ ×œ×›×œ ×”×¢××•×“** */
body {
    font-family: Arial, sans-serif;
    direction: rtl; /* ×¢×‘×¨×™×ª â€“ ××™××™×Ÿ ×œ×©×××œ */
    text-align: center;
    background-color: rgba(0, 0, 0, 0.5); /* ×¨×§×¢ ×›×”×” ×—×¦×™-×©×§×•×£ */
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

/* âœ… **×ª×™×‘×ª ×”×˜×•×¤×¡ ×”×¨××©×™×ª** */
.form-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 820px; /* ××‘×˜×™×— ×©×”×ª×•×›×Ÿ ×œ× ×™×—×¨×•×’ ×××¡×›×™× ×§×˜× ×™× */
    text-align: right;
    position: relative;
    margin: auto;
}

/* âœ… **×¢×™×¦×•×‘ ×›×œ×œ×™ ×œ×©×“×•×ª ×§×œ×˜, ×‘×—×™×¨×” ×•××–×•×¨×™× ×œ×”×§×œ×“×”** */
.form-container input,
.form-container select,
.form-container textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    appearance: none;
    background-color: white;
    cursor: pointer;
    box-sizing: border-box;
}

/* âœ… **×¡×’× ×•×Ÿ ×œ×›×•×ª×¨×•×ª ×©×œ ×©×“×•×ª ×‘×˜×•×¤×¡** */
label {
    font-weight: bold;
}

/* âœ… **×§×‘×•×¦×ª ×”×©×“×•×ª ×‘×˜×•×¤×¡** */
.form-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-bottom: 10px;
    position: relative;
    width: 100%;
}

/* âœ… **×©×“×•×ª ×§×¨×™××” ×‘×œ×‘×“ â€“ ×¨×§×¢ ××¤×•×¨ ×•××•× ×¢×™× ×¢×¨×™×›×”** */
input[readonly] {
    background-color: #f0f0f0;
    cursor: not-allowed;
}

/* âœ… **×©×’×™××•×ª ×‘×˜×•×¤×¡ â€“ ×ª×¦×•×’×” ×‘×¨×•×¨×”** */
.error-message {
    color: red;
    font-size: 12px;
    display: none;
    margin-top: 5px;
}

/* âœ… **×ª×™×‘×ª ×”×¦×¢×•×ª ××•×˜×•××˜×™×•×ª (autocomplete)** */
.autocomplete-suggestions {
    position: absolute;
    border: 1px solid #ccc;
    background: white;
    max-height: 150px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    top: 100%;
    right: 0;
    display: none;
    border-radius: 4px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

/* âœ… **×ª×¦×•×’×ª ×›×œ ×”×¦×¢×” ×‘×¨×©×™××” ×”× ×¤×ª×—×ª** */
.autocomplete-suggestion {
    padding: 8px;
    cursor: pointer;
}

/* âœ… **×©×™× ×•×™ ×¦×‘×¢ ×œ×¨×§×¢ ×‘×”×¦×¢×” ×©× ×‘×—×¨×” ××• ×©××¨×—×¤×™× ××¢×œ×™×”** */
.autocomplete-suggestion.selected,
.autocomplete-suggestion:hover {
    background: #f0f0f0;
}

/* âœ… **×¡×’× ×•×Ÿ ×ª×™×‘×•×ª ×‘×—×™×¨×” (SELECT) â€“ ××•×¡×™×£ ×—×¥ ×§×˜×Ÿ ××©×××œ** */
select {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="gray"><path d="M7 10l5 5 5-5z"/></svg>'); 
    background-repeat: no-repeat;
    background-position: left 10px center;
    background-size: 16px;
    padding-right: 30px;
}

/* âœ… **×—×™×•×•×™ ×˜×¢×™× ×” (×‘×”××ª× ×” ×œ× ×ª×•× ×™× ××”×©×¨×ª)** */
#loadingMessage {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: rgba(255, 255, 0, 0.8);
    color: black;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    padding: 10px;
    z-index: 1000;
    display: none;
}

/* âœ… **×›×¤×ª×•×¨×™× â€“ ×©×—×–×•×¨ ××œ× ×©×œ ×”×¦×•×¨×” ×”×§×•×“××ª** */
.button-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
}

/* âœ… **×›×œ ×”×›×¤×ª×•×¨×™× â€“ ×©×—×–×•×¨ ×”×¢×™×¦×•×‘ ×”××§×•×¨×™** */
button {
    padding: 12px 20px;
    font-size: 14px;
    font-weight: bold;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    width: auto; /* ×©×•××¨ ×¢×œ ×’××™×©×•×ª ×‘×¨×•×—×‘ */
    min-width: 120px; /* ××‘×˜×™×— ×©×”× ×œ× ×™×”×™×• ×§×˜× ×™× ××“×™ */
    transition: background-color 0.3s ease;
}

/* âœ… **×›×¤×ª×•×¨ "××™×©×•×¨" â€“ ×™×¨×•×§** */
#submitButton {
    background-color: #4CAF50;
    color: white;
}

/* âœ… **×›×¤×ª×•×¨ "××™×©×•×¨" ××•×©×‘×ª â€“ ××¤×•×¨ ×•×œ× ×œ×—×™×¥** */
#submitButton:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

/* âœ… **×›×¤×ª×•×¨ "×‘×™×˜×•×œ" â€“ ××“×•×** */
#cancelButton {
    background-color: #f44336;
    color: white;
}

/* âœ… **×× ×™××¦×™×” ×‘×¢×ª ××¢×‘×¨ ×¢×›×‘×¨ (hover)** */
button:hover:not(:disabled) {
    opacity: 0.8;
}

/* âœ… **×¨×™×•×•×— ×ª×§×™×Ÿ ×‘×™×Ÿ ×”×›×¤×ª×•×¨×™×** */
.button-container button {
    margin: 0 5px;
}

/* âœ… **×¡×¤×™× ×¨ ×˜×¢×™× ×” (×× ×™××¦×™×”)** */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid black;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}

/* âœ… **×”×ª×××•×ª ××™×•×—×“×•×ª ×œ×©×“×” "×˜×œ×¤×•×Ÿ"** */
#newContactPhone {
    direction: rtl;
    text-align: right;
}

#newContactPhone::placeholder {
    text-align: right;
    direction: rtl;
}

/* âœ… **×”×ª×××•×ª ××™×•×—×“×•×ª ×œ×©×“×” "×“×•×"×œ"** */
#newContactEmail {
    direction: ltr;
    text-align: left;
    unicode-bidi: plaintext;
}

#newContactEmail::placeholder {
    direction: rtl;
    text-align: right;
}

/* âœ… **×©×“×” "××™×© ×§×©×¨" â€“ ×©××™×¨×” ×¢×œ ××‘× ×” ×‘×¨×•×¨** */
#contactPerson {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}


/*
body {
    font-family: Arial, sans-serif;
    direction: rtl;
    text-align: center;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

.form-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    width: 100%; /* â¬…ï¸ ×¢×›×©×™×• ×”×˜×•×¤×¡ ×™×ª×¤×•×¡ ××ª ×›×œ ×¨×•×—×‘ ×”×—×œ×•×Ÿ 
    max-width: 820px; /* â¬…ï¸ ××‘×˜×™×— ×©×”×ª×•×›×Ÿ ×œ× ×™×—×¨×•×’ ×××¡×›×™× ×§×˜× ×™× 
    text-align: right;
    position: relative;
    margin: auto;
}

/* âœ… ×›×œ ×”×©×“×•×ª ×™××œ××• ××ª ×›×œ ×¨×•×—×‘ ×”×˜×•×¤×¡ 
.form-container input, 
.form-container select, 
.form-container textarea {
    width: 100%; /* ×›×œ ×”×©×“×•×ª ××ª×¨×—×‘×™× ×‘×”×ª×× ×œ×’×•×“×œ ×”×˜×•×¤×¡ 
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    appearance: none;
    background-color: white;
    cursor: pointer;
    box-sizing: border-box;
}

/* âœ… ×ª×™×§×•×Ÿ ×›×™×•×•×Ÿ ××—×–×™×§ ×”××§×•× (Placeholder) ×©×œ ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ 
#newContactPhone {
    direction: rtl; /* ××•×•×“× ×©×”×›×™×•×•×Ÿ ×”×›×œ×œ×™ ×”×•× ××™××™×Ÿ ×œ×©×××œ 
    text-align: right; /* ××™×™×©×¨ ××ª ×›×œ ×”×ª×•×›×Ÿ ×•×’× ××ª ×”-Placeholder ×œ×™××™×Ÿ 
}

#newContactPhone::placeholder {
    text-align: right; /* ××•×•×“× ×©×”-placeholder ×’× ××•×¤×™×¢ ×‘×¦×“ ×™××™×Ÿ 
    direction: rtl;
}

/* âœ… ×ª×™×§×•×Ÿ ××—×–×™×§ ×”××§×•× (Placeholder) ×©×œ ×”×“×•×"×œ 
#newContactEmail {
    direction: ltr;
    text-align: left;
    unicode-bidi: plaintext;
}

#newContactEmail::placeholder {
    direction: rtl; /* ××‘×˜×™×— ×©×”-placeholder ×™×•×¦××“ ×œ×™××™×Ÿ 
    text-align: right; /* ××™×™×©×¨ ××ª ×”-placeholder ×œ×™××™×Ÿ 
}

/* âœ… ×”×ª×××” ××™×•×—×“×ª ×œ×©×“×” "××™×© ×§×©×¨" ×›×š ×©×”×•× ×™×¦×™×’ ××ª ×›×œ ×”× ×ª×•× ×™× ×‘×¦×•×¨×” ×‘×¨×•×¨×” 
#contactPerson {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.loading-message {
    font-size: 16px;
    color: blue;
    text-align: center;
    margin-bottom: 10px;
    display: none;
}

.form-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-bottom: 10px;
    position: relative;
    width: 100%;
}


/* ğŸ¡ ×× ×™××¦×™×” ×œ×¡×¤×™× ×¨ 
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ğŸ¡ ×¢×™×¦×•×‘ ×”×¡×¤×™× ×¨ 
.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid black;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}


label {
    font-weight: bold;
}

select {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="gray"><path d="M7 10l5 5 5-5z"/></svg>'); 
    background-repeat: no-repeat;
    background-position: left 10px center;
    background-size: 16px;
    padding-right: 30px;
}

.error-message {
    color: red;
    font-size: 12px;
    display: none;
    margin-top: 5px;
}

input[readonly] {
    background-color: #f0f0f0;
    cursor: not-allowed;
}

.autocomplete-suggestions {
    position: absolute;
    border: 1px solid #ccc;
    background: white;
    max-height: 150px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    top: 100%;
    right: 0;
    display: none;
    border-radius: 4px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

.autocomplete-suggestion {
    padding: 8px;
    cursor: pointer;
}

.autocomplete-suggestion.selected, .autocomplete-suggestion:hover {
    background: #f0f0f0;
}

button {
    margin-top: 15px;
    padding: 10px;
    font-size: 14px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    width: 48%;
}

#loadingMessage {
    position: fixed; /* ×§×•×‘×¢ ×©×”×—×™×•×•×™ ×œ× ×™×–×•×– 
    top: 0; /* ×™×•×¦××“ ×œ×¨××© ×”××¡×š 
    left: 0;
    width: 100%; /* ×›×œ ×”×¨×•×—×‘ 
    background: rgba(255, 255, 0, 0.8); /* ×¨×§×¢ ×¦×”×•×‘ ×›×“×™ ×©×™×‘×œ×•×˜ 
    color: black;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    padding: 10px;
    z-index: 1000; /* ×™×‘×˜×™×— ×©×™×•×¤×™×¢ ××¢×œ ×”×›×œ 
    display: none; /* ×™×•×¤×™×¢ ×¨×§ ×›×©×¦×¨×™×š 
}


#submitButton {
    background-color: #4CAF50;
    color: white;
}

#submitButton:disabled {
    background-color: #cccccc;
}

#cancelButton {
    background-color: #f44336;
    color: white;
}

.button-container {
    display: flex;
    justify-content: space-between;
}
*/
  </style>

    <script>
        
        let existingCustomers = [];
        let existingProjects = [];
        let focusedField = null; // ×©×“×” ××—×¨×•×Ÿ ×©×”×¤×•×§×•×¡ ×××•×¨ ×œ×¢×‘×•×¨ ××œ×™×•

document.addEventListener("DOMContentLoaded", function () {
  
    disableForm();

    // âœ… ×”×›×¤×ª×•×¨ ××•×©×‘×ª ××™×“ ×¢× ×”×˜×¢×™× ×”
    let submitButton = document.getElementById("submitButton");
    submitButton.disabled = true;

    // âœ… ×˜×¢×™× ×ª ×¨×©×™××ª ×”×œ×§×•×—×•×ª
    google.script.run.withSuccessHandler(function(customers) {
        populateCustomerList(customers);
        enableForm();
             // âœ… ×”×¦×‘×ª ×¤×•×§×•×¡ ×‘×©×“×” ×”×¨××©×•×Ÿ - "×œ×§×•×—"
    let customerInput = document.getElementById("customerName");
    if (customerInput) {
        customerInput.focus();
        console.log("ğŸ“Œ ×”×¤×•×§×•×¡ ×”×•×¢×‘×¨ ×œ×©×“×” '×œ×§×•×—' ×‘×¢×ª ×˜×¢×™× ×ª ×”×˜×•×¤×¡.");
    } else {
        console.error("âŒ ×©×’×™××”: ××œ×× ×˜ 'customerName' ×œ× × ××¦× ×‘-DOM.");
    }
    }).getCustomersForProjectsForm();

    // âœ… ×××–×™×Ÿ ×œ×‘×—×™×¨×ª ×œ×§×•×— ×›×“×™ ×œ×”×‘×™× ××ª ×¨×©×™××ª ×”×¤×¨×•×™×§×˜×™× ×©×œ×•
    document.getElementById("customerName").addEventListener("blur", function () {
        let customerID = document.getElementById("customerID").value.trim();
        if (customerID !== "") {
            console.log("ğŸ“¡ ××‘×¦×¢ ×§×¨×™××” ×œ×¤×¨×•×™×§×˜×™× ×©×œ ×”×œ×§×•×—:", customerID);
            google.script.run.withSuccessHandler(function(projects) {
                existingProjects = projects.map(p => p.toLowerCase()); // ×”×¤×™×›×ª ×”×¨×©×™××” ×œ××•×ª×™×•×ª ×§×˜× ×•×ª ×œ×”×©×•×•××” ××“×•×™×§×ª
                console.log("âœ… ×¨×©×™××ª ×”×¤×¨×•×™×§×˜×™× × ×˜×¢× ×”:", existingProjects);
            }).getProjectsForCustomer(customerID);
        } else {
            console.warn("âš ï¸ ××™×Ÿ ××–×”×” ×œ×§×•×— - ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¤×¨×•×™×§×˜×™×.");
        }
    });

        // âœ… ×§×¨×™××” ×œ×©×“×•×ª ××•×˜×•××˜×™×™× ××—×¨×™ ×™×¦×™××” ××©×“×” ×”×¤×¨×•×™×§×˜
   let projectInput = document.getElementById("projectName").addEventListener("blur", function () {
    console.log("ğŸŸ¡ ××™×¨×•×¢ BLUR ×”×•×¤×¢×œ ×¢×œ projectInput!");

    setTimeout(() => {
        let projectName = this.value.trim();

        console.log("ğŸ” ×‘×•×“×§ ×ª× ××™× ×œ×§×¨×™××” ×œ×©×¨×ª...");
        console.log("ğŸ” projectName:", projectName);
        console.log("ğŸ” data-duplicate:", this.getAttribute("data-duplicate"));

        if (projectName.length < 2) {  
            console.warn("âš ï¸ ×©× ×”×¤×¨×•×™×§×˜ ×§×¦×¨ ××“×™ - ×œ× ××‘×¦×¢×™× ×§×¨×™××” ×œ×©×¨×ª.");
            return;
        }

        if (this.getAttribute("data-duplicate") === "true") {
            console.warn("â›” ×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— × ×ª×•× ×™× ×œ×©×¨×ª - ×©× ×”×¤×¨×•×™×§×˜ ×›×‘×¨ ×§×™×™×!");
            return;
        }

        console.log("âœ… ×›×œ ×”×ª× ××™× ×¢×‘×¨×•, ×©×•×œ×— ×§×¨×™××” ×œ×©×¨×ª...");

        // âœ… ğŸ”¹ ×”×©×‘×ª×ª ×”×˜×•×¤×¡ ×•×”×¦×’×ª ×—×™×•×•×™ ×œ××©×ª××©
        disableForm();
        let statusMessage = document.getElementById("loadingMessage");
        statusMessage.innerText = "â³ ×˜×•×¢×Ÿ × ×ª×•× ×™ ×¤×¨×•×™×§×˜...";
        statusMessage.style.display = "block";

        let customerID = document.getElementById("customerID").value;
        google.script.run.withSuccessHandler(function(data) {
            handleGeneratedFields(data);

            // âœ… ğŸ”¹ ×œ××—×¨ ×§×‘×œ×ª ×”× ×ª×•× ×™× â€“ ×”×—×–×¨×ª ×”×˜×•×¤×¡ ×•×”×¡×ª×¨×ª ×”×—×™×•×•×™
            enableForm();
            statusMessage.style.display = "none";

        }).getGeneratedFields("project", customerID);
        
    }, 150); // ğŸ”¹ ×¢×™×›×•×‘ ×§×œ ×œ×•×•×“× ×©×”××™×¨×•×¢ ×œ× × ×—×¡×
});


    // âœ… ×××–×™×Ÿ ×œ×‘×—×™×¨×ª "××™×© ×§×©×¨ ×—×“×©" ×•××•×¡×™×£ ×©×“×•×ª ×“×™× ×××™×ª

    let contactSelect = document.getElementById("contactPerson");

    if (contactSelect) {
    contactSelect.addEventListener("change", function () {
        try {
            console.log("ğŸ“Œ ×©×™× ×•×™ ×‘×¢×¨×š ××™×© ×§×©×¨:", this.value);

            // ×§×¨×™××” ×œ×¤×•× ×§×¦×™×” ×”×§×™×™××ª ×©××•×¡×™×¤×” ××ª ×”×©×“×•×ª ×”×“×™× ×××™×™×
            toggleNewContactFields();

            // âœ… ×× ×‘×•×—×¨×™× ×œ×”×•×¡×™×£ ××™×© ×§×©×¨ ×—×“×© â€“ × ×’×œ×•×œ ×œ×›×¤×ª×•×¨ ×”×©×œ×™×—×”
            if (this.value === "new") {
                console.log("ğŸ”¹ × ×•×¡×£ ××™×© ×§×©×¨ ×—×“×© â€“ ×’×•×œ×œ×™× ×œ×›×¤×ª×•×¨ ×”×©×œ×™×—×”.");
                setTimeout(scrollToSubmitButton, 300); // ×’×•×œ×œ×™× ××—×¨×™ 300ms ×›×“×™ ×œ××¤×©×¨ ×œ×˜×•×¤×¡ ×œ×”×ª××¨×š
            }
        } catch (error) {
            console.error("âŒ ×©×’×™××” ×‘×”××–× ×” ×œ×©×“×” '××™×© ×§×©×¨':", error);
        }
    });
  }

    // âœ… ×××–×™×Ÿ ×œ×›×œ ×©×™× ×•×™ ×‘×©×“×•×ª ×›×“×™ ×œ×”×¤×¢×™×œ/×œ×”×©×‘×™×ª ××ª ×›×¤×ª×•×¨ ×”×©×œ×™×—×”
    document.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", validateForm);
    });
});

function disableForm() {
            document.getElementById("loadingMessage").style.display = "block";
            document.querySelectorAll("input, button").forEach(el => el.disabled = true);
            let submitButton = document.getElementById("submitButton");
            submitButton.disabled = true;
           // submitButton.style.backgroundColor = "#ccc"; // × ×•×•×“× ×©×”×›×¤×ª×•×¨ ××¤×•×¨
        }

        // âœ… × ×—×–×™×¨ ××ª ×”×¤×•×§×•×¡ **××—×¨×™ ×©×”×©×¨×ª ×™×—×–×™×¨ × ×ª×•× ×™×**
        function enableForm() {
        document.getElementById("loadingMessage").style.display = "none";
        document.querySelectorAll("input, button").forEach(el => el.disabled = false);

      // âœ… ×× ×™×© ×©×“×” ×©×”×•×’×“×¨ ×œ×¤×•×§×•×¡ - × ×—×–×™×¨ ××œ×™×• ××ª ×”×¤×•×§×•×¡
    // âœ… × ×—×–×™×¨ ××ª ×”×¤×•×§×•×¡ **×¨×§ ×¢×›×©×™×•!**
        if (focusedField) {
        focusedField.focus();
        focusedField = null;
            }
      
            validateForm(); // âœ… ×‘×“×™×§×” ×œ××—×¨ ×˜×¢×™× ×ª × ×ª×•× ×™× ××•×˜×•××˜×™×™×
        }

      function handleGeneratedFields(data) {
      if (!data) {
        console.error("âŒ ×©×’×™××”: × ×ª×•× ×™ ×”×¤×¨×•×™×§×˜ ×œ× ×”×ª×§×‘×œ×• ××”×©×¨×ª.");
        return;
      }

      document.getElementById("creationDate").value = data.creationDate || "";
      document.getElementById("entryDate").value = data.entryDate || "";
      document.getElementById("projectID").value = data.projectID || "";

      console.log("âœ… × ×ª×•× ×™ ×¤×¨×•×™×§×˜ × ×˜×¢× ×• ×‘×”×¦×œ×—×”:", data);

      // ×©×œ×‘ 5: ×”×¤×¢×œ×ª ×”×˜×•×¤×¡ ×¨×§ ××—×¨×™ ×©×›×œ ×”× ×ª×•× ×™× × ×˜×¢× ×•
      enableForm();

      validateForm(); // âœ… ×‘×“×™×§×” ×œ××—×¨ ×˜×¢×™× ×ª × ×ª×•× ×™× ××•×˜×•××˜×™×™×

    }

     function populateCustomerList(customers) {
         if (!customers || customers.length === 0) {
             console.warn("âš ï¸ ×¨×©×™××ª ×”×œ×§×•×—×•×ª ×¨×™×§×” ××• ×œ× ×ª×§×™× ×”.");
             enableForm();
             return;
      }

            customers.sort((a, b) => a.name.trim().localeCompare(b.name.trim(), 'he', { sensitivity: 'base' }));
            existingCustomers = customers;
            console.log("âœ… ×¨×©×™××ª ×”×œ×§×•×—×•×ª × ×˜×¢× ×” ×•××•×™× ×” ×‘×¡×“×¨ ×-×‘:", existingCustomers);

            enableForm();
            attachCustomerInputEvents();
        }

  function attachCustomerInputEvents() {
    let customerInput = document.getElementById("customerName");
    let projectInput = document.getElementById("projectName"); // âœ… ×”×•×¡×¤×ª ×”×”×’×“×¨×” ×œ×× ×™×¢×ª ×©×’×™××”
    let suggestionsBox = document.getElementById("customerSuggestions");

    customerInput.addEventListener("focus", function () {
        showSuggestions(this.value.trim());
    });

    customerInput.addEventListener("input", function () {
        let value = this.value.trim();
        showSuggestions(value);
        hideError("customer"); // âœ… ×”×¡×ª×¨×ª ×”×•×“×¢×•×ª ×©×’×™××” ×‘××§×¨×” ×©×œ ×©×™× ×•×™
    });

    document.getElementById("customerName").addEventListener("keydown", function (event) {
    let selected = document.querySelector(".autocomplete-suggestion.selected");
    let suggestions = document.querySelectorAll(".autocomplete-suggestion");

    if (event.key === "ArrowDown") {
        event.preventDefault();
        if (selected) {
            let next = selected.nextElementSibling;
            if (next) {
                selected.classList.remove("selected");
                next.classList.add("selected");
                next.scrollIntoView({ block: "nearest" }); // âœ… ×’×œ×™×œ×” ××•×˜×•××˜×™×ª
            }
        } else if (suggestions.length > 0) {
            suggestions[0].classList.add("selected");
            suggestions[0].scrollIntoView({ block: "nearest" }); // âœ… ×’×œ×™×œ×” ××•×˜×•××˜×™×ª
        }
    } else if (event.key === "ArrowUp") {
        event.preventDefault();
        if (selected) {
            let prev = selected.previousElementSibling;
            if (prev) {
                selected.classList.remove("selected");
                prev.classList.add("selected");
                prev.scrollIntoView({ block: "nearest" }); // âœ… ×’×œ×™×œ×” ××•×˜×•××˜×™×ª
            }
        }
    } else if (event.key === "Enter" || event.key === "Tab") {
        event.preventDefault();
        if (selected) {
            selectCustomer(selected.dataset.name, selected.dataset.id);
        }
    }
});

    customerInput.addEventListener("blur", function () {
        setTimeout(() => {
            let inputValue = customerInput.value.trim();
            let foundCustomer = existingCustomers.find(c => c.name === inputValue);
            if (!foundCustomer) {
                resetField(customerInput);
                displayError("customer", "âš ï¸ ×™×© ×œ×‘×—×•×¨ ×œ×§×•×— ××”×¨×©×™××”.");
            }
            suggestionsBox.style.display = "none";
        }, 200);
    });

    // âœ… ×‘×“×™×§×” ×ª×•×š ×›×“×™ ×”×§×œ×“×” ×‘×©×“×” "×©× ×¤×¨×•×™×§×˜"
    projectInput.addEventListener("input", function () {
        let value = this.value.trim();
        if (existingProjects.includes(value)) {
            displayError("project", "âš ï¸ ×©× ×”×¤×¨×•×™×§×˜ ×›×‘×¨ ×§×™×™×! ×‘×—×¨ ×©× ××—×¨.");
        } else {
            hideError("project");
        }
    });
}
    
    function showSuggestions(filterText = "") {
    let suggestionsBox = document.getElementById("customerSuggestions");
    suggestionsBox.innerHTML = "";

    let filteredCustomers = existingCustomers.filter(customer =>
        customer.name.toLowerCase().includes(filterText.toLowerCase())
    );

    if (filteredCustomers.length === 0) {
        suggestionsBox.style.display = "none";
        return;
    }

    filteredCustomers.forEach((customer, index) => {
        let suggestion = document.createElement("div");
        suggestion.classList.add("autocomplete-suggestion");
        suggestion.textContent = customer.name;
        suggestion.dataset.name = customer.name;
        suggestion.dataset.id = customer.id;
        if (index === 0) {
            suggestion.classList.add("selected");
        }
        suggestion.onclick = function () {
            selectCustomer(customer.name, customer.id);
        };
        suggestionsBox.appendChild(suggestion);
    });

    suggestionsBox.style.display = "block";
}

// âœ… ×× ×™×¢×ª ×™×¦×™××” ××©×“×” ×¢× ×›×¤×™×œ×•×ª, ××‘×œ ×§×•×“× × ×•×ª× ×™× ×œ×“×¤×“×¤×Ÿ ×œ×‘×“×•×§
            function preventExitOnDuplicate(event, inputElement) {
                console.log(`ğŸŸ¡ ×‘×“×™×§×ª ×—×¡×™××ª ×™×¦×™××” ××©×“×”: ${inputElement.id}, data-duplicate=${inputElement.getAttribute("data-duplicate")}`);

                // âœ… ×××¤×©×¨×™× ×œ×“×¤×“×¤×Ÿ ×œ×‘×“×•×§ ×ª×§×™× ×•×ª ×§×•×“×
                if (!inputElement.reportValidity()) {
                    console.warn(`âš ï¸ ×”×“×¤×“×¤×Ÿ ××–×”×” ×©×”×¢×¨×š ×œ× ×ª×§×™×Ÿ - ×œ× ×—×•×¡××™× ×™×¦×™××” ××©×“×” ${inputElement.id}.`);
                    return;
                }

                // âœ… ×—×•×¡××™× ×™×¦×™××” ×¨×§ ×× ×™×© ×›×¤×™×œ×•×ª
                if (inputElement.getAttribute("data-duplicate") === "true") {
                    console.warn(`â›” ×œ× × ×™×ª×Ÿ ×œ×¦××ª ××©×“×” ${inputElement.id} - ×™×© ×›×¤×™×œ×•×ª!`);
                    event.preventDefault();
                    inputElement.focus();
                    console.log(`ğŸ” ×”×¤×•×§×•×¡ ×—×–×¨ ×œ×©×“×”: ${inputElement.id}`);
                }
            }


function selectCustomer(name, id) {
    let customerInput = document.getElementById("customerName");
    let customerIDInput = document.getElementById("customerID");

    customerInput.value = name;
    customerIDInput.value = id;

    hideError("customer");
    document.getElementById("customerSuggestions").style.display = "none";

    // âœ… ×”×©×‘×ª×ª ×”×˜×•×¤×¡ ×‘×–××Ÿ ×©×œ×™×¤×ª ×”× ×ª×•× ×™× ××”×©×¨×ª
    disableForm();
    
    google.script.run.withSuccessHandler(function(data) {
        console.log("ğŸ“¡ × ×ª×•× ×™ ×œ×§×•×— ×©×”×ª×§×‘×œ×•:", data);
        
        // âœ… × ×©×œ×— ××ª ×”× ×ª×•× ×™× ×œ×˜×™×¤×•×œ ×”×›×œ×œ×™ ×‘- handleCustomerData
        handleCustomerData(data);
        
        // // âœ… ××•×›×œ×•×¡ ×¨×©×™××ª ×¤×¨×•×™×§×˜×™×
        // existingProjects = data.projects || [];
        // console.log("âœ… ×¨×©×™××ª ×”×¤×¨×•×™×§×˜×™× × ×˜×¢× ×”:", existingProjects);

        // âœ… ×”×•×¡×¤×ª ×”××–× ×•×ª ×œ×©×“×” ×©× ×¤×¨×•×™×§×˜ **×¨×§ ×¢×›×©×™×• ×œ××—×¨ ×˜×¢×™× ×ª ×”× ×ª×•× ×™×!**
        addProjectNameListeners();

        // âœ… ×§×‘×™×¢×ª ×¤×•×§×•×¡ ×œ×©×“×” ×”×‘× ×”×–××™×Ÿ
        moveToNextField(document.getElementById("customerName"));

    }).getCustomerData(id);
}

/**
 * ×××–×™× ×” ×œ×©×™× ×•×™×™× ×‘×©×“×” "×©× ×¤×¨×•×™×§×˜" ×•××•×•×“××ª ×©××™×Ÿ ×›×¤×™×œ×•×ª.
 * 
 * ğŸš€ ×ª×”×œ×™×š ×”×¢×‘×•×“×”:
 * 1. ×××–×™× ×” ×œ×”×§×œ×“×” ×‘×©×“×” "×©× ×¤×¨×•×™×§×˜" ×•××–×”×” ×× ×”×©× ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××ª ×”×¤×¨×•×™×§×˜×™× ×©×œ ×”×œ×§×•×—.
 * 2. ×× ×©× ×”×¤×¨×•×™×§×˜ ×§×™×™× â†’ ×ª×•×¦×’ ×”×•×“×¢×ª ×©×’×™××”, ×•×”×©×“×” ×™×¡×•××Ÿ ×¢× `data-duplicate="true"`.
 * 3. ×× ×©× ×”×¤×¨×•×™×§×˜ ×œ× ×§×™×™× â†’ ×ª×•×¡×¨ ×”×•×“×¢×ª ×”×©×’×™××”, ×•×”×©×“×” ×™×¡×•××Ÿ ×¢× `data-duplicate="false"`.
 * 4. ×××–×™× ×” ×œ× ×™×¡×™×•×Ÿ ×™×¦×™××” ××”×©×“×” (Tab ××• ×œ×—×™×¦×” ××—×•×¥ ×œ×©×“×”).
 *    - ×× ×™×© ×›×¤×™×œ×•×ª â†’ ××•× ×¢×ª ×™×¦×™××” ×•××—×–×™×¨×” ××ª ×”×¤×•×§×•×¡ ×œ×©×“×”.
 *    - ×× ××™×Ÿ ×›×¤×™×œ×•×ª â†’ ×××¤×©×¨×ª ××¢×‘×¨ ×œ×©×“×” ×”×‘×.
 */
function addProjectNameListeners() {
    try {
        let projectInput = document.getElementById("projectName");

        if (!projectInput) {
            console.error("âŒ ×©×’×™××”: ×œ× × ××¦× ××œ×× ×˜ ×‘×©× projectName!");
            return;
        }

        console.log("ğŸ”¹ ×××–×™× ×™× × ×•×¡×¤×• ×œ×©×“×” '×©× ×¤×¨×•×™×§×˜'.");

        // âœ… ×”××–× ×” ×œ×”×§×œ×“×” ×‘×©×“×” ×”×¤×¨×•×™×§×˜
        projectInput.addEventListener("input", function () {
            let value = this.value.trim().toLowerCase(); // ×”×‘×˜×—×ª ×”×©×•×•××” ××—×™×“×”

            if (existingProjects.length === 0) {
                console.warn("âš ï¸ ×¨×©×™××ª ×”×¤×¨×•×™×§×˜×™× ×¢×“×™×™×Ÿ ×œ× × ×˜×¢× ×”, ×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ×›×¤×™×œ×•×ª.");
                return;
            }

            if (existingProjects.includes(value)) {
                displayError("project", "âš ï¸ ×©× ×”×¤×¨×•×™×§×˜ ×›×‘×¨ ×§×™×™×! ×‘×—×¨ ×©× ××—×¨.");
                projectInput.setAttribute("data-duplicate", "true"); // ×¡×™××•×Ÿ ×”×©×“×” ×¢× ×›×¤×™×œ×•×ª
                console.warn(`âš ï¸ ×©× ×”×¤×¨×•×™×§×˜ "${this.value}" ×›×‘×¨ ×§×™×™×.`);
            } else {
                hideError("project");
                projectInput.setAttribute("data-duplicate", "false"); // ××™×Ÿ ×›×¤×™×œ×•×ª
                console.log(`âœ… ×©× ×”×¤×¨×•×™×§×˜ "${this.value}" ×–××™×Ÿ.`);
            }
        });

        // âœ… ×× ×™×¢×ª ×™×¦×™××” ××©×“×” ×”×¤×¨×•×™×§×˜ ×× ×™×© ×›×¤×™×œ×•×ª
        projectInput.addEventListener("keydown", function (event) {
            console.log(`ğŸŸ¡ ××§×© × ×œ×—×¥ ×‘×©×“×” '×©× ×¤×¨×•×™×§×˜': ${event.key}`);
            if (event.key === "Tab" && projectInput.getAttribute("data-duplicate") === "true") {
                console.warn("â›” ×œ× × ×™×ª×Ÿ ×œ×¦××ª ××©×“×” '×©× ×¤×¨×•×™×§×˜' - ×™×© ×›×¤×™×œ×•×ª!");
                event.preventDefault();
                projectInput.focus();
            }
        });

        projectInput.addEventListener("focusout", function (event) {
            console.log("ğŸŸ¡ focusout ×”×•×¤×¢×œ ×‘×©× ×¤×¨×•×™×§×˜.");
            preventExitOnDuplicate(event, projectInput); // âœ… ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×”×›×œ×œ×™×ª ×œ×× ×™×¢×ª ×™×¦×™××”
        });

    } catch (error) {
        console.error("âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×¤×•× ×§×¦×™×” addProjectNameListeners:", error);
    }
}



function moveToNextField(currentField) {
    let formElements = Array.from(document.querySelectorAll("input, select, button"));
    let currentIndex = formElements.indexOf(currentField);

    do {
        currentIndex++;
    } while (currentIndex < formElements.length && formElements[currentIndex].readOnly);

    if (currentIndex < formElements.length) {
        formElements[currentIndex].focus();
    }
}

// âœ… ×¤×•× ×§×¦×™×” ×©××—×–×™×¨×” ××ª ×”×©×“×” ×”×‘× ×”×¤×ª×•×— ×œ×”×§×œ×“×”
function getNextField(currentField) {
    let formElements = Array.from(document.querySelectorAll("input:not([readonly]), select, button"));
    let currentIndex = formElements.indexOf(currentField);

    if (currentIndex >= 0 && currentIndex < formElements.length - 1) {
        return formElements[currentIndex + 1]; // ××—×–×™×¨×” ××ª ×”×©×“×” ×”×‘×
    }
    return null;
}

/**
 * ğŸš€ handleCustomerData - ×¢×“×›×•×Ÿ ×××©×§ ×”××©×ª××© ×¢× × ×ª×•× ×™ ×œ×§×•×— ×©×”×ª×§×‘×œ×• ××”×©×¨×ª.
 *
 * ğŸ“Œ ×ª×”×œ×™×š ×”×¢×‘×•×“×”:
 * 1ï¸âƒ£ ×‘×“×™×§×” ×”×× ×”×ª×§×‘×œ×• × ×ª×•× ×™× ×ª×§×™× ×™×.
 * 2ï¸âƒ£ ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×¤×¨×•×™×§×˜×™× ×©×œ ×”×œ×§×•×—.
 * 3ï¸âƒ£ ×¢×“×›×•×Ÿ ××™×© ×”×§×©×¨ ×‘×¨×™×¨×ª ××—×“×œ ×•×× ×©×™ ×”×§×©×¨ ×œ×‘×—×™×¨×”.
 * 4ï¸âƒ£ ×¢×“×›×•×Ÿ ×©×“×•×ª ×¢××œ×”: ××§×‘×œ ×¢××œ×”, ×ª××¨×™×š ×¡×™×•× ×•××—×•×–.
 * 5ï¸âƒ£ ×”×¤×¢×œ×ª ×”×˜×•×¤×¡ ×•×¤×ª×™×—×ª ×©×“×•×ª × ×•×¡×¤×™×.
 *
 * @param {Object} data - ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××”×©×¨×ª ×¢×‘×•×¨ ×œ×§×•×— ×©× ×‘×—×¨.
 */
function handleCustomerData(data) {
    console.log("ğŸ“¥ ×”×ª×—×œ×ª ×”×˜×™×¤×•×œ ×‘× ×ª×•× ×™ ×œ×§×•×— ×©×”×ª×§×‘×œ×• ××”×©×¨×ª...");
    console.log("ğŸ“¨ ×›×œ ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××”×©×¨×ª:");
    console.log(JSON.stringify(data, null, 2));


    // 1ï¸âƒ£ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”× ×ª×•× ×™×
    if (!data) {
        console.error("âŒ ×©×’×™××”: ×œ× ×”×ª×§×‘×œ×• × ×ª×•× ×™ ×œ×§×•×—.");
        return;
    }

    // 2ï¸âƒ£ ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×¤×¨×•×™×§×˜×™× ×©×œ ×”×œ×§×•×—
    existingProjects = data.projects ? data.projects.map(p => p.projectName) : [];
    console.log("âœ… ×¨×©×™××ª ×”×¤×¨×•×™×§×˜×™× ×¢×•×“×›× ×”:", existingProjects);

    // 3ï¸âƒ£ ×˜×™×¤×•×œ ×‘××™×© ×§×©×¨ ×‘×¨×™×¨×ª ××—×“×œ ×•×× ×©×™ ×§×©×¨
    let defaultContact = data.defaultContact || null;
    let contactsData = data.contacts || { contacts: [] };
    console.log("ğŸ“‡ ××™×© ×§×©×¨ ×‘×¨×™×¨×ª ××—×“×œ:", defaultContact);
    console.log("ğŸ“‡ ×× ×©×™ ×§×©×¨:", contactsData);
    populateContactDropdown(contactsData, defaultContact);

    // 4ï¸âƒ£ ×¢×“×›×•×Ÿ ×©×“×•×ª ×”×¢××œ×”
    try {
        const recipientField = document.getElementById("commissionRecipient");
        const endDateField = document.getElementById("commissionEndDate");
        const rateField = document.getElementById("commissionRate");

        if (recipientField) {
            recipientField.value = data.commissionRecipient || "";
            console.log("âœ… ×©×“×” '××§×‘×œ ×¢××œ×”' ×¢×•×“×›×Ÿ:", recipientField.value);
        } else {
            console.warn("âš ï¸ ×©×“×” 'commissionRecipient' ×œ× × ××¦× ×‘-DOM.");
        }

        if (endDateField) {
            endDateField.value = data.commissionEndDate || "";
            console.log("âœ… ×©×“×” '×ª××¨×™×š ×¡×™×•× ×—×•×‘×ª ×¢××œ×”' ×¢×•×“×›×Ÿ:", endDateField.value);
        } else {
            console.warn("âš ï¸ ×©×“×” 'commissionEndDate' ×œ× × ××¦× ×‘-DOM.");
        }

         if (rateField) {
            const rate = parseFloat(data.commissionRate || 0);
            const today = new Date();
            const commissionEnd = parseDDMMYYYY(data.commissionEndDate);

            if (commissionEnd && commissionEnd < today) {
                rateField.value = 0;
                rateField.title = "â›” ×ª××¨×™×š ×¡×™×•× ×¢××œ×” ×¢×‘×¨";
                console.warn("â›” ×ª××¨×™×š ×¡×™×•× ×¢××œ×” ×¢×‘×¨ â€“ ××—×•×– ×”×¢××œ×” ××•×¤×¡ ×œ-0.");
            } else {
                rateField.value = rate;
                console.log("âœ… ×©×“×” '××—×•×– ×¢××œ×”' ×¢×•×“×›×Ÿ:", rate);
            }
        } else {
            console.warn("âš ï¸ ×©×“×” 'commissionRate' ×œ× × ××¦× ×‘-DOM.");
        }


    } catch (error) {
        console.error("âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×©×“×•×ª ×¢××œ×”:", error);
    }

    // 5ï¸âƒ£ ×”×¤×¢×œ×ª ×”×˜×•×¤×¡ ×œ××—×¨ ×˜×¢×™× ×” ××œ××”
    enableForm();
    console.log("âœ… ×¡×™×•× ×”×˜×™×¤×•×œ ×‘× ×ª×•× ×™ ×œ×§×•×—.");
}


/**
 * ğŸ§® parseDDMMYYYY - ×××™×¨×” ××—×¨×•×–×ª ×ª××¨×™×š ×‘×¤×•×¨××˜ dd/mm/yyyy ×œ××•×‘×™×™×§×˜ Date
 *
 * ×©×œ×‘×™×:
 * 1ï¸âƒ£ ×¤×™×¦×•×œ ×”××—×¨×•×–×ª ×œ×©×œ×•×©×” ×—×œ×§×™×: ×™×•×, ×—×•×“×©, ×©× ×”.
 * 2ï¸âƒ£ ×‘× ×™×™×ª ××—×¨×•×–×ª ×ª××¨×™×š ×¡×˜× ×“×¨×˜×™×ª ×‘×¤×•×¨××˜ yyyy-mm-dd.
 * 3ï¸âƒ£ ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ Date ××”×ª××¨×™×š ×”××¤×•×¨××˜.
 *
 * @param {string} dateStr - ××—×¨×•×–×ª ×ª××¨×™×š ×‘×¤×•×¨××˜ dd/mm/yyyy.
 * @returns {Date|null} - ××•×‘×™×™×§×˜ ×ª××¨×™×š ×ª×§× ×™ ××• null ×× ×”××—×¨×•×–×ª ×¨×™×§×”.
 */
function parseDDMMYYYY(dateStr) {
    try {
        console.log("ğŸ” ×”×ª×—×œ×ª ×”××¨×ª ×ª××¨×™×š ×××—×¨×•×–×ª ×œ××•×‘×™×™×§×˜ Date:", dateStr);
        if (!dateStr) return null;

        const [day, month, year] = dateStr.split("/");
        const isoDateString = `${year}-${month}-${day}`;
        const parsedDate = new Date(isoDateString);

        console.log("ğŸ“† ×ª××¨×™×š ××•××© ×›- Date:", parsedDate.toISOString());
        return parsedDate;

    } catch (error) {
        console.error("âŒ ×©×’×™××” ×‘×”××¨×ª ×ª××¨×™×š:", error);
        return null;
    }
}



function handleProjectsResponse(projects) {
    enableProjectInput(); // ××©×—×¨×¨ ××ª ×©×“×” ×©× ×”×¤×¨×•×™×§×˜

    if (!projects || projects.length === 0) {
        console.warn("âš ï¸ ××™×Ÿ ×¤×¨×•×™×§×˜×™× ×œ×œ×§×•×— ×–×”.");
        existingProjects = [];
        return;
    }

    console.log("âœ… ×¤×¨×•×™×§×˜×™× × ×˜×¢× ×•:", projects);
    existingProjects = projects;
}

function displayError(field, message) {
    let errorElement = document.getElementById(`${field}Error`);
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = "block";
    } else {
        console.warn(`âš ï¸ ××œ×× ×˜ ×”×©×’×™××” ×œ× × ××¦× ×¢×‘×•×¨ ×”×©×“×”: ${field}`);
    }
}

function hideError(field) {
    let errorElement = document.getElementById(`${field}Error`);
    if (errorElement) {
        errorElement.textContent = "";
        errorElement.style.display = "none";
    }
}

function resetField(field) {
  field.value = "";
  showSuggestions("");
  field.focus();
}

/**
 * ğŸš€ validateForm - ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×” ×× ×›×œ ×ª× ××™ ×”×˜×•×¤×¡ ××•×œ××• ×›×“×™ ×œ××¤×©×¨ ×©×œ×™×—×”.
 *
 * ğŸ” ×ª×”×œ×™×š ×”×¢×‘×•×“×”:
 * 1ï¸âƒ£ ×‘×•×“×§×ª ×©×›×œ ×”×©×“×•×ª ×”×—×™×•× ×™×™× ××œ××™× (×œ×¤×™ ×”×¨×©×™××” `requiredFields`).
 * 2ï¸âƒ£ ××•×•×“××ª ×©×©×“×” "××™×© ×§×©×¨" ×œ× × ×©××¨ ×¢× ×¢×¨×š ×‘×¨×™×¨×ª ××—×“×œ.
 * 3ï¸âƒ£ ×× ×™×© ×©×“×” ×—×¡×¨, ×ª×•×¦×’ ×”×•×“×¢×ª ×©×’×™××” ×¨×œ×•×•× ×˜×™×ª ×•×”×©×“×” ×™×¡×•××Ÿ.
 * 4ï¸âƒ£ ×× ×›×œ ×”× ×ª×•× ×™× ×ª×§×™× ×™× â†’ ×›×¤×ª×•×¨ ×”×©×œ×™×—×” ×™×•×¤×¢×œ âœ….
 * 5ï¸âƒ£ ×× ×™×© ×—×•×¡×¨×™× â†’ ×›×¤×ª×•×¨ ×”×©×œ×™×—×” ×™×™×©××¨ ××•×©×‘×ª âŒ.
 *
 * ğŸ›‘ ×˜×™×¤×•×œ ×‘×©×’×™××•×ª:
 * - ×× ××œ×× ×˜ ×œ× × ××¦× ×‘-DOM â†’ ×ª×•×“×¤×¡ ×©×’×™××” `console.error()`.
 * - ×›×œ ×©×“×” ×—×¡×¨ â†’ ×”×•×“×¢×ª ×©×’×™××” ×ª×•×¦×’ ×¢× `displayError()`.
 * - ×”×•×“×¢×•×ª ×©×’×™××” ×™×©× ×•×ª ×× ×•×§×•×ª ×œ×¤× ×™ ×”×‘×“×™×§×” ×›×“×™ ×œ×× ×•×¢ ×”×¦×˜×‘×¨×•×ª ×©×’×™××•×ª.
 */
function validateForm() {
    try {
        console.log("ğŸ” ×”×ª×—×œ×ª ×‘×“×™×§×ª ×”×˜×•×¤×¡...");

        // âœ… ×¨×©×™××ª ×”×©×“×•×ª ×”×—×™×•× ×™×™× ×©×¦×¨×™×›×™× ×œ×”×™×•×ª ××œ××™×
        let requiredFields = [
            { id: "customerName", label: "×©× ×œ×§×•×—" },
            { id: "customerID", label: "××–×”×” ×œ×§×•×—" },
            { id: "projectName", label: "×©× ×¤×¨×•×™×§×˜" },
            { id: "creationDate", label: "×ª××¨×™×š ×™×¦×™×¨×”" },
            { id: "entryDate", label: "×ª××¨×™×š ×›× ×™×¡×” ×œ××¢×¨×›×ª" },
            { id: "projectID", label: "××–×”×” ×¤×¨×•×™×§×˜" }
        ];

        let submitButton = document.getElementById("submitButton");
        let contactPerson = document.getElementById("contactPerson"); // ğŸ“Œ ×©×“×” "××™×© ×§×©×¨"
        let allFieldsFilled = true;

        console.log("ğŸ“œ ×‘×“×™×§×” ×©×›×œ ×”×©×“×•×ª ×”×—×™×•× ×™×™× ××œ××™×...");

        // ğŸ”¹ × ×™×§×•×™ ×”×•×“×¢×•×ª ×©×’×™××” ×™×©× ×•×ª
        requiredFields.forEach(field => hideError(field.id));
        hideError("contactPerson"); // ××—×™×§×ª ×©×’×™××” ×™×©× ×” ×’× ××©×“×” "××™×© ×§×©×¨"

        // ğŸ”¹ ×‘×“×™×§×” ×©×›×œ ×”×©×“×•×ª ×”×¨×’×™×œ×™× ××œ××™×
        for (let field of requiredFields) {
            let element = document.getElementById(field.id);
            if (!element) {
                console.error(`âŒ ×©×’×™××” ×§×¨×™×˜×™×ª: ×”××œ×× ×˜ ${field.id} ×œ× × ××¦× ×‘-DOM!`);
                continue; // ×××©×™×›×™× ×œ×‘×“×™×§×” ×”×‘××”
            }

            let value = element.value.trim();
            console.log(`ğŸ”¹ ×‘×“×™×§×ª ×©×“×” "${field.label}":`, value);

            if (value === "") {
                allFieldsFilled = false;
                displayError(field.id, `âš ï¸ ${field.label} ×”×•× ×©×“×” ×—×•×‘×”!`);
                console.warn(`âš ï¸ ×”×©×“×” "${field.label}" ×¨×™×§ - ×˜×•×¤×¡ ×œ× ×ª×§×™×Ÿ.`);
            }
        }

        // ğŸ”¹ ×‘×“×™×§×” ××™×•×—×“×ª ×œ×©×“×” "××™×© ×§×©×¨"
        if (contactPerson) {
            let contactValue = contactPerson.value.trim();
            console.log(`ğŸ”¹ ×‘×“×™×§×ª ×©×“×” "××™×© ×§×©×¨":`, contactValue);

            if (contactValue === "" || contactValue === "×‘×—×¨ ××™×© ×§×©×¨...") {
                allFieldsFilled = false;
                displayError("contactPerson", "âš ï¸ ×™×© ×œ×‘×—×•×¨ ××™×© ×§×©×¨!");
                console.warn(`âš ï¸ ××™×© ×§×©×¨ ×œ× × ×‘×—×¨ - ×˜×•×¤×¡ ×œ× ×ª×§×™×Ÿ.`);
            }
        } else {
            console.error("âŒ ×©×’×™××” ×§×¨×™×˜×™×ª: ××œ×× ×˜ 'contactPerson' ×œ× × ××¦×!");
        }

        // ğŸ”¹ ×”×¤×¢×œ×ª ××• ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ×”×©×œ×™×—×”
        if (allFieldsFilled) {
            submitButton.disabled = false;
            console.log("âœ… ×›×œ ×”×©×“×•×ª ××œ××™×, ×›×¤×ª×•×¨ '××™×©×•×¨' ×”×•×¤×¢×œ.");
        } else {
            submitButton.disabled = true;
            console.warn("âš ï¸ ×—×œ×§ ××”×©×“×•×ª ×—×¡×¨×™× ××• ×œ× ×ª×§×™× ×™×, ×›×¤×ª×•×¨ '××™×©×•×¨' × ×©××¨ ××•×©×‘×ª.");
        }

        console.log("ğŸ” ×¡×™×•× ×‘×“×™×§×ª ×”×˜×•×¤×¡.");

    } catch (error) {
        console.error("âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×¤×•× ×§×¦×™×” validateForm:", error);
    }
}

/**
 * ğŸš€ ×’×•×œ×œ ××•×˜×•××˜×™×ª ×œ×›×¤×ª×•×¨ ×”×©×œ×™×—×” ×›××©×¨ ××•×¡×™×¤×™× ××™×© ×§×©×¨ ×—×“×©
 */
function scrollToSubmitButton() {
    try {
        let submitButton = document.getElementById("submitButton");
        if (!submitButton) {
            console.warn("âš ï¸ ×›×¤×ª×•×¨ '×©×œ×—' ×œ× × ××¦× ×‘-DOM.");
            return;
        }

        console.log("ğŸ“œ ××‘×¦×¢ ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ×›×¤×ª×•×¨ ×”×©×œ×™×—×”.");
        submitButton.scrollIntoView({ behavior: "smooth", block: "center" });
    } catch (error) {
        console.error("âŒ ×©×’×™××” ×‘×’×œ×™×œ×” ×œ×›×¤×ª×•×¨ ×”×©×œ×™×—×”:", error);
    }
}

// ×××–×™×Ÿ ×œ×©×™× ×•×™ ×‘×©×“×” "××™×© ×§×©×¨"
document.getElementById("contactPerson").addEventListener("change", function () {
    try {
        console.log("ğŸ“Œ ×©×™× ×•×™ ×‘×¢×¨×š ××™×© ×§×©×¨:", this.value);
        if (this.value === "new") {
            setTimeout(scrollToSubmitButton, 300); // ×’×•×œ×œ×™× ××—×¨×™ 300ms ×›×“×™ ×œ××¤×©×¨ ×œ×˜×•×¤×¡ ×œ×”×ª××¨×š
        }
    } catch (error) {
        console.error("âŒ ×©×’×™××” ×‘×”××–× ×” ×œ×©×“×” '××™×© ×§×©×¨':", error);
    }
});

/**
 * ğŸš€ submitForm - ×©×•×œ×— ××ª × ×ª×•× ×™ ×”×˜×•×¤×¡ ×œ×©×¨×ª ×•××ª×—×™×œ ××ª ×ª×”×œ×™×š ×”×©××™×¨×”.
 *
 * ğŸ“Œ ×ª×”×œ×™×š ×”×¢×‘×•×“×”:
 * 1ï¸âƒ£ ××‘×¦×¢ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×¨××©×•× ×™×ª.
 * 2ï¸âƒ£ ××©×‘×™×ª ××ª ×›×¤×ª×•×¨ ×”×©×œ×™×—×” ×›×“×™ ×œ×× ×•×¢ ×©×œ×™×—×” ×›×¤×•×œ×”.
 * 3ï¸âƒ£ ××¦×™×’ ×”×•×“×¢×ª ×˜×¢×™× ×” ×œ××©×ª××©.
 * 4ï¸âƒ£ ××•×¡×£ ××ª ×”× ×ª×•× ×™× ××”×©×“×•×ª ×‘×˜×•×¤×¡, ×›×•×œ×œ ×©×“×•×ª ×¢××œ×” (×’× ×× ×¨×™×§×™×).
 * 5ï¸âƒ£ ×©×•×œ×— ××ª ×”× ×ª×•× ×™× ×œ×©×¨×ª ×‘×××¦×¢×•×ª google.script.run.
 * 6ï¸âƒ£ ××˜×¤×œ ×‘×ª×’×•×‘×” ××”×©×¨×ª.
 */
function submitForm() {
    try {
        console.log("ğŸ“© ×”×ª×—×œ×ª ×©×œ×™×—×ª ×”× ×ª×•× ×™× ×œ×©×¨×ª...");

        // 1ï¸âƒ£ ×’×œ×™×œ×” ×œ××¢×œ×” ×œ×”×¦×’×ª ×”×•×“×¢×ª ×˜×¢×™× ×”
        scrollToTop();

        let submitButton = document.getElementById("submitButton");
        let statusMessage = document.getElementById("loadingMessage");

        // 2ï¸âƒ£ ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ×©×œ×™×—×” ×•×”×¦×’×ª ×”×•×“×¢×ª ×˜×¢×™× ×”
        submitButton.disabled = true;
        statusMessage.innerText = "â³ ×©×•×œ×— × ×ª×•× ×™×... ×× × ×”××ª×Ÿ";
        statusMessage.style.display = "block";

        // 3ï¸âƒ£ ××™×¡×•×£ × ×ª×•× ×™ ×”×˜×•×¤×¡
        let formData = {
            creationDate: document.getElementById("creationDate").value.trim(),
            entryDate: document.getElementById("entryDate").value.trim(),
            projectID: document.getElementById("projectID").value.trim(),
            customerID: document.getElementById("customerID").value.trim(),
            customerName: document.getElementById("customerName").value.trim(),
            projectName: document.getElementById("projectName").value.trim(),
            contactPerson: document.getElementById("contactPerson").value.trim(),

            // 4ï¸âƒ£ × ×ª×•× ×™ ×¢××œ×” â€“ ××•×¢×‘×¨×™× ×’× ×× ×¨×™×§×™×
            commissionRecipient: document.getElementById("commissionRecipient").value.trim(),
            commissionRate: document.getElementById("commissionRate").value.trim(),
            commissionEndDate: document.getElementById("commissionEndDate").value.trim()
        };

        // 5ï¸âƒ£ ×˜×™×¤×•×œ ×‘××§×¨×” ×©×œ ××™×© ×§×©×¨ ×—×“×©
        if (formData.contactPerson === "new") {
            formData.newContact = {
                name: document.getElementById("newContactName").value.trim(),
                phone: document.getElementById("newContactPhone").value.trim(),
                email: document.getElementById("newContactEmail").value.trim()
            };
        }

        console.log("ğŸ“Š ×©×•×œ×— ××ª ×”× ×ª×•× ×™× ×œ×©×¨×ª:", formData);

        // 6ï¸âƒ£ ×©×œ×™×—×ª ×”× ×ª×•× ×™× ×œ×©×¨×ª
        google.script.run
            .withSuccessHandler(formSubmissionSuccess)
            .withFailureHandler(formSubmissionFailure)
            .saveProjectData(formData);

    } catch (error) {
        console.error("âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×¤×•× ×§×¦×™×” submitForm:", error);
        alert("âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×©×œ×™×—×ª ×”× ×ª×•× ×™×. × ×¡×” ×©×•×‘.");

        // ×©×™×—×–×•×¨ ××¦×‘ ×œ××—×¨ ×©×’×™××”
        document.getElementById("submitButton").disabled = false;
        document.getElementById("loadingMessage").style.display = "none";
    }
}




/**
 * ğŸš€ ×’×•×œ×œ ××•×˜×•××˜×™×ª ×œ×¨××© ×”×“×£ ×›×“×™ ×œ×”×¦×™×’ ××ª ×—×™×•×•×™ ×”×©×œ×™×—×”
 */
function scrollToTop() {
    try {
        console.log("ğŸ“œ ××‘×¦×¢ ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ×¨××© ×”×“×£.");
        window.scrollTo({ top: 0, behavior: "smooth" });
    } catch (error) {
        console.error("âŒ ×©×’×™××” ×‘×’×œ×™×œ×” ×œ×¨××© ×”×“×£:", error);
    }
}

// ×××–×™×Ÿ ×œ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ "×©×œ×—"
let submitButton = document.getElementById("submitButton");

if (submitButton) {
    submitButton.addEventListener("click", function () {
        try {
            console.log("ğŸ“Œ ×œ×—×™×¦×” ×¢×œ '×©×œ×—' â€“ ××‘×¦×¢ ×’×œ×™×œ×” ×œ××¢×œ×”.");
            scrollToTop();
        } catch (error) {
            console.error("âŒ ×©×’×™××” ×‘×”××–× ×” ×œ×œ×—×™×¦×” ×¢×œ '×©×œ×—':", error);
        }
    });
}

/**
 * ğŸš€ attachNewContactListeners - ××•×¡×™×¤×” ×××–×™× ×™× ×œ×©×“×•×ª ×©×œ ××™×© ×§×©×¨ ×—×“×©.
 *
 * ğŸ” **××” ×”×¤×•× ×§×¦×™×” ×¢×•×©×”?**
 * 1ï¸âƒ£ ×××–×™×Ÿ ×œ×©×“×” "×©× ××™×© ×§×©×¨":
 *     âœ… ××•×•×“× ×©×”×•×–× ×• ×œ×¤×—×•×ª **2 ×ª×•×•×™× ×‘××•×ª×™×•×ª ×¢×‘×¨×™×ª ××• ×× ×’×œ×™×ª** (×œ× ×›×•×œ×œ ×¨×•×•×—×™× ×‘×œ×‘×“).
 *     âœ… ×××¤×©×¨ **×©××•×ª ×¢× ×¨×•×•×—×™×** (×œ××©×œ: "×“×•×“ ×œ×•×™").
 *     âœ… ×× ×”×¢×¨×š ×œ× ×ª×§×™×Ÿ, ××•×¦×’×ª ×”×•×“×¢×ª ×©×’×™××”, ×•×”××©×ª××© ×œ× ×™×›×•×œ ×œ×¢×–×•×‘ ××ª ×”×©×“×”.
 * 2ï¸âƒ£ ×××–×™×Ÿ ×œ×©×“×•×ª "×˜×œ×¤×•×Ÿ" ×•-"×“×•×"×œ":
 *     âœ… ×§×•×“× ×”×“×¤×“×¤×Ÿ ×‘×•×“×§ ×©×”×©×“×” ×—×•×§×™ (`reportValidity()`).
 *     âœ… ×œ××—×¨ ××›×Ÿ, ×× ×©× ×™ ×”×©×“×•×ª ×¨×™×§×™× â€“ ××—×–×™×¨×™× ××ª ×”×¤×•×§×•×¡ ×•×œ× ×××¤×©×¨×™× ×™×¦×™××”.
 * 3ï¸âƒ£ ×× ×”×©×“×” ×ª×§×™×Ÿ â€“ ××¡×ª×™×¨×™× ××ª ×”×•×“×¢×ª ×”×©×’×™××”.
 */
function attachNewContactListeners() {
    try {
        console.log("ğŸ”¹ attachNewContactListeners() ×”×•×¤×¢×œ×” â€“ ×”×•×¡×¤×ª ×××–×™× ×™× ×œ×©×“×•×ª ××™×© ×§×©×¨ ×—×“×©.");

        // âœ… ×©×œ×™×¤×ª ×”×©×“×•×ª ×©×œ ××™×© ×§×©×¨ ×—×“×©
        let nameInput = document.getElementById("newContactName");
        let phoneInput = document.getElementById("newContactPhone");
        let emailInput = document.getElementById("newContactEmail");

        if (!nameInput || !phoneInput || !emailInput) {
            console.error("âŒ ×©×’×™××”: ××—×“ ××©×“×•×ª ××™×© ×”×§×©×¨ ×”×—×“×© ×œ× × ××¦×!");
            return;
        }

        console.log("âœ… ×›×œ ×”×©×“×•×ª × ××¦××• - ××•×¡×™×¤×™× ×××–×™× ×™×.");

        // âœ… ×××–×™×Ÿ ×™×¦×™××” ×œ×©× ××™×© ×§×©×¨ â€“ ××•×•×“× ×œ×¤×—×•×ª 2 ×ª×•×•×™× ××©××¢×•×ª×™×™× (××•×ª×™×•×ª ×‘×œ×‘×“, ××‘×œ ×××¤×©×¨ ×¨×•×•×—×™×)
        nameInput.addEventListener("blur", function (event) {
            let value = this.value.trim();
            let regex = /^[\p{L}][\p{L} ]{1,}$/u; // âœ… ×œ×¤×—×•×ª 2 ×ª×•×•×™× ××©××¢×•×ª×™×™×, ××š ×××¤×©×¨ ×¨×•×•×—×™× ×‘×™×Ÿ ××™×œ×™×
            if (!regex.test(value)) {
                displayError("newContactName", "âš ï¸ ×™×© ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª 2 ××•×ª×™×•×ª ×‘×¢×‘×¨×™×ª ××• ×‘×× ×’×œ×™×ª (×¨×•×•×—×™× ××•×ª×¨×™×).");
                console.warn("âš ï¸ ×©× ××™×© ×§×©×¨ ×œ× ×¢×•××“ ×‘×“×¨×™×©×•×ª.");
                event.preventDefault();
                this.focus();
            } else {
                hideError("newContactName");
                console.log("âœ… ×©× ××™×© ×§×©×¨ ×ª×§×™×Ÿ.");
            }
        });

        // âœ… ×‘×“×™×§×” ×× ×œ×¤×—×•×ª ××—×“ ××©×“×•×ª "×˜×œ×¤×•×Ÿ" ××• "×“×•×"×œ" ××•×œ×
        function validateContactMethods(event) {
            let phoneValue = phoneInput.value.trim();
            let emailValue = emailInput.value.trim();

            // âœ… ×§×•×“× × ×™×ª×Ÿ ×œ×“×¤×“×¤×Ÿ ×œ×‘×“×•×§ ××ª ×”×©×“×” â€“ ×× ×”×•× ×œ× ×ª×§×™×Ÿ, ×œ× × ×‘×¦×¢ ××ª ×”×‘×“×™×§×” ×©×œ× ×•.
            if (!event.target.reportValidity()) {
                console.warn(`âš ï¸ ×”×©×“×” '${event.target.id}' ××™× ×• ×ª×§×™×Ÿ ×œ×¤×™ ×‘×“×™×§×ª ×”×“×¤×“×¤×Ÿ.`);
                return;
            }

            // âœ… ×× ×©× ×™ ×”×©×“×•×ª ×¨×™×§×™× â€“ ×× ×™×¢×ª ×™×¦×™××”
            if (phoneValue === "" && emailValue === "") {
                displayError("newContactPhone", "âš ï¸ ×—×•×‘×” ×œ×”×–×™×Ÿ ×˜×œ×¤×•×Ÿ ××• ×“×•×\"×œ!");
                displayError("newContactEmail", "âš ï¸ ×—×•×‘×” ×œ×”×–×™×Ÿ ×˜×œ×¤×•×Ÿ ××• ×“×•×\"×œ!");
                console.warn("âš ï¸ ×˜×œ×¤×•×Ÿ ×•×“×•×\"×œ ×—×¡×¨×™×. ×œ× × ×™×ª×Ÿ ×œ×¢×–×•×‘ ××ª ×”×©×“×”.");
                event.preventDefault();
                event.target.focus();
            } else {
                hideError("newContactPhone");
                hideError("newContactEmail");
                console.log("âœ… ×œ×¤×—×•×ª ××—×“ ××©×“×•×ª ×˜×œ×¤×•×Ÿ/×“×•×\"×œ ××•×œ×.");
            }
        }

        // âœ… ×××–×™×Ÿ ×™×¦×™××” (blur) ×œ×©×“×•×ª ×˜×œ×¤×•×Ÿ ×•×“×•×"×œ - ×œ××—×¨ ×©×”×“×¤×“×¤×Ÿ ×‘×“×§ ×ª×§×™× ×•×ª
        phoneInput.addEventListener("blur", validateContactMethods);
        emailInput.addEventListener("blur", validateContactMethods);

        console.log("âœ… ×××–×™× ×™× × ×•×¡×¤×• ×‘×”×¦×œ×—×” ×œ×©×“×•×ª ××™×© ×§×©×¨ ×—×“×©.");
    } catch (error) {
        console.error("âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×¤×•× ×§×¦×™×” attachNewContactListeners:", error);
    }
}




/**
 * ğŸš€ addNewContactFields - ×¤×•× ×§×¦×™×” ×©×™×•×¦×¨×ª ×©×“×•×ª ×“×™× ×××™×™× ×œ×”×–× ×ª ××™×© ×§×©×¨ ×—×“×©.
 *
 * ğŸ” **××” ×”×¤×•× ×§×¦×™×” ×¢×•×©×”?**
 * 1ï¸âƒ£ ××•×¡×™×¤×” ×©×œ×•×©×” ×©×“×•×ª ×—×“×©×™×: "×©× ××™×© ×§×©×¨", "×˜×œ×¤×•×Ÿ" ×•"×“×•×"×œ".
 * 2ï¸âƒ£ ××•×¡×™×¤×” ×œ×›×œ ×©×“×” ××–×•×¨ ×©×’×™××” (×©×™×¦×™×’ ×”×•×“×¢×ª ×©×’×™××” ××ª×—×ª×™×•).
 * 3ï¸âƒ£ ×§×•×¨××ª ×œ-`attachNewContactListeners()` ×›×“×™ ×œ×”×•×¡×™×£ ×××–×™× ×™× ×œ×©×“×•×ª ×”×—×“×©×™×.
 * 4ï¸âƒ£ **×©××” ×¤×•×§×•×¡ ××•×˜×•××˜×™ ×¢×œ ×©×“×” "×©× ××™×© ×§×©×¨" ×œ××—×¨ ×™×¦×™×¨×ª ×”×©×“×•×ª.**
 */
function addNewContactFields() {
    let newContactFields = document.getElementById("newContactFields");

    // âœ… ×”×•×¡×¤×ª ×”×©×“×•×ª ×¨×§ ×× ×”× ×¢×“×™×™×Ÿ ×œ× ×§×™×™××™×
    if (!document.getElementById("newContactPhone")) {
        console.log("ğŸ”¹ ×™×¦×™×¨×ª ×©×“×•×ª ×—×“×©×™× ×œ××™×© ×§×©×¨...");

        newContactFields.innerHTML = `
            <div class="form-group">
                <label>×©× ××™×© ×§×©×¨:</label>
                <input type="text" id="newContactName" placeholder="×”×›× ×¡ ×©× ××™×© ×§×©×¨" required>
                <div id="newContactNameError" class="error-message" style="display: none;"></div>
            </div>
            <div class="form-group">
                <label>×˜×œ×¤×•×Ÿ ××™×© ×§×©×¨:</label>
                <input type="tel" id="newContactPhone" placeholder="×”×›× ×¡ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ" pattern="[0-9]{9,10}" >
                <div id="newContactPhoneError" class="error-message" style="display: none;"></div>
            </div>
            <div class="form-group">
                <label>×“×•×"×œ ××™×© ×§×©×¨:</label>
                <input type="email" id="newContactEmail" placeholder="×”×›× ×¡ ×“×•×&quot;×œ" style="direction: rtl; text-align: left;">
                <div id="newContactEmailError" class="error-message" style="display: none;"></div>
            </div>
        `;

        console.log("âœ… ×©×“×•×ª ×—×“×©×™× ×œ××™×© ×§×©×¨ × ×•×¡×¤×• ×œ×˜×•×¤×¡.");

        // âœ… ×”×•×¡×¤×ª ×××–×™× ×™× ×œ×©×“×•×ª ×”×—×“×©×™×
        attachNewContactListeners();

        // âœ… ×”×¦×‘×ª ×¤×•×§×•×¡ ××•×˜×•××˜×™ ×‘×©×“×” "×©× ××™×© ×§×©×¨"
        let nameInput = document.getElementById("newContactName");
        if (nameInput) {
            nameInput.focus();
            console.log("ğŸ“Œ ×¤×•×§×•×¡ ×”×•×¢×‘×¨ ×œ×©×“×” '×©× ××™×© ×§×©×¨'.");
        } else {
            console.error("âŒ ×©×’×™××”: ×œ× × ××¦× ×©×“×” '×©× ××™×© ×§×©×¨' ×œ×”×¦×‘×ª ×¤×•×§×•×¡.");
        }
    }
}

/**
 * ××˜×¤×œ ×‘×ª×’×•×‘×” ××”×©×¨×ª ×œ××—×¨ ×©×œ×™×—×ª ×”× ×ª×•× ×™×.
 * 
 * ×ª×”×œ×™×š ×”×¢×‘×•×“×”:
 * 1. ×‘×•×“×§ ××ª ×”×ª×•×¦××” ×©×”×•×—×–×¨×” ××”×©×¨×ª (`result`).
 * 2. ×× ×”×ª×•×¦××” ×”×™× `"success"` - ××¦×™×’ ×”×•×“×¢×ª ×”×¦×œ×—×”, ×××ª×™×Ÿ 2 ×©× ×™×•×ª, ×•×¡×•×’×¨ ××ª ×”×˜×•×¤×¡.
 * 3. ×× ×”×ª×•×¦××” ×”×™× `"error"` - ××¦×™×’ ×”×•×“×¢×ª ×©×’×™××” ×œ××©×ª××© ×•××¤×¢×™×œ ××—×“×© ××ª ×›×¤×ª×•×¨ ×”×©×œ×™×—×”.
 *
 * @param {string} result - ×ª×•×¦××ª ×”×‘×§×©×” ××”×©×¨×ª ("success" ××• "error").
 */
function formSubmissionSuccess(result) {
    console.log("ğŸ“© ×§×™×‘×œ× ×• ×ª×©×•×‘×” ×-Google Apps Script:", result);

    let statusMessage = document.getElementById("loadingMessage");
    let submitButton = document.getElementById("submitButton");

    if (result === "success") {
        statusMessage.innerText = "âœ… ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”!";
        console.log("âœ… ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×” ×‘×˜×‘×œ×”.");
        setTimeout(() => google.script.host.close(), 2000); // â³ ×¡×’×™×¨×ª ×”×˜×•×¤×¡ ××—×¨×™ 2 ×©× ×™×•×ª
    } else {
        statusMessage.innerText = "âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×, × ×¡×” ×©×•×‘.";
        submitButton.disabled = false; // ğŸ”„ ×”×¤×¢×œ×ª ×”×›×¤×ª×•×¨ ××—×“×©
    }
}

/**
 * ×××›×œ×¡ ××ª ×©×“×” ×”×‘×—×™×¨×” ×©×œ ××™×© ×§×©×¨ ×¢× × ×ª×•× ×™× ×‘×¤×•×¨××˜ "×©× | ×˜×œ×¤×•×Ÿ | ××™×™×œ"
 * 
 * @param {Array} contactsList - ×¨×©×™××ª ×× ×©×™ ×”×§×©×¨ (××¢×¨×š ×©×œ ××•×‘×™×™×§×˜×™× ×¢× ×©×, ×˜×œ×¤×•×Ÿ, ×“×•×"×œ)
 * @param {String} mainContact - ××™×© ×§×©×¨ ×‘×¨×™×¨×ª ××—×“×œ (×× ×§×™×™×)
 */

function populateContactDropdown(contactsData, defaultContact) {
    let contactSelect = document.getElementById("contactPerson");

    console.log("ğŸ“¡ × ×ª×•× ×™ ×× ×©×™ ×§×©×¨ ×©×”×ª×§×‘×œ×•:", contactsData);
    console.log("ğŸ“¡ ××™×© ×”×§×©×¨ ×”×“×™×¤×•×œ×˜×™ (defaultContact):", defaultContact);

    let contactsList = contactsData.contacts || [];

    contactSelect.innerHTML = '<option value="">×‘×—×¨ ××™×© ×§×©×¨...</option>';

    let foundDefaultContact = false;

    console.log("ğŸ“œ ×× ×©×™ ×§×©×¨ ××”×¨×©×™××”:");
    contactsList.forEach(contact => console.log(`ğŸ”¹ ${contact.name}`)); // ×”×“×¤×¡×ª ×›×œ ×”×©××•×ª ××”×¨×©×™××”

    contactsList.forEach(contact => {
        let name = contact.name.trim();
        let phone = contact.phone || "×œ×œ× ×˜×œ×¤×•×Ÿ";
        let email = contact.email || "×œ×œ× ×“×•×\"×œ";

        let option = document.createElement("option");
        option.value = name;
        option.textContent = `${name} | ${phone} |  \u200E${email}`;
        option.dataset.phone = phone;
        option.dataset.email = email;

        if (defaultContact && defaultContact.trim() === name) {
            option.selected = true;
            foundDefaultContact = true;
            console.log(`âœ… ××™×© ×”×§×©×¨ ×”×“×™×¤×•×œ×˜×™ "${defaultContact}" × ××¦× ×•× ×‘×—×¨ ×›×‘×¨×™×¨×ª ××—×“×œ.`);
        }

        contactSelect.appendChild(option);
    });

    // âœ… ×× ××™×© ×”×§×©×¨ ×”×“×™×¤×•×œ×˜×™ ×œ× × ××¦× - × ×¨×©×•× ××–×”×¨×” ×‘×œ×‘×“ ×•×œ× × ×•×¡×™×£ ××•×ª×•
    if (defaultContact && !foundDefaultContact) {
        console.warn(`âš ï¸ ×©×’×™××”: ××™×© ×”×§×©×¨ ×”×“×™×¤×•×œ×˜×™ "${defaultContact}" ×œ× × ××¦× ×‘×¨×©×™××”.`);
    }

    let addNewOption = document.createElement("option");
    addNewOption.value = "new";
    addNewOption.textContent = "â• ×”×•×¡×£ ××™×© ×§×©×¨ ×—×“×©";
    contactSelect.appendChild(addNewOption);
}


/**
 * ğŸš€ toggleNewContactFields - ×¤×•× ×§×¦×™×” ×©××•×¡×™×¤×” ××• ××¡×™×¨×” ×©×“×•×ª ×“×™× ×××™×™× ×œ×”×–× ×ª ××™×© ×§×©×¨ ×—×“×©.
 *
 * ğŸ” **××” ×”×¤×•× ×§×¦×™×” ×¢×•×©×”?**
 * 1ï¸âƒ£ ×× ×”××©×ª××© ×‘×•×—×¨ "â• ×”×•×¡×£ ××™×© ×§×©×¨ ×—×“×©", ×§×•×¨××ª ×œ-`addNewContactFields()`.
 * 2ï¸âƒ£ ×× ×”××©×ª××© ××—×œ×™×£ ×œ××™×© ×§×©×¨ ×§×™×™×, ××¡×™×¨×” ××ª ×”×©×“×•×ª ×”×“×™× ×××™×™×.
 */
function toggleNewContactFields() {
    console.log("ğŸ”¹ ×”×¤×¢×œ×ª toggleNewContactFields() â€“ ×˜×™×¤×•×œ ×‘×©×“×•×ª ××™×© ×§×©×¨ ×—×“×©.");

    let contactSelect = document.getElementById("contactPerson");
    let newContactFields = document.getElementById("newContactFields");

    if (contactSelect.value === "new") {
        console.log("ğŸ“Œ ×”××©×ª××© ×‘×—×¨ ×œ×”×•×¡×™×£ ××™×© ×§×©×¨ ×—×“×© â€“ ××•×¡×™×¤×™× ×©×“×•×ª.");
        addNewContactFields();
        newContactFields.style.display = "block";
    } else {
        console.log("ğŸ“Œ ×”××©×ª××© ×—×–×¨ ×œ×‘×—×™×¨×ª ××™×© ×§×©×¨ ×§×™×™× â€“ ××¡×™×¨×™× ××ª ×”×©×“×•×ª.");
        newContactFields.innerHTML = "";
        newContactFields.style.display = "none";
    }
}

/**
 * ××‘×¦×¢ ×‘×“×™×§×” ××•×˜×•××˜×™×ª ×œ×× ×™×¢×ª ×›×¤×™×œ×•×ª ×©×œ ×× ×©×™ ×§×©×¨ ×‘×˜×•×¤×¡.
 * 
 * ×ª×”×œ×™×š ×”×¢×‘×•×“×”:
 * 1. ×”××©×ª××© ××§×œ×™×“ ×˜×œ×¤×•×Ÿ ××• ×“×•×"×œ ×‘×©×“×” ×”×“×™× ×××™.
 * 2. × ×©×œ×¤×ª ×¨×©×™××ª ×× ×©×™ ×”×§×©×¨ ×”×§×™×™××™× ××ª×•×š ×”-<select id="contactPerson">.
 * 3. ×× × ××¦× ××™×© ×§×©×¨ ×¢× ××•×ª×• ×˜×œ×¤×•×Ÿ / ×“×•×"×œ - ××•×¦×’×ª ×œ××©×ª××© ×”×•×“×¢×ª ××–×”×¨×”.
 * 4. ×× ××™×Ÿ ×›×¤×™×œ×•×ª - ×”××–×”×¨×” ××•×¡×¨×ª.
 */

function checkDuplicateContact() {
    console.log("ğŸ” ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×˜×œ×¤×•×Ÿ ×•×“×•×\"×œ ×”×•×¤×¢×œ×”!");

    let phoneInput = document.getElementById("newContactPhone");
    let emailInput = document.getElementById("newContactEmail");

    let phoneValue = phoneInput ? phoneInput.value.trim() : "";
    let emailValue = emailInput ? emailInput.value.trim() : "";

    let phoneError = document.getElementById("newContactPhoneError");
    let emailError = document.getElementById("newContactEmailError");

    // × ×™×§×•×™ ×”×•×“×¢×•×ª ×§×™×™××•×ª
    phoneError.style.display = "none";
    emailError.style.display = "none";

    // ×©×œ×™×¤×ª ×× ×©×™ ×”×§×©×¨ ×”×§×™×™××™×
    let existingContacts = Array.from(document.querySelectorAll("#contactPerson option"))
        .map(option => ({
            phone: option.dataset.phone ? option.dataset.phone.replace(/\D/g, "") : "",
            email: option.dataset.email ? option.dataset.email.replace(/\s+/g, "").replace(/\u200E/g, "").toLowerCase() : ""
        }))
        .filter(contact => contact.email || contact.phone);

    // × ×™×§×•×™ ×˜×œ×¤×•×Ÿ ×•×“×•×"×œ ××”××©×ª××©
    let cleanPhoneInput = phoneValue.replace(/\D/g, "");
    let cleanEmailInput = emailValue.replace(/\s+/g, "").replace(/\u200E/g, "").toLowerCase(); // × ×™×§×•×™ ×ª×•×•×™× ×œ× ×¨×¦×•×™×™×

    console.log("ğŸ“ ×˜×œ×¤×•×Ÿ ×©× ×‘×“×§:", cleanPhoneInput);
    console.log("ğŸ“§ ×“×•×\"×œ ×©× ×‘×“×§:", cleanEmailInput);

    // ğŸ”¹ ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×˜×œ×¤×•×Ÿ
    let isPhoneDuplicate = existingContacts.some(contact =>
        cleanPhoneInput && contact.phone === cleanPhoneInput
    );

    if (isPhoneDuplicate) {
        console.log("ğŸš¨ ×˜×œ×¤×•×Ÿ ×›×¤×•×œ × ××¦×!");
        phoneError.textContent = "âš ï¸ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×–×” ×›×‘×¨ ×§×™×™×!";
        phoneError.style.display = "block";
        phoneInput.setAttribute("data-duplicate", "true");
    } else {
        phoneInput.setAttribute("data-duplicate", "false");
    }
    console.log(`ğŸ”´ phoneInput data-duplicate ×œ××—×¨ ×¢×“×›×•×Ÿ: ${phoneInput.getAttribute("data-duplicate")}`);

    // ğŸ”¹ ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×“×•×"×œ
    let isEmailDuplicate = existingContacts.some(contact =>
        cleanEmailInput && contact.email === cleanEmailInput
    );

    if (isEmailDuplicate) {
        console.log("ğŸš¨ ×“×•×\"×œ ×›×¤×•×œ × ××¦×!");
        emailError.textContent = "âš ï¸ ×›×ª×•×‘×ª ×“×•×\"×œ ×–×• ×›×‘×¨ ×§×™×™××ª!";
        emailError.style.display = "block";
        emailInput.setAttribute("data-duplicate", "true");
    } else {
        emailInput.setAttribute("data-duplicate", "false");
    }
    console.log(`ğŸ”´ emailInput data-duplicate ×œ××—×¨ ×¢×“×›×•×Ÿ: ${emailInput.getAttribute("data-duplicate")}`);
}


/**
 * ××˜×¤×œ ×‘×›×©×œ ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª.
 * 
 * ×ª×”×œ×™×š ×”×¢×‘×•×“×”:
 * 1. ××¦×™×’ ×”×•×“×¢×ª ×©×’×™××” ×œ××©×ª××©.
 * 2. ×××¤×©×¨ × ×™×¡×™×•×Ÿ ×—×•×–×¨ ×¢×œ ×™×“×™ ×”×¤×¢×œ×ª ×›×¤×ª×•×¨ ×”×©×œ×™×—×” ××—×“×©.
 *
 * @param {Object} error - ×”×•×“×¢×ª ×”×©×’×™××” ×©×—×–×¨×” ××”×©×¨×ª.
 */
function formSubmissionFailure(error) {
    console.error("âŒ ×›×©×œ ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª:", error);

    let statusMessage = document.getElementById("loadingMessage");
    let submitButton = document.getElementById("submitButton");

    statusMessage.innerText = "âŒ ×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª. × ×¡×” ×©×•×‘.";
    submitButton.disabled = false; // ğŸ”„ ×”×¤×¢×œ×ª ×”×›×¤×ª×•×¨ ××—×“×© ×›×“×™ ×œ××¤×©×¨ × ×™×¡×™×•×Ÿ ×—×•×–×¨
}
    </script>
</head>

 <!-- âœ… ×ª×™×‘×ª ×”×˜×•×¤×¡ ×”×¨××©×™×ª -->
    <div class="form-container">
        <h2>×¤×ª×™×—×ª ×¤×¨×•×™×§×˜ ×—×“×©</h2>

        <!-- âœ… ×—×™×•×•×™ ×˜×¢×™× ×” -->
        <div id="loadingMessage" class="loading-message">
            ğŸ”„ ×˜×•×¢×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ
            <span class="spinner"></span>
        </div>

        <!-- âœ… ×©×“×” ×‘×—×™×¨×ª ×œ×§×•×— -->
        <div class="form-group">
            <label>×©× ×œ×§×•×—:</label>
            <input type="text" id="customerName" autocomplete="off">
            <div id="customerSuggestions" class="autocomplete-suggestions"></div>
            <div id="customerError" class="error-message"></div>
        </div>

        <!-- âœ… ××–×”×” ×œ×§×•×— (×œ× × ×™×ª×Ÿ ×œ×¢×¨×™×›×”) -->
        <div class="form-group">
            <label>××–×”×” ×œ×§×•×—:</label>
            <input type="text" id="customerID" readonly>
        </div>
        <!-- âœ… ××§×‘×œ ×¢××œ×” (×§×¨×™××” ×‘×œ×‘×“) -->
        <div class="form-group">
            <label>××§×‘×œ ×¢××œ×”:</label>
            <input type="text" id="commissionRecipient" readonly>
        </div>

        <!-- âœ… ×ª××¨×™×š ×¡×™×•× ×—×•×‘×ª ×¢××œ×” (×§×¨×™××” ×‘×œ×‘×“) -->
        <div class="form-group">
            <label>×ª××¨×™×š ×¡×™×•× ×—×•×‘×ª ×¢××œ×”:</label>
            <input type="text" id="commissionEndDate" readonly>
        </div>

        <!-- âœ… ××—×•×– ×¢××œ×” (×§×¨×™××” ×‘×œ×‘×“) -->
        <div class="form-group">
            <label>××—×•×– ×¢××œ×” (%):</label>
            <input type="number" id="commissionRate" readonly>
        </div>

        <!-- âœ… ×‘×—×™×¨×ª ××™×© ×§×©×¨ -->
        <div class="form-group">
            <label>××™×© ×§×©×¨:</label>
            <select id="contactPerson">
                <option value="">×‘×—×¨ ××™×© ×§×©×¨...</option>
                <option value="new">â• ×”×•×¡×£ ××™×© ×§×©×¨ ×—×“×©</option>
            </select>
            <div id="contactPersonError" class="error-message"></div>
        </div>

        <!-- âœ… ×©×“×•×ª ×“×™× ××™×™× ×œ×”×•×¡×¤×ª ××™×© ×§×©×¨ ×—×“×© -->
        <div id="newContactFields"></div>

        <!-- âœ… ×©×“×” "×©× ×¤×¨×•×™×§×˜" -->
        <div class="form-group">
            <label>×©× ×¤×¨×•×™×§×˜:</label>
            <input type="text" id="projectName" required>
            <div id="projectError" class="error-message"></div>
        </div>

        <!-- âœ… ×ª××¨×™×š ×™×¦×™×¨×” (×œ× × ×™×ª×Ÿ ×œ×¢×¨×™×›×”) -->
        <div class="form-group">
            <label>×ª××¨×™×š ×™×¦×™×¨×”:</label>
            <input type="text" id="creationDate" readonly>
        </div>

        <!-- âœ… ××–×”×” ×¤×¨×•×™×§×˜ (×œ× × ×™×ª×Ÿ ×œ×¢×¨×™×›×”) -->
        <div class="form-group">
            <label>××–×”×” ×¤×¨×•×™×§×˜:</label>
            <input type="text" id="projectID" readonly>
        </div>

        <!-- âœ… ×ª××¨×™×š ×›× ×™×¡×” ×œ××¢×¨×›×ª (×œ× × ×™×ª×Ÿ ×œ×¢×¨×™×›×”) -->
        <div class="form-group">
            <label>×ª××¨×™×š ×›× ×™×¡×” ×œ××¢×¨×›×ª:</label>
            <input type="text" id="entryDate" readonly>
        </div>

        <!-- âœ… ×›×¤×ª×•×¨×™ ×”×˜×•×¤×¡ -->
        <div class="button-container">
            <button id="cancelButton" onclick="google.script.host.close()">×‘×™×˜×•×œ</button>
            <button id="submitButton" type="button" disabled onclick="submitForm()">××™×©×•×¨</button>
        </div>
    </div>

