/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: handleSubmitButtonClick
 *
 * ğŸ¯ ××˜×¨×”:
 * ××•×¤×¢×œ×ª ×‘×¢×ª ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ "××™×©×•×¨".
 * ××‘×¦×¢×ª ×’×œ×™×œ×” ×œ×¨××© ×”×“×£, ××™×¡×•×£ × ×ª×•× ×™ ×”×˜×•×¤×¡ ×œ×¤×™ ×”×¡×›××” ×”×©×˜×•×—×” (`flatFields`) ×©× ×©××¨×” ×‘×§×•× ×˜×§×¡×˜,
 * ×•×©×œ×™×—×ª× ×œ×©×¨×ª ×‘×××¦×¢×•×ª `google.script.run`.
 *
 * ğŸ“Œ ×©×œ×‘×™×:
 * 1ï¸âƒ£ ×’×œ×™×œ×” ×—×œ×§×” ×œ×¨××© ×”×“×£ ×œ×¦×•×¨×š ×—×©×™×¤×ª ×”×•×“×¢×•×ª.
 * 2ï¸âƒ£ ×”×©×”×™×” ×§×¦×¨×” ×œ×× ×™××¦×™×™×ª ×”×’×œ×™×œ×”.
 * 3ï¸âƒ£ × ×™×§×•×™ ×”×•×“×¢×•×ª ×§×•×“××•×ª.
 * 4ï¸âƒ£ ××™×¡×•×£ × ×ª×•× ×™× ××”×˜×•×¤×¡ ×¢×´×™ `collectFormDataFromFlatFields`.
 * 5ï¸âƒ£ ×©×œ×™×—×” ×œ×©×¨×ª ×“×¨×š `sendFormDataToServer`.
 * 6ï¸âƒ£ ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×‘××§×¨×” ×©×œ ×›×©×œ.
 */
function handleSubmitButtonClick() {
  console.log("ğŸŸ¢ [1ï¸âƒ£] ×”×ª×—×œ×ª ×ª×”×œ×™×š ×©×œ×™×—×” â€“ ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ '××™×©×•×¨'");

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ×’×œ×™×œ×” ×œ×¨××© ×”×“×£
  scrollToTop();

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ×”××ª× ×” ×§×¦×¨×” (×œ×× ×™××¦×™×™×ª ×”×’×œ×™×œ×”)
  setTimeout(() => {
    try {
      // ×©×œ×‘ 3ï¸âƒ£ â€“ × ×™×§×•×™ ×”×•×“×¢×•×ª ×§×•×“××•×ª
      hideGlobalErrorMessage();

      // ×©×œ×‘ 4ï¸âƒ£ â€“ ××™×¡×•×£ × ×ª×•× ×™× ××”×˜×•×¤×¡ ×œ×¤×™ ×”×¡×›××” ×”×©×˜×•×—×”
      const formData = collectFormDataFromFlatFields();
      console.log("âœ… [4ï¸âƒ£] × ×ª×•× ×™ ×˜×•×¤×¡ ×©× ××¡×¤×•:", formData);

      // ×©×œ×‘ 5ï¸âƒ£ â€“ ×©×œ×™×—×ª ×”× ×ª×•× ×™× ×œ×©×¨×ª
      sendFormDataToServer(formData);

    } catch (error) {
      // ×©×œ×‘ 6ï¸âƒ£ â€“ ×˜×™×¤×•×œ ×‘×©×’×™××”
      console.error("âŒ [6ï¸âƒ£] ×©×’×™××” ×‘×ª×”×œ×™×š ×©×œ×™×—×ª ×”×˜×•×¤×¡:", error);
      showGlobalErrorMessage("âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×©×œ×™×—×ª ×”×˜×•×¤×¡. × ×¡×” ×©×•×‘.");
    }
  }, 400);
}


/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: scrollToTop
 *
 * ğŸ¯ ××˜×¨×”:
 * ××’×œ×’×œ×ª ××ª ×”××¡×š ×œ×¨××© ×”×“×£ ×‘×¦×•×¨×” ×—×œ×§×” ×›×“×™ ×œ×”×‘×™× ××ª ×”××©×ª××© ×œ×¡×˜×˜×•×¡ ××• ×©×’×™××”.
 *
 * ğŸ“Œ ×©×œ×‘×™×:
 * 1ï¸âƒ£ ×‘×™×¦×•×¢ scroll ×œ×¨××© ×”×¢××•×“ ×¢× ×× ×™××¦×™×” ×—×œ×§×”.
 */
function scrollToTop() {
  console.log("ğŸ”¼ [1ï¸âƒ£] ×’×œ×™×œ×” ×—×œ×§×” ×œ×¨××© ×”×“×£ ××ª×‘×¦×¢×ª...");
  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });
}

/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: collectFormDataFromFlatFields
 *
 * ğŸ¯ ××˜×¨×”:
 * ××•×¡×¤×ª ××ª ×¢×¨×›×™ ×”×©×“×•×ª ×‘×˜×•×¤×¡ ×œ×¤×™ ×”×¡×›××” ×”×©×˜×•×—×” ×©××•×’×“×¨×ª ×‘×§×•× ×˜×§×¡×˜ (FORM_CONTEXT.flatFields).
 * ××—×–×™×¨×” ××•×‘×™×™×§×˜ ×©×œ ××–×”×™ ×©×“×•×ª ×¢× ×”×¢×¨×›×™× ×”××¢×•×‘×“×™×, ×›×•×œ×œ ×”××¨×•×ª ×˜×™×¤×•×¡ ×œ×¤×™ ×”×’×“×¨×ª ×¡×•×’ ×”×©×“×”.
 *
 * ğŸ“Œ ×©×œ×‘×™×:
 * 1ï¸âƒ£ ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×ª×•×¦××” ×¨×™×§.
 * 2ï¸âƒ£ ××¢×‘×¨ ×¢×œ ×›×œ ×”×©×“×•×ª ×‘Ö¾flatFields.
 * 3ï¸âƒ£ ××™×ª×•×¨ ×¨×›×™×‘ DOM ×œ×¤×™ ××–×”×” ×©×“×”.
 * 4ï¸âƒ£ ×©×œ×™×¤×ª ×¢×¨×š ××”×©×“×”.
 * 5ï¸âƒ£ ×”××¨×ª ×¢×¨×š ×œ×¤×™ ×˜×™×¤×•×¡ ×©×“×” (×× × ×“×¨×©).
 * 6ï¸âƒ£ ×©××™×¨×ª ×”×¢×¨×š ×‘××•×‘×™×™×§×˜ ×”×¤×œ×˜.
 * 7ï¸âƒ£ ×”×—×–×¨×ª ×”× ×ª×•× ×™×.
 *
 * @returns {Object} formData â€“ ××•×‘×™×™×§×˜ ×¢× ×¢×¨×›×™× ×©× ××¡×¤×• ×œ×¤×™ ××–×”×™ ×©×“×•×ª.
 */
function collectFormDataFromFlatFields() {
  console.log("ğŸ“‹ [collectFormDataFromFlatFields] â–¶ ×”×ª×—×œ×ª ××™×¡×•×£ × ×ª×•× ×™ ×”×˜×•×¤×¡");

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ×™×¦×™×¨×ª ××‘× ×” × ×ª×•× ×™× ×¨×™×§
  const formData = {};

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ××¢×‘×¨ ×¢×œ ×›×œ ×”×©×“×•×ª ×”×©×˜×•×—×™× ×œ×¤×™ ×”×¡×›××”
  Object.entries(FORM_CONTEXT.flatFields).forEach(([fieldId, fieldDef]) => {
    console.log(`ğŸ” [2ï¸âƒ£] ××™×¡×•×£ ×©×“×”: ${fieldId}`);

    // ×©×œ×‘ 3ï¸âƒ£ â€“ ××™×ª×•×¨ ×¨×›×™×‘ DOM ×œ×¤×™ ID
    const el = document.getElementById(fieldId);
    if (!el) {
      console.warn(`âš ï¸ [3ï¸âƒ£] ×©×“×” '${fieldId}' ×œ× × ××¦× ×‘Ö¾DOM`);
      return;
    }

    // ×©×œ×‘ 4ï¸âƒ£ â€“ ×©×œ×™×¤×ª ×¢×¨×š ×’×•×œ××™ ××”×©×“×”
    let value = el.value?.trim?.() ?? "";
    console.log(`ğŸ“¨ [4ï¸âƒ£] ×¢×¨×š ×’×•×œ××™: "${value}"`);

    // ×©×œ×‘ 5ï¸âƒ£ â€“ ×”××¨×ª ×˜×™×¤×•×¡ ×œ×¤×™ ×¡×•×’ ×©×“×” ××”×¡×›××”
    if (fieldDef.type === "number") {
      value = parseFloat(value) || 0;
    } else if (fieldDef.type === "integer") {
      value = parseInt(value) || 0;
    }

    // ×©×œ×‘ 6ï¸âƒ£ â€“ ×©××™×¨×ª ×”×¢×¨×š ×‘××•×‘×™×™×§×˜ ×”×¤×œ×˜
    formData[fieldId] = value;
    console.log(`ğŸ§¾ [6ï¸âƒ£] ${fieldId} =>`, value);
  });

  // ×©×œ×‘ 7ï¸âƒ£ â€“ ×¡×™×•× ×•×”×—×–×¨×ª ×”×ª×•×¦××”
  console.log("âœ… [7ï¸âƒ£] ××™×¡×•×£ × ×ª×•× ×™× ×”×•×©×œ×:", formData);
  return formData;
}

/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: sendFormDataToServer
 *
 * ğŸ¯ ××˜×¨×”:
 * ×©×•×œ×—×ª ××ª ×”× ×ª×•× ×™× ×©× ××¡×¤×• ××”×˜×•×¤×¡ ×œ×©×¨×ª ×“×¨×š Google Apps Script,
 * ×ª×•×š ×”×¦×’×ª ×—×™×•×•×™ ××§×¦×•×¢×™ (Overlay) ×œ××©×ª××© ×œ××•×¨×š ×›×œ ×ª×”×œ×™×š ×”×©×œ×™×—×”.
 *
 * ğŸ“Œ ×©×œ×‘×™×:
 * 1ï¸âƒ£ ×”×¦×’×ª ×©×›×‘×ª ×˜×¢×™× ×” + ×˜×§×¡×˜ ×©×œ×™×—×”.
 * 2ï¸âƒ£ ××™×ª×•×¨ ×›×¤×ª×•×¨ ×©×œ×™×—×” ×•×”×©×‘×ª×ª×• ×œ×× ×™×¢×ª ×©×œ×™×—×” ×›×¤×•×œ×”.
 * 3ï¸âƒ£ ×©×œ×™×—×ª ×”× ×ª×•× ×™× ×œ×©×¨×ª ×‘×××¦×¢×•×ª google.script.run.
 * 4ï¸âƒ£ ×¨×™×©×•× handlers ×œ×”×¦×œ×—×” ××• ×›×™×©×œ×•×Ÿ.
 *
 * @param {Object} formData - ××•×‘×™×™×§×˜ × ×ª×•× ×™× ×©× ××¡×£ ××”×˜×•×¤×¡
 */
function sendFormDataToServer(formData) {
  console.log("ğŸ“¤ [sendFormDataToServer] â–¶ ×”×ª×—×œ×ª ×ª×”×œ×™×š ×©×œ×™×—×” ×œ×©×¨×ª");

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ×”×¦×’×ª ×©×›×‘×ª ×˜×¢×™× ×” ×¢× ×˜×§×¡×˜ ××ª××™×
  updateLoadingOverlayText("â³ ×©×•×œ×— × ×ª×•× ×™×... ×× × ×”××ª×Ÿ");
  showLoadingOverlay();
  console.log("â³ [1ï¸âƒ£] ×©×›×‘×ª ×˜×¢×™× ×” ×”×•×¤×¢×œ×” â€“ ×©×•×œ×— × ×ª×•× ×™×");

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ×©×œ×™×—×” ×œ×× ×™×¢×ª ×œ×—×™×¦×•×ª ×›×¤×•×œ×•×ª
  const submitButton = document.getElementById("submitButton");
  if (submitButton) {
    submitButton.disabled = true;
    console.log("âœ‹ [2ï¸âƒ£] ×›×¤×ª×•×¨ '××™×©×•×¨' ×”×•×©×‘×ª ×–×× ×™×ª");
  }

  // ×©×œ×‘ 3ï¸âƒ£ â€“ ×©×œ×™×—×” ×‘×¤×•×¢×œ
  google.script.run
    .withSuccessHandler(formSubmissionSuccess)
    .withFailureHandler(formSubmissionFailure)
    .saveCustomerData(formData);

  console.log("ğŸš€ [3ï¸âƒ£] ×§×¨×™××” ×œ-google.script.run ×‘×•×¦×¢×”");
}

/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: formSubmissionSuccess
 *
 * ğŸ¯ ××˜×¨×”:
 * ××•×¤×¢×œ×ª ×›××©×¨ ×”× ×ª×•× ×™× × ×©×œ×—×• ×‘×”×¦×œ×—×” ×œ×©×¨×ª.
 * ××¦×™×’×” ×”×•×“×¢×ª ×”×¦×œ×—×” ×•×¡×•×’×¨×ª ××ª ×”×˜×•×¤×¡ ×œ××—×¨ ×”×©×”×™×”.
 *
 * ğŸ“Œ ×©×œ×‘×™×:
 * 1ï¸âƒ£ ×”×¡×ª×¨×ª ×©×›×‘×ª ×˜×¢×™× ×”.
 * 2ï¸âƒ£ ×‘×“×™×§×ª ×ª×•×¦××” ××”×©×¨×ª.
 * 3ï¸âƒ£ ×‘××§×¨×” ×”×¦×œ×—×” â€“ ×”×¦×’×ª ×”×•×“×¢×” ×•×¡×’×™×¨×”.
 * 4ï¸âƒ£ ×‘××§×¨×” ×›×©×œ â€“ ×©×—×¨×•×¨ ×›×¤×ª×•×¨ ×•×”×¦×’×ª ×”×•×“×¢×ª ×©×’×™××”.
 *
 * @param {string|Object} result - ×ª×•×¦××” ××”×©×¨×ª
 */
function formSubmissionSuccess(result) {
  console.log("ğŸ“© [formSubmissionSuccess] â–¶ ×”×ª×§×‘×œ×” ×ª×©×•×‘×” ××”×©×¨×ª:", result);

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ×”×¡×ª×¨×ª ×©×›×‘×ª ×˜×¢×™× ×”
  hideLoadingOverlay();
  console.log("âœ… [1ï¸âƒ£] ×©×›×‘×ª ×˜×¢×™× ×” ×”×•×¡×¨×”");

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ×‘×“×™×§×” ×× ×”×¦×œ×—×”
  if (result === "success") {
    console.log("ğŸ¯ [2ï¸âƒ£] ×©×œ×™×—×” ×‘×•×¦×¢×” ×‘×”×¦×œ×—×”");

    // ×©×œ×‘ 3ï¸âƒ£ â€“ ×”×¦×’×ª ×”×•×“×¢×ª ×”×¦×œ×—×” ×•×¡×’×™×¨×ª ×˜×•×¤×¡
    showGlobalErrorMessage("âœ… ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”!");
    setTimeout(() => google.script.host.close(), 2000);
  } else {
    console.warn("âš ï¸ [3ï¸âƒ£] ×”×ª×§×‘×œ×” ×ª×•×¦××” ×œ× ×¦×¤×•×™×”:", result);

    const submitButton = document.getElementById("submitButton");
    if (submitButton) submitButton.disabled = false;

    showGlobalErrorMessage("âŒ ×©××™×¨×ª ×”× ×ª×•× ×™× × ×›×©×œ×”. × ×¡×” ×©×•×‘.");
  }
}

/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: formSubmissionFailure
 *
 * ğŸ¯ ××˜×¨×”:
 * ×˜×™×¤×•×œ ×‘×›×©×œ ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª ×‘××”×œ×š ×©×œ×™×—×ª ×˜×•×¤×¡.
 *
 * ğŸ“Œ ×©×œ×‘×™×:
 * 1ï¸âƒ£ ×”×¡×ª×¨×ª ×©×›×‘×ª ×˜×¢×™× ×”.
 * 2ï¸âƒ£ ×¨×™×©×•× ×”×©×’×™××” ×œ×§×•× ×¡×•×œ.
 * 3ï¸âƒ£ ×©×—×¨×•×¨ ×›×¤×ª×•×¨ ×©×œ×™×—×”.
 * 4ï¸âƒ£ ×”×¦×’×ª ×”×•×“×¢×ª ×©×’×™××” ×œ××©×ª××©.
 *
 * @param {Object} error - ××•×‘×™×™×§×˜ ×”×©×’×™××”
 */
function formSubmissionFailure(error) {
  console.error("âŒ [formSubmissionFailure] â–¶ ×›×©×œ ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª:", error);

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ×”×¡×ª×¨×ª ×©×›×‘×ª ×˜×¢×™× ×”
  hideLoadingOverlay();
  console.log("âœ… [1ï¸âƒ£] ×©×›×‘×ª ×˜×¢×™× ×” ×”×•×¡×¨×”");

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ×©×—×¨×•×¨ ×›×¤×ª×•×¨ ×”×©×œ×™×—×”
  const submitButton = document.getElementById("submitButton");
  if (submitButton) submitButton.disabled = false;

  // ×©×œ×‘ 3ï¸âƒ£ â€“ ×”×¦×’×ª ×”×•×“×¢×ª ×©×’×™××” ×œ××©×ª××©
  showGlobalErrorMessage("âŒ ×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª. ×× × × ×¡×” ×©×•×‘.");
}


/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: enableForm
 *
 * ğŸ¯ ××˜×¨×”:
 * ××©×—×¨×¨×ª ××ª ×›×œ ×¨×›×™×‘×™ ×”×˜×•×¤×¡ (input, select, textarea, button) ××”×©×‘×ª×” (`disabled = false`),
 * ×•××– ×‘×•×“×§×ª ×× × ×™×ª×Ÿ ×œ×”×¤×¢×™×œ ××ª ×›×¤×ª×•×¨ "××™×©×•×¨" ×‘×××¦×¢×•×ª `validateForm`.
 *
 * ğŸ“Œ ×©×œ×‘×™×:
 * 1ï¸âƒ£ ××™×ª×•×¨ ×›×œ ×¨×›×™×‘×™ ×”×§×œ×˜ ×‘×˜×•×¤×¡.
 * 2ï¸âƒ£ ×©×—×¨×•×¨ ×›×œ ×¨×›×™×‘ ××”×©×‘×ª×”.
 * 3ï¸âƒ£ ×”×¤×¢×œ×ª ×¤×•× ×§×¦×™×™×ª `validateForm` ×œ×‘×“×™×§×” ×›×œ×œ×™×ª.
 */
function enableForm() {
  console.log("ğŸ”“ [enableForm] â–¶ ×”×ª×—×œ×ª ×©×—×¨×•×¨ ×¨×›×™×‘×™ ×”×˜×•×¤×¡");

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ××™×ª×•×¨ ×›×œ ×¨×›×™×‘×™ ×”×§×œ×˜
  const formElements = document.querySelectorAll("input, select, textarea, button");
  console.log(`ğŸ” [1ï¸âƒ£] × ××¦××• ${formElements.length} ×¨×›×™×‘×™× ×‘×˜×•×¤×¡`);

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ×©×—×¨×•×¨ ×¨×›×™×‘×™× ××”×©×‘×ª×”
  formElements.forEach(el => {
    el.disabled = false;
  });
  console.log("âœ… [2ï¸âƒ£] ×›×œ ×”×¨×›×™×‘×™× ×©×•×—×¨×¨×• ×Ö¾disabled");

  // ×©×œ×‘ 3ï¸âƒ£ â€“ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×›×œ×œ×™×ª
  validateForm();
  console.log("âœ… [3ï¸âƒ£] ×‘×•×¦×¢×” ×‘×“×™×§×ª validateForm");
}

