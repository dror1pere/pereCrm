/**
 * 🧠 פונקציה: handleSubmitButtonClick
 *
 * 🎯 מטרה:
 * מופעלת בעת לחיצה על כפתור "אישור".
 * מבצעת גלילה לראש הדף, איסוף נתוני הטופס לפי הסכמה השטוחה (`flatFields`) שנשמרה בקונטקסט,
 * ושליחתם לשרת באמצעות `google.script.run`.
 *
 * 📌 שלבים:
 * 1️⃣ גלילה חלקה לראש הדף לצורך חשיפת הודעות.
 * 2️⃣ השהיה קצרה לאנימציית הגלילה.
 * 3️⃣ ניקוי הודעות קודמות.
 * 4️⃣ איסוף נתונים מהטופס ע״י `collectFormDataFromFlatFields`.
 * 5️⃣ שליחה לשרת דרך `sendFormDataToServer`.
 * 6️⃣ טיפול בשגיאות במקרה של כשל.
 */
function handleSubmitButtonClick() {
  console.log("🟢 [1️⃣] התחלת תהליך שליחה – לחיצה על כפתור 'אישור'");

  // שלב 1️⃣ – גלילה לראש הדף
  scrollToTop();

  // שלב 2️⃣ – המתנה קצרה (לאנימציית הגלילה)
  setTimeout(() => {
    try {
      // שלב 3️⃣ – ניקוי הודעות קודמות
      hideGlobalErrorMessage();

      // שלב 4️⃣ – איסוף נתונים מהטופס לפי הסכמה השטוחה
      const formData = collectFormDataFromFlatFields();
      console.log("✅ [4️⃣] נתוני טופס שנאספו:", formData);

      // שלב 5️⃣ – שליחת הנתונים לשרת
      sendFormDataToServer(formData);

    } catch (error) {
      // שלב 6️⃣ – טיפול בשגיאה
      console.error("❌ [6️⃣] שגיאה בתהליך שליחת הטופס:", error);
      showGlobalErrorMessage("❌ שגיאה כללית בשליחת הטופס. נסה שוב.");
    }
  }, 400);
}


/**
 * 🧠 פונקציה: scrollToTop
 *
 * 🎯 מטרה:
 * מגלגלת את המסך לראש הדף בצורה חלקה כדי להביא את המשתמש לסטטוס או שגיאה.
 *
 * 📌 שלבים:
 * 1️⃣ ביצוע scroll לראש העמוד עם אנימציה חלקה.
 */
function scrollToTop() {
  console.log("🔼 [1️⃣] גלילה חלקה לראש הדף מתבצעת...");
  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });
}

/**
 * 🧠 פונקציה: collectFormDataFromFlatFields
 *
 * 🎯 מטרה:
 * אוספת את ערכי השדות בטופס לפי הסכמה השטוחה שמוגדרת בקונטקסט (FORM_CONTEXT.flatFields).
 * מחזירה אובייקט של מזהי שדות עם הערכים המעובדים, כולל המרות טיפוס לפי הגדרת סוג השדה.
 *
 * 📌 שלבים:
 * 1️⃣ יצירת אובייקט תוצאה ריק.
 * 2️⃣ מעבר על כל השדות ב־flatFields.
 * 3️⃣ איתור רכיב DOM לפי מזהה שדה.
 * 4️⃣ שליפת ערך מהשדה.
 * 5️⃣ המרת ערך לפי טיפוס שדה (אם נדרש).
 * 6️⃣ שמירת הערך באובייקט הפלט.
 * 7️⃣ החזרת הנתונים.
 *
 * @returns {Object} formData – אובייקט עם ערכים שנאספו לפי מזהי שדות.
 */
function collectFormDataFromFlatFields() {
  console.log("📋 [collectFormDataFromFlatFields] ▶ התחלת איסוף נתוני הטופס");

  // שלב 1️⃣ – יצירת מבנה נתונים ריק
  const formData = {};

  // שלב 2️⃣ – מעבר על כל השדות השטוחים לפי הסכמה
  Object.entries(FORM_CONTEXT.flatFields).forEach(([fieldId, fieldDef]) => {
    console.log(`🔍 [2️⃣] איסוף שדה: ${fieldId}`);

    // שלב 3️⃣ – איתור רכיב DOM לפי ID
    const el = document.getElementById(fieldId);
    if (!el) {
      console.warn(`⚠️ [3️⃣] שדה '${fieldId}' לא נמצא ב־DOM`);
      return;
    }

    // שלב 4️⃣ – שליפת ערך גולמי מהשדה
    let value = el.value?.trim?.() ?? "";
    console.log(`📨 [4️⃣] ערך גולמי: "${value}"`);

    // שלב 5️⃣ – המרת טיפוס לפי סוג שדה מהסכמה
    if (fieldDef.type === "number") {
      value = parseFloat(value) || 0;
    } else if (fieldDef.type === "integer") {
      value = parseInt(value) || 0;
    }

    // שלב 6️⃣ – שמירת הערך באובייקט הפלט
    formData[fieldId] = value;
    console.log(`🧾 [6️⃣] ${fieldId} =>`, value);
  });

  // שלב 7️⃣ – סיום והחזרת התוצאה
  console.log("✅ [7️⃣] איסוף נתונים הושלם:", formData);
  return formData;
}

/**
 * 🧠 פונקציה: sendFormDataToServer
 *
 * 🎯 מטרה:
 * שולחת את הנתונים שנאספו מהטופס לשרת דרך Google Apps Script,
 * תוך הצגת חיווי מקצועי (Overlay) למשתמש לאורך כל תהליך השליחה.
 *
 * 📌 שלבים:
 * 1️⃣ הצגת שכבת טעינה + טקסט שליחה.
 * 2️⃣ איתור כפתור שליחה והשבתתו למניעת שליחה כפולה.
 * 3️⃣ שליחת הנתונים לשרת באמצעות google.script.run.
 * 4️⃣ רישום handlers להצלחה או כישלון.
 *
 * @param {Object} formData - אובייקט נתונים שנאסף מהטופס
 */
function sendFormDataToServer(formData) {
  console.log("📤 [sendFormDataToServer] ▶ התחלת תהליך שליחה לשרת");

  // שלב 1️⃣ – הצגת שכבת טעינה עם טקסט מתאים
  updateLoadingOverlayText("⏳ שולח נתונים... אנא המתן");
  showLoadingOverlay();
  console.log("⏳ [1️⃣] שכבת טעינה הופעלה – שולח נתונים");

  // שלב 2️⃣ – השבתת כפתור שליחה למניעת לחיצות כפולות
  const submitButton = document.getElementById("submitButton");
  if (submitButton) {
    submitButton.disabled = true;
    console.log("✋ [2️⃣] כפתור 'אישור' הושבת זמנית");
  }

  // שלב 3️⃣ – שליחה בפועל
  google.script.run
    .withSuccessHandler(formSubmissionSuccess)
    .withFailureHandler(formSubmissionFailure)
    .saveCustomerData(formData);

  console.log("🚀 [3️⃣] קריאה ל-google.script.run בוצעה");
}

/**
 * 🧠 פונקציה: formSubmissionSuccess
 *
 * 🎯 מטרה:
 * מופעלת כאשר הנתונים נשלחו בהצלחה לשרת.
 * מציגה הודעת הצלחה וסוגרת את הטופס לאחר השהיה.
 *
 * 📌 שלבים:
 * 1️⃣ הסתרת שכבת טעינה.
 * 2️⃣ בדיקת תוצאה מהשרת.
 * 3️⃣ במקרה הצלחה – הצגת הודעה וסגירה.
 * 4️⃣ במקרה כשל – שחרור כפתור והצגת הודעת שגיאה.
 *
 * @param {string|Object} result - תוצאה מהשרת
 */
function formSubmissionSuccess(result) {
  console.log("📩 [formSubmissionSuccess] ▶ התקבלה תשובה מהשרת:", result);

  // שלב 1️⃣ – הסתרת שכבת טעינה
  hideLoadingOverlay();
  console.log("✅ [1️⃣] שכבת טעינה הוסרה");

  // שלב 2️⃣ – בדיקה אם הצלחה
  if (result === "success") {
    console.log("🎯 [2️⃣] שליחה בוצעה בהצלחה");

    // שלב 3️⃣ – הצגת הודעת הצלחה וסגירת טופס
    showGlobalErrorMessage("✅ הנתונים נשמרו בהצלחה!");
    setTimeout(() => google.script.host.close(), 2000);
  } else {
    console.warn("⚠️ [3️⃣] התקבלה תוצאה לא צפויה:", result);

    const submitButton = document.getElementById("submitButton");
    if (submitButton) submitButton.disabled = false;

    showGlobalErrorMessage("❌ שמירת הנתונים נכשלה. נסה שוב.");
  }
}

/**
 * 🧠 פונקציה: formSubmissionFailure
 *
 * 🎯 מטרה:
 * טיפול בכשל בתקשורת עם השרת במהלך שליחת טופס.
 *
 * 📌 שלבים:
 * 1️⃣ הסתרת שכבת טעינה.
 * 2️⃣ רישום השגיאה לקונסול.
 * 3️⃣ שחרור כפתור שליחה.
 * 4️⃣ הצגת הודעת שגיאה למשתמש.
 *
 * @param {Object} error - אובייקט השגיאה
 */
function formSubmissionFailure(error) {
  console.error("❌ [formSubmissionFailure] ▶ כשל בתקשורת עם השרת:", error);

  // שלב 1️⃣ – הסתרת שכבת טעינה
  hideLoadingOverlay();
  console.log("✅ [1️⃣] שכבת טעינה הוסרה");

  // שלב 2️⃣ – שחרור כפתור השליחה
  const submitButton = document.getElementById("submitButton");
  if (submitButton) submitButton.disabled = false;

  // שלב 3️⃣ – הצגת הודעת שגיאה למשתמש
  showGlobalErrorMessage("❌ שגיאה בתקשורת עם השרת. אנא נסה שוב.");
}


/**
 * 🧠 פונקציה: enableForm
 *
 * 🎯 מטרה:
 * משחררת את כל רכיבי הטופס (input, select, textarea, button) מהשבתה (`disabled = false`),
 * ואז בודקת אם ניתן להפעיל את כפתור "אישור" באמצעות `validateForm`.
 *
 * 📌 שלבים:
 * 1️⃣ איתור כל רכיבי הקלט בטופס.
 * 2️⃣ שחרור כל רכיב מהשבתה.
 * 3️⃣ הפעלת פונקציית `validateForm` לבדיקה כללית.
 */
function enableForm() {
  console.log("🔓 [enableForm] ▶ התחלת שחרור רכיבי הטופס");

  // שלב 1️⃣ – איתור כל רכיבי הקלט
  const formElements = document.querySelectorAll("input, select, textarea, button");
  console.log(`🔍 [1️⃣] נמצאו ${formElements.length} רכיבים בטופס`);

  // שלב 2️⃣ – שחרור רכיבים מהשבתה
  formElements.forEach(el => {
    el.disabled = false;
  });
  console.log("✅ [2️⃣] כל הרכיבים שוחררו מ־disabled");

  // שלב 3️⃣ – בדיקת תקינות כללית
  validateForm();
  console.log("✅ [3️⃣] בוצעה בדיקת validateForm");
}

