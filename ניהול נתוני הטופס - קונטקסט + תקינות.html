/**
 * ğŸ§  ××©×ª× ×” ×’×œ×•×‘×œ×™: FORM_CONTEXT
 *
 * ğŸ¯ ××˜×¨×ª ×”××©×ª× ×”:
 * ××•×‘×™×™×§×˜ ××¨×›×–×™ ×œ× ×™×”×•×œ ×›×œ ×”-state ×©×œ ×˜×•×¤×¡ ×“×™× ×××™:
 * × ×ª×•× ×™× ×—×™×¦×•× ×™×™×, ××™×“×¢ ××•×§×“× ××”×©×¨×ª, ××™×“×¢ ×¤× ×™××™, ×•×œ×•×’×™×§×ª ×˜×•×¤×¡.
 *
 * ğŸ“Œ ××‘× ×” ×¤× ×™××™:
 * - validation       : × ×ª×•× ×™× ×œ×‘×“×™×§×” (×›×’×•×Ÿ ×›×¤×™×œ×•×™×•×ª)
 * - dataSources      : ×¨×©×™××•×ª ×ª×œ×•×™×•×ª (×›××• ××§×‘×œ×™ ×¢××œ×”)
 * - preloaded        : ××™×“×¢ ××”×©×¨×ª (×ª××¨×™×š, ××–×”×™×)
 * - formType         : ×©× ×¡×•×’ ×”×˜×•×¤×¡
 * - local            : × ×ª×•× ×™× ××§×•××™×™× ×©××™× × ×¨×œ×•×•× ×˜×™×™× ×œ×˜×¤×¡×™× ××—×¨×™×
 * - schema           : ××•×‘×™×™×§×˜ ×”×¡×›××” ×”××œ××” (×›×•×œ×œ sections)
 * - flatFields       : ××¤×ª ×©×“×•×ª ×©×˜×•×—×” ×œ×¤×™ ××–×”×™ ×©×“×•×ª
 */
const FORM_CONTEXT = {
  validation: {},
  dataSources: {},
  preloaded: {},
  formType: "",
  local: {},
  schema: null,        // âœ³ï¸ × ×˜×¢×Ÿ ×‘-DOMContentLoaded ××ª×•×š ×ª×’×™×ª <script>
  flatFields: {}       // âœ³ï¸ × ×•×¦×¨ ×Ö¾schema ×“×¨×š flattenSchemaToFields
};

/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: flattenSchemaToFields
 *
 * ğŸ¯ ××˜×¨×”:
 * ×”××¨×ª ×¡×›××” ×”×™×¨×¨×›×™×ª (××‘×•×¡×¡×ª sections) ×œ××‘× ×” ×©×˜×•×— ×©×œ ×©×“×•×ª ×œ×¤×™ ××–×”×” ×©×“×” (`id`).
 *
 * âš ï¸ ×”× ×—×” ××•×§×“××ª:
 * ×”×¤×•× ×§×¦×™×” ×× ×™×—×” ×›×™ `FORM_CONTEXT.schema` ×§×™×™× ×•×ª×§×™×Ÿ ×œ×¤× ×™ ×”×§×¨×™××”.
 * ×‘××—×¨×™×•×ª ×”×§×¨×™××” ×œ×•×•×“× ×–××ª. ××™×Ÿ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×¤× ×™××™×ª ×›××Ÿ.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ××¢×‘×¨ ×¢×œ ×›×œ ×”××§×˜×¢×™× (`sections`) ×‘×¡×›××”.
 * 2ï¸âƒ£ ××¢×‘×¨ ×¢×œ ×›×œ `fields` ×‘×›×œ ××§×˜×¢.
 * 3ï¸âƒ£ ×”×•×¡×¤×ª ×›×œ ×©×“×” ×—×•×§×™ (id ×§×™×™×) ×œ××•×‘×™×™×§×˜ ×©×˜×•×—.
 * 4ï¸âƒ£ ×”×—×–×¨×ª ×”××•×‘×™×™×§×˜ ×”×©×˜×•×— ×œ×©×™××•×© ×—×™×¦×•× ×™.
 *
 * @returns {Object} - ××¤×ª ×©×“×•×ª ×©×˜×•×—×” ×œ×¤×™ ××–×”×™ ×©×“×•×ª
 */
function flattenSchemaToFields() {
  console.log("ğŸ“¦ [flattenSchemaToFields] â–¶ ×”×ª×—×œ×ª ×”××¨×ª ×”×¡×›××” ×œ××‘× ×” ×©×˜×•×—");

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ×”×ª×—×œ×”
  const result = {};

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ××¢×‘×¨ ×¢×œ ××§×˜×¢×™×
  FORM_CONTEXT.schema.sections.forEach(section => {
    console.log(`ğŸ” [2ï¸âƒ£] ×¢×™×‘×•×“ ××§×˜×¢: '${section.title}'`);

    // ×©×œ×‘ 3ï¸âƒ£ â€“ ××¢×‘×¨ ×¢×œ ×”×©×“×•×ª ×‘××§×˜×¢
    (section.fields || []).forEach(field => {
      if (field.id) {
        result[field.id] = field;
        console.log(`âœ… [3ï¸âƒ£] ×©×“×” '${field.id}' × ×•×¡×£ ×œ××‘× ×” ×”×©×˜×•×—`);
      } else {
        console.warn("âš ï¸ [3ï¸âƒ£] ×©×“×” ×œ×œ× ××–×”×” (id) â€“ ×“×™×œ×•×’");
      }
    });
  });

  // ×©×œ×‘ 4ï¸âƒ£ â€“ ×”×—×–×¨×ª ×”×ª×•×¦××”
  console.log("ğŸ [flattenSchemaToFields] ×¡×™×•× ×¢×™×‘×•×“ ×”×¡×›××”");
  return result;
}

/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: attachValidatorsFromSchema
 *
 * ğŸ¯ ××˜×¨×”:
 * ×œ×—×‘×¨ ×•×œ×™×“×¦×™×” ×—×™×” ×œ×›×œ ×©×“×” ×‘×˜×•×¤×¡ ×œ×¤×™ ×”×¡×›××”,
 * ×œ×”×©×‘×™×ª ×–×× ×™×ª ××ª ×›×¤×ª×•×¨ ×”×©×œ×™×—×” ×‘×¢×ª ×©×™× ×•×™ ×‘×©×“×” ×—×•×‘×”,
 * ×œ×©××•×¨ ×¢×œ ×”×•×“×¢×•×ª ×©×’×™××” ×‘×¦×•×¨×” ×—×›××”,
 * ×•×œ×”×‘×˜×™×— ×’×œ×™×œ×” ×—×›××” ×œ×©×“×” ×”×‘× ×‘×¢×ª ××¢×‘×¨.
 *
 * âš ï¸ ×”× ×—×•×ª ××•×§×“××•×ª:
 * - `FORM_CONTEXT.flatFields` ×§×™×™× ×•×ª×§×™×Ÿ ×œ×¤× ×™ ×§×¨×™××” ×œ×¤×•× ×§×¦×™×”.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×˜×¢×™× ×ª ×©×“×•×ª ××ª×•×š `FORM_CONTEXT.flatFields`.
 * 2ï¸âƒ£ ××¢×‘×¨ ×¢×œ ×›×œ ×©×“×” ×§×œ×˜.
 * 3ï¸âƒ£ ×“×™×œ×•×’ ×¢×œ ×©×“×•×ª ××¡×•×’ ×›×¤×ª×•×¨.
 * 4ï¸âƒ£ ×‘× ×™×™×ª ×•×œ×™×“×˜×•×¨×™× ×œ×›×œ ×©×“×”.
 * 5ï¸âƒ£ ×—×™×‘×•×¨ ×××–×™× ×™ input, blur ×•-focus:
 *    - input: ×•×œ×™×“×¦×™×” ××§×•××™×ª ×‘×œ×‘×“ + ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ×–×× ×™×ª ×× ×—×•×‘×”.
 *    - blur: ×•×œ×™×“×¦×™×” ××§×•××™×ª + ×‘×“×™×§×” ×›×œ×œ×™×ª.
 *    - focus: × ×™×§×•×™ ×”×•×“×¢×ª ×©×’×™××” ×× ×”×©×“×” ×ª×§×™×Ÿ + ×’×œ×™×œ×” ×—×›××”.
 */
function attachValidatorsFromSchema() {
  console.log("ğŸ› ï¸ [attachValidatorsFromSchema] â–¶ ×”×ª×—×œ×ª ×—×™×‘×•×¨ ×”×•×œ×™×“×¦×™×” ××”×¡×›××”");

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ×˜×¢×™× ×ª ×©×“×•×ª ×©×˜×•×—×™× ××”×§×•× ×˜×§×¡×˜
  const flatFields = FORM_CONTEXT.flatFields;

  if (!flatFields || typeof flatFields !== "object") {
    console.error("âŒ [1ï¸âƒ£] flatFields ×œ× ×§×™×™× ××• ×œ× ×ª×§×™×Ÿ ×‘×§×•× ×˜×§×¡×˜");
    return;
  }

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ××¢×‘×¨ ×¢×œ ×›×œ ×”×©×“×•×ª
  Object.entries(flatFields).forEach(([fieldId, fieldSchema]) => {
    console.log(`ğŸ” [2ï¸âƒ£] ×˜×™×¤×•×œ ×‘×©×“×”: '${fieldId}'`);

    // ×©×œ×‘ 3ï¸âƒ£ â€“ ×“×™×œ×•×’ ×¢×œ ×©×“×•×ª ××¡×•×’ ×›×¤×ª×•×¨
    const isButtonType = typeof fieldSchema.type === "string" && fieldSchema.type.includes("button");
    if (isButtonType) {
      console.log(`â„¹ï¸ [3ï¸âƒ£] ×“×™×œ×•×’ ×¢×œ ×©×“×” ×›×¤×ª×•×¨ '${fieldId}'`);
      return;
    }

    // ×©×œ×‘ 4ï¸âƒ£ â€“ ××™×ª×•×¨ ××œ×× ×˜ ×§×œ×˜ ×•××œ×× ×˜ ×”×•×“×¢×ª ×©×’×™××”
    const field = document.getElementById(fieldId);
    const errorContainer = document.querySelector(`[data-error-for="${fieldId}"]`);
    if (!field) {
      console.warn(`âš ï¸ [4ï¸âƒ£] ×”×©×“×” '${fieldId}' ×œ× × ××¦× ×‘Ö¾DOM`);
      return;
    }

    // ×©×œ×‘ 5ï¸âƒ£ â€“ ×‘× ×™×™×ª ×”×•×œ×™×“×˜×•×¨×™×
    const validators = buildValidators(fieldSchema);
    if (!validators.length) {
      console.log(`â„¹ï¸ [5ï¸âƒ£] ××™×Ÿ ×”×•×œ×™×“×˜×•×¨×™× ×œ×©×“×” '${fieldId}'`);
      return;
    }

    // ×©×œ×‘ 6ï¸âƒ£ â€“ ×—×™×‘×•×¨ ×××–×™× ×™×

    // ğŸ–Šï¸ input â€“ ×•×œ×™×“×¦×™×” ××§×•××™×ª ×‘×œ×‘×“ + ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ×–×× ×™×ª ×× ××“×•×‘×¨ ×‘×©×“×” ×—×•×‘×”
    field.addEventListener("input", () => {
      const result = runValidators(field.value, validators);
      updateFieldUI(result, field, errorContainer);

      if (fieldSchema.required) {
        temporarilyDisableSubmitButton();
      }
    });

    // ğŸ” blur â€“ ×•×œ×™×“×¦×™×” ××§×•××™×ª + ×‘×“×™×§×” ×›×œ×œ×™×ª ×œ×›×œ ×”×˜×•×¤×¡
    field.addEventListener("blur", () => {
      const result = runValidators(field.value, validators);
      updateFieldUI(result, field, errorContainer);

      if (!result.valid) {
        field.focus();
      }

      validateRequiredFieldsAndToggleSubmitButton();
    });

    // ğŸ¯ focus â€“ × ×™×§×•×™ ×”×•×“×¢×ª ×©×’×™××” ×× ×”×©×“×” ×ª×§×™×Ÿ + ×’×œ×™×œ×” ×—×›××”
    field.addEventListener("focus", () => {
      const currentValue = field.value?.trim() ?? "";
      const currentValidators = buildValidators(fieldSchema);
      const result = runValidators(currentValue, currentValidators);

      if (result.valid) {
        clearFieldError(field.id);
        console.log(`âœ… [focus] ×©×“×” '${fieldId}' ×ª×§×™×Ÿ â€“ ×”×•×“×¢×ª ×©×’×™××” × ××—×§×”`);
      } else {
        console.log(`âš ï¸ [focus] ×©×“×” '${fieldId}' ×œ× ×ª×§×™×Ÿ â€“ ×”×•×“×¢×ª ×©×’×™××” × ×©××¨×ª ××•×¦×’×ª`);
      }

      // ğŸŒ€ ×’×œ×™×œ×” ×—×›××” ×œ×©×“×”
      scrollFieldIntoView(field);
    });

    console.log(`âœ… [attachValidatorsFromSchema] ×××–×™× ×™× ×—×•×‘×¨×• ×œ×©×“×” '${fieldId}'`);
  });

  console.log("âœ… [attachValidatorsFromSchema] ×¡×™×•× ×—×™×‘×•×¨ ×”×•×œ×™×“×¦×™×” ×œ×›×œ ×”×©×“×•×ª");
}


/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: buildValidators
 *
 * ğŸ¯ ××˜×¨×”:
 * ×‘× ×™×™×ª ××¢×¨×š ×”×•×œ×™×“×˜×•×¨×™× (×‘×“×™×§×•×ª) ×œ×¤×™ ×”×”×’×“×¨×•×ª ×©×œ ×©×“×” ×™×—×™×“ ××ª×•×š ×”×¡×›××” ×©×˜×•×—×”.
 * ×ª×•××›×ª ×‘×¡×•×’×™ ×•×œ×™×“×¦×™×”: required, minLength, regex, unique.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×”×ª×—×œ×ª ××¢×¨×š ×”×•×œ×™×“×˜×•×¨×™× ×¨×™×§.
 * 2ï¸âƒ£ ×”×•×¡×¤×ª ×•×œ×™×“×¦×™×” ×—×•×‘×” ×× × ×“×¨×© (required).
 * 3ï¸âƒ£ ××¢×‘×¨ ×¢×œ ×•×œ×™×“×˜×•×¨×™× × ×•×¡×¤×™× ×©×”×•×’×“×¨×• ×œ×©×“×”.
 * 4ï¸âƒ£ ×”×•×¡×¤×ª ×”×•×œ×™×“×˜×•×¨×™× ××¡×•×’ minLength / regex / unique.
 * 5ï¸âƒ£ ×”×—×–×¨×ª ×”××¢×¨×š ×”××•×›×Ÿ.
 *
 * @param {Object} fieldSchema - ××•×‘×™×™×§×˜ ×©×œ ×©×“×” ×™×—×™×“ ××ª×•×š ×¡×›××” ×©×˜×•×—×”
 * @returns {Array<Object>} - ××¢×¨×š ×”×•×œ×™×“×˜×•×¨×™× ×œ×©×“×”
 */
function buildValidators(fieldSchema) {
  console.log(`ğŸ§ª [buildValidators] â–¶ ×”×ª×—×œ×ª ×‘× ×™×™×ª ×”×•×œ×™×“×˜×•×¨×™× ×œ×©×“×” '${fieldSchema.id}'`);

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ×”×ª×—×œ×ª ××¢×¨×š ×”×•×œ×™×“×˜×•×¨×™×
  const validators = [];

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ×”×•×¡×¤×ª ×—×•×‘×” ×× ×§×™×™× required
  if (fieldSchema.required) {
    validators.push({
      type: "required",
      validate: val => val.trim() !== "",
      message: "×©×“×” ×—×•×‘×”"
    });
    console.log(`â• [2ï¸âƒ£] ×”×•×œ×™×“×¦×™×” required × ×•×¡×¤×”`);
  }

  // ×©×œ×‘ 3ï¸âƒ£ â€“ ××¢×‘×¨ ×¢×œ ×•×œ×™×“×˜×•×¨×™× × ×•×¡×¤×™×
  (fieldSchema.validators || []).forEach(rule => {
    switch (rule.type) {
      case "minLength":
        validators.push({
          type: "minLength",
          validate: val => val.trim().length >= rule.value,
          message: rule.message || `×™×© ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª ${rule.value} ×ª×•×•×™×`
        });
        console.log(`â• [3ï¸âƒ£] ×”×•×œ×™×“×¦×™×” minLength (${rule.value}) × ×•×¡×¤×”`);
        break;

      case "regex":
        validators.push({
          type: "regex",
          validate: val => new RegExp(rule.value).test(val),
          message: rule.message || "×”×¢×¨×š ××™× ×• ×ª×•×× ×œ×ª×‘× ×™×ª ×”× ×“×¨×©×ª"
        });
        console.log(`â• [3ï¸âƒ£] ×”×•×œ×™×“×¦×™×” regex (${rule.value}) × ×•×¡×¤×”`);
        break;

      case "unique":
        const list = FORM_CONTEXT.validation?.[rule.list];
        if (!Array.isArray(list)) {
          console.warn(`âš ï¸ [3ï¸âƒ£] ×¨×©×™××ª unique '${rule.list}' ××™× ×” ×ª×§×™× ×”`);
          break;
        }
        validators.push({
          type: "unique",
          validate: val => !list.map(x => x.toLowerCase()).includes(val.trim().toLowerCase()),
          message: rule.message || "×”×¢×¨×š ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª"
        });
        console.log(`â• [3ï¸âƒ£] ×”×•×œ×™×“×¦×™×” unique ××•×œ ×¨×©×™××” '${rule.list}' × ×•×¡×¤×”`);
        break;
    }
  });

  // ×©×œ×‘ 5ï¸âƒ£ â€“ ×¡×™×•×
  console.log(`âœ… [buildValidators] × ×‘× ×• ${validators.length} ×”×•×œ×™×“×˜×•×¨×™× ×œ×©×“×” '${fieldSchema.id}'`);
  return validators;
}

/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: runValidators
 *
 * ğŸ¯ ××˜×¨×”:
 * ×œ×”×¨×™×¥ ××ª ×›×œ ×”×•×œ×™×“×˜×•×¨×™× ×©×œ ×©×“×” ××—×“, ×œ×¤×™ ×¡×“×¨×, ×•×œ×”×—×–×™×¨ ××ª ×ª×•×¦××ª ×”×‘×“×™×§×”:
 * ×”×× ×”×¢×¨×š ×ª×§×™×Ÿ? ×•×× ×œ× â€“ ××™×–×• ×”×•×“×¢×ª ×©×’×™××” ×œ×”×¦×™×’.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×§×‘×œ×ª ×¢×¨×š ×œ×‘×“×™×§×” ×•××¢×¨×š ×”×•×œ×™×“×˜×•×¨×™×.
 * 2ï¸âƒ£ ××¢×‘×¨ ×¢×œ ×›×œ ×”×•×œ×™×“×˜×•×¨ ×‘×¨×©×™××”.
 * 3ï¸âƒ£ ×‘×“×™×§×” ××•×œ ×¤×•× ×§×¦×™×™×ª validate ×©×œ ×›×œ ×”×•×œ×™×“×˜×•×¨.
 * 4ï¸âƒ£ ×¢×¦×™×¨×” ×¢×œ ×”×”×•×œ×™×“×˜×•×¨ ×”×¨××©×•×Ÿ ×©× ×›×©×œ.
 * 5ï¸âƒ£ ×”×—×–×¨×ª ×ª×•×¦××” ××ª××™××”: { valid: true/false, message: string|null }
 *
 * @param {string} value - ×”×¢×¨×š ×©×œ ×”×©×“×” ×œ×‘×“×™×§×” (×‘×“×¨×š ×›×œ×œ field.value)
 * @param {Array<Object>} validators - ××¢×¨×š ×”×•×œ×™×“×˜×•×¨×™× ×©×”×•×›× ×• ××¨××© ×¢"×™ buildValidators
 * @returns {Object} - ××•×‘×™×™×§×˜ ×ª×•×¦××”: { valid: boolean, message: string|null }
 */
function runValidators(value, validators) {
  console.log("ğŸ” [runValidators] â–¶ ×”×ª×—×œ×ª ×”×¨×¦×ª ×•×œ×™×“×¦×™×” ×¢×œ ×¢×¨×š:", value);

  try {
    // ×©×œ×‘ 1ï¸âƒ£ â€“ × ×™×§×•×™ ×”×¢×¨×š
    const inputValue = value.trim();

    // ×©×œ×‘ 2ï¸âƒ£ â€“ ××¢×‘×¨ ×¢×œ ×”×•×œ×™×“×˜×•×¨×™×
    for (let validator of validators) {
      // ×©×œ×‘ 3ï¸âƒ£ â€“ ×”×¨×¦×ª ×¤×•× ×§×¦×™×™×ª ×‘×“×™×§×”
      const passed = validator.validate(inputValue);

      // ×©×œ×‘ 4ï¸âƒ£ â€“ ×¢×¦×™×¨×” ×× ×”×‘×“×™×§×” × ×›×©×œ×”
      if (!passed) {
        console.warn(`âŒ [runValidators] ×›×©×œ ×‘×•×•×œ×™×“×˜×•×¨: '${validator.type}' â€“ ${validator.message}`);
        return { valid: false, message: validator.message };
      }
    }

    // ×©×œ×‘ 5ï¸âƒ£ â€“ ×× ×¢×‘×¨ ××ª ×›×œ ×”×‘×“×™×§×•×ª
    console.log("âœ… [runValidators] ×”×¢×¨×š ×¢×‘×¨ ××ª ×›×œ ×”×•×œ×™×“×˜×•×¨×™× ×‘×”×¦×œ×—×”");
    return { valid: true, message: null };

  } catch (error) {
    console.error("âŒ [runValidators] ×©×’×™××” ×‘×œ×ª×™ ×¦×¤×•×™×” ×‘×”×¨×¦×ª ×•×œ×™×“×¦×™×”:", error);
    return { valid: false, message: "×©×’×™××” ×œ× ×¦×¤×•×™×” ×‘×‘×“×™×§×ª ×©×“×”" };
  }
}

/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: updateFieldUI
 *
 * ğŸ¯ ××˜×¨×”:
 * ×œ×¢×“×›×Ÿ ××ª ×ª×¦×•×’×ª ×”×©×’×™××” ×©×œ ×©×“×” ×‘×”×ª×× ×œ×ª×•×¦××ª ×”×•×œ×™×“×¦×™×”:
 * ×œ×”×¦×™×’ ×”×•×“×¢×” ×‘××§×¨×” ×©×œ ×›×©×œ, ××• ×œ×”×¡×™×¨ ×”×•×“×¢×” ×‘××§×¨×” ×©×œ ×”×¦×œ×—×”.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×§×‘×œ×ª ×ª×•×¦××ª ×”×•×œ×™×“×¦×™×”, ××œ×× ×˜ ×”×©×“×”, ×•××œ×× ×˜ ×”×©×’×™××”.
 * 2ï¸âƒ£ ×× ×”×ª×•×¦××” ××™× ×” ×ª×§×™× ×” â€“ ×”×¦×’×ª ×”×•×“×¢×ª ×©×’×™××”.
 * 3ï¸âƒ£ ×× ×”×ª×•×¦××” ×ª×§×™× ×” â€“ ×”×¡×¨×ª ×›×œ ×”×•×“×¢×ª ×©×’×™××” ×§×™×™××ª.
 * 4ï¸âƒ£ ×œ×•×’×™× ×‘×”×ª×× ×œ×ª×•×¦××”.
 *
 * @param {Object} result - ×ª×•×¦××ª ×”×•×œ×™×“×¦×™×” (××‘× ×”: { valid: boolean, message: string|null })
 * @param {HTMLElement} field - ××œ×× ×˜ ×”×©×“×” ×‘Ö¾DOM (input / select / textarea)
 * @param {HTMLElement} errorContainer - ××œ×× ×˜ DOM ×©××™×•×¢×“ ×œ×”×¦×™×’ ×©×’×™××”
 */
function updateFieldUI(result, field, errorContainer) {
  console.log(`ğŸ¨ [updateFieldUI] â–¶ ×”×ª×—×œ×ª ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×©×“×” '${field.id}'`);

  try {
    // ×©×œ×‘ 1ï¸âƒ£ â€“ ×‘×“×™×§×” ×× ×™×© ×›×©×œ ×‘×•×•×œ×™×“×¦×™×”
    if (!result.valid) {
      console.warn(`âš ï¸ [updateFieldUI] ×©×“×” '${field.id}' ×œ× ×ª×§×™×Ÿ â€“ ××¦×™×’ ×”×•×“×¢×ª ×©×’×™××”: ${result.message}`);
      showFieldError(field.id, result.message);
    } else {
      // ×©×œ×‘ 2ï¸âƒ£ â€“ ×‘××§×¨×” ×©×œ ×”×¦×œ×—×” â€“ ×”×¡×¨×ª ×”×•×“×¢×•×ª ×©×’×™××”
      clearFieldError(field.id);
      console.log(`âœ… [updateFieldUI] ×©×“×” '${field.id}' ×ª×§×™×Ÿ â€“ ×”×•×“×¢×ª ×©×’×™××” ×”×•×¡×¨×”`);
    }
  } catch (error) {
    console.error(`âŒ [updateFieldUI] ×©×’×™××” ×‘×¢×“×›×•×Ÿ UI ×œ×©×“×” '${field.id}':`, error);
  }
}

/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: validateRequiredFieldsAndToggleSubmitButton
 *
 * ğŸ¯ ××˜×¨×”:
 * ×œ×‘×“×•×§ ×”×× ×›×œ ×©×“×•×ª ×”×—×•×‘×” ××•×œ××•, ×•×œ×”×¤×¢×™×œ ××ª ×›×¤×ª×•×¨ ×”××™×©×•×¨ ×× ×›×Ÿ.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×˜×¢×™× ×ª ××¤×ª ×”×©×“×•×ª.
 * 2ï¸âƒ£ ×¡×™× ×•×Ÿ ×©×“×•×ª ×—×•×‘×” ×‘×œ×‘×“.
 * 3ï¸âƒ£ ×‘×“×™×§×” ×× ×›×œ ×©×“×” ×—×•×‘×” ××•×œ×.
 * 4ï¸âƒ£ ×”×¤×¢×œ×ª ××• ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ×”××™×©×•×¨.
 */
function validateRequiredFieldsAndToggleSubmitButton() {
  console.log("ğŸ” [validateRequiredFieldsAndToggleSubmitButton] â–¶ ×”×ª×—×œ×ª ×‘×“×™×§×ª ×©×“×•×ª ×—×•×‘×”");

  try {
    const flatFields = FORM_CONTEXT.flatFields;
    if (!flatFields || typeof flatFields !== "object") {
      console.error("âŒ [1ï¸âƒ£] flatFields ×œ× ×§×™×™× ××• ×œ× ×ª×§×™×Ÿ ×‘×§×•× ×˜×§×¡×˜");
      return;
    }

    const requiredFields = Object.entries(flatFields).filter(
      ([_, def]) => def.required === true
    );

    console.log(`ğŸ“‹ [2ï¸âƒ£] × ××¦××• ${requiredFields.length} ×©×“×•×ª ×—×•×‘×” ×œ×‘×“×™×§×”`);

    const allRequiredValid = requiredFields.every(([fieldId, _]) => {
      const el = document.getElementById(fieldId);
      if (!el) {
        console.warn(`âš ï¸ [3ï¸âƒ£] ×©×“×” '${fieldId}' ×œ× × ××¦× ×‘Ö¾DOM`);
        return true; // ×“×™×œ×•×’ ×¢×œ ×©×“×•×ª ×©×œ× ×§×™×™××™×
      }
      const value = el.value?.trim() ?? "";
      const isValid = value !== "";
      console.log(`ğŸ” [3ï¸âƒ£] ×©×“×” '${fieldId}': ${isValid ? "âœ”ï¸ ××œ×" : "âŒ ×¨×™×§"}`);
      return isValid;
    });

    const submitButton = document.getElementById("submitButton");
    if (submitButton) {
      submitButton.disabled = !allRequiredValid;
      console.log(`ğŸ” [4ï¸âƒ£] ×›×¤×ª×•×¨ ××™×©×•×¨ ${allRequiredValid ? "×”×•×¤×¢×œ" : "×”×•×©×‘×ª"}`);
    } else {
      console.warn("âš ï¸ [4ï¸âƒ£] ×›×¤×ª×•×¨ 'submitButton' ×œ× × ××¦× ×‘Ö¾DOM");
    }

  } catch (error) {
    console.error("âŒ [validateRequiredFieldsAndToggleSubmitButton] ×©×’×™××”:", error);
  }
}
/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: temporarilyDisableSubmitButton
 *
 * ğŸ¯ ××˜×¨×”:
 * ×œ×”×©×‘×™×ª ×–×× ×™×ª ××ª ×›×¤×ª×•×¨ ×”×©×œ×™×—×” (Submit) ×›××©×¨ ××ª×‘×¦×¢ ×©×™× ×•×™ ×‘×©×“×” ×—×•×‘×”,
 * ×¢×“ ××©×¨ ×™×•×©×œ× ××™×œ×•×™ ×ª×§×™×Ÿ ×•×™××•×©×¨ ×‘×‘×“×™×§×” ×›×œ×œ×™×ª.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ××™×ª×•×¨ ×›×¤×ª×•×¨ ×”××™×©×•×¨ ×œ×¤×™ ××–×”×”.
 * 2ï¸âƒ£ ×”×©×‘×ª×ª ×”×›×¤×ª×•×¨ (disabled = true).
 * 3ï¸âƒ£ ×”×“×¤×¡×ª ×œ×•×’ ×œ×¤×¢×•×œ×”.
 */
function temporarilyDisableSubmitButton() {
  console.log("ğŸš« [temporarilyDisableSubmitButton] â–¶ ×”×ª×—×œ×ª ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ××™×©×•×¨ ×–×× ×™×ª");

  try {
    const submitButton = document.getElementById("submitButton");
    if (!submitButton) {
      console.warn("âš ï¸ [temporarilyDisableSubmitButton] ×›×¤×ª×•×¨ Submit ×œ× × ××¦× ×‘Ö¾DOM");
      return;
    }

    submitButton.disabled = true;
    console.log("âœ… [temporarilyDisableSubmitButton] ×›×¤×ª×•×¨ Submit ×”×•×©×‘×ª ×‘×”×¦×œ×—×”");

  } catch (error) {
    console.error("âŒ [temporarilyDisableSubmitButton] ×©×’×™××” ×‘×”×©×‘×ª×ª ×›×¤×ª×•×¨:", error);
  }
}
/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: scrollFieldIntoView
 *
 * ğŸ¯ ××˜×¨×”:
 * ×œ×’×œ×•×œ ×©×“×” ×œ×¤×•×§×•×¡ ×¨×§ ×× ×”×•× ××—×•×¥ ×œ×˜×•×•×— ×”×’×œ×•×™ ×©×œ ×§×•× ×˜×™×™× ×¨ ×”×˜×•×¤×¡ (form-container),
 * ×•×œ××§× ××•×ª×• ×‘××•×¤×Ÿ × ×¢×™× ×‘×¢×™×Ÿ â€“ ××‘×œ×™ ×œ×¤×’×•×¢ ×‘×¨××© ×”×˜×•×¤×¡ ××• ×œ×’×¨×•× ×œ×§×¤×™×¦×•×ª.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×‘×“×™×§×” ×©×”××œ×× ×˜ ×§×™×™× ×•×ª×§×™×Ÿ.
 * 2ï¸âƒ£ ××™×ª×•×¨ ×§×•× ×˜×™×™× ×¨ ×”×˜×•×¤×¡ (form-container).
 * 3ï¸âƒ£ ×—×™×©×•×‘ ×’×‘×•×œ×•×ª ×•×™×–×•××œ×™×™× ×©×œ ×”×©×“×” ×‘×™×—×¡ ×œ×§×•× ×˜×™×™× ×¨.
 * 4ï¸âƒ£ ×‘×“×™×§×” ×× ×”×©×“×” × ××¦× ××¢×œ ××• ××ª×—×ª ×œ×’×‘×•×œ×•×ª ×”×’×œ×•×™×™×.
 * 5ï¸âƒ£ ×’×œ×™×œ×” ×¨×§ ×× × ×“×¨×©, ×›×•×œ×œ ××¨×—×§ ×‘×˜×•×— ××œ××¢×œ×”.
 *
 * @param {HTMLElement} element - ×©×“×” ×©× ×›× ×¡ ×œ×¤×•×§×•×¡
 */
function scrollFieldIntoView(element) {
  console.log("ğŸŒ€ [scrollFieldIntoView] â–¶ ×”×ª×—×œ×ª ×’×œ×™×œ×” ×—×›××” ×œ×©×“×”");

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ×‘×“×™×§×” ×¨××©×•× ×™×ª
  if (!element) {
    console.warn("âš ï¸ [1ï¸âƒ£] ××œ×× ×˜ ×œ× ×¡×•×¤×§ ×œ×¤×•× ×§×¦×™×” â€“ ××™×Ÿ ××” ×œ×’×œ×•×œ");
    return;
  }

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ××™×ª×•×¨ ×§×•× ×˜×™×™× ×¨
  const container = document.getElementById("form-container");
  if (!container) {
    console.error("âŒ [2ï¸âƒ£] ×§×•× ×˜×™×™× ×¨ form-container ×œ× × ××¦× ×‘Ö¾DOM");
    return;
  }

  // ×©×œ×‘ 3ï¸âƒ£ â€“ ×—×™×©×•×‘ ×’×‘×•×œ×•×ª
  const elementRect = element.getBoundingClientRect();
  const containerRect = container.getBoundingClientRect();

  const elementTopInView = elementRect.top >= containerRect.top;
  const elementBottomInView = elementRect.bottom <= containerRect.bottom;

  console.log(`ğŸ” [3ï¸âƒ£] ×©×“×” '${element.id}' ×‘×ª×•×š ×”×˜×•×•×—?`, elementTopInView && elementBottomInView);

  // ×©×œ×‘ 4ï¸âƒ£ â€“ ×¨×§ ×× ×”×©×“×” ××—×•×¥ ×œ×˜×•×•×—
  if (!elementTopInView || !elementBottomInView) {
    const offsetTop = elementRect.top - containerRect.top + container.scrollTop;

    console.log(`ğŸŒ€ [4ï¸âƒ£] ××‘×¦×¢ ×’×œ×™×œ×” ×œ×©×“×” '${element.id}' (offsetTop=${offsetTop})`);

    // ×©×œ×‘ 5ï¸âƒ£ â€“ ×’×œ×™×œ×” ×¢× ××¨×•×•×— × ×¢×™× ××œ××¢×œ×”
    container.scrollTo({
      top: offsetTop - 80,
      behavior: "smooth"
    });
  } else {
    console.log(`âœ… [4ï¸âƒ£] ×”×©×“×” '${element.id}' ×›×‘×¨ ×‘×˜×•×•×— ×”× ×¨××” â€“ ×œ× × ×“×¨×©×ª ×’×œ×™×œ×”`);
  }
}
/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: scrollToTop
 *
 * ğŸ¯ ××˜×¨×”:
 * ××‘×¦×¢×ª ×’×œ×™×œ×” ×—×œ×§×” ×œ×ª×—×™×œ×ª ×”×˜×•×¤×¡ ×‘×ª×•×š ×”×§×•× ×˜×™×™× ×¨ ×”×¨××©×™.
 * ×××¤×©×¨×ª ×œ××©×ª××© ×œ×—×–×•×¨ ×‘××”×™×¨×•×ª ×œ×¨××© ×”××¡××š.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ××™×ª×•×¨ ×§×•× ×˜×™×™× ×¨ ×”×˜×•×¤×¡ ×œ×¤×™ ××–×”×” (form-container).
 * 2ï¸âƒ£ ×‘×“×™×§×” ×”×× ×”×§×•× ×˜×™×™× ×¨ ×§×™×™×.
 * 3ï¸âƒ£ ×‘×™×¦×•×¢ ×’×œ×™×œ×” ×œÖ¾scrollTop=0 ×¢× ×”×ª× ×”×’×•×ª ×—×œ×§×”.
 * 4ï¸âƒ£ ×¨×™×©×•× ×œ×•×’×™× ×œ××•×¨×š ×”×¤×¢×•×œ×”.
 */
function scrollToTop() {
  console.log("ğŸ”¼ [scrollToTop] â–¶ ×”×ª×—×œ×ª ×’×œ×™×œ×” ×œ×¨××© ×”×˜×•×¤×¡");

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ××™×ª×•×¨ ×”×§×•× ×˜×™×™× ×¨
  const container = document.getElementById("form-container");

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ×‘×“×™×§×ª ×§×™×•×
  if (!container) {
    console.error("âŒ [scrollToTop] ×§×•× ×˜×™×™× ×¨ 'form-container' ×œ× × ××¦×");
    return;
  }

  // ×©×œ×‘ 3ï¸âƒ£ â€“ ×‘×™×¦×•×¢ ×”×’×œ×™×œ×”
  container.scrollTo({
    top: 0,
    behavior: "smooth"
  });

  // ×©×œ×‘ 4ï¸âƒ£ â€“ ×œ×•×’ ×¡×™×•×
  console.log("âœ… [scrollToTop] ×’×œ×™×œ×” ×œ×¨××© ×”×•×©×œ××” ×‘×”×¦×œ×—×”");
}
/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: scrollToBottom
 *
 * ğŸ¯ ××˜×¨×”:
 * ××‘×¦×¢×ª ×’×œ×™×œ×” ×—×œ×§×” ×œ×ª×—×ª×™×ª ×§×•× ×˜×™×™× ×¨ ×”×˜×•×¤×¡ (form-container).
 * × ×•×¢×“×” ×œ×”×•×‘×™×œ ××ª ×”××©×ª××© ×œ×›×¤×ª×•×¨×™ ×¡×™×•× ×›××• "××™×©×•×¨" ×•-"×‘×™×˜×•×œ".
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ××™×ª×•×¨ ×”×§×•× ×˜×™×™× ×¨ ×œ×¤×™ ××–×”×”.
 * 2ï¸âƒ£ ×‘×“×™×§×” ×”×× ×”×§×•× ×˜×™×™× ×¨ ×§×™×™×.
 * 3ï¸âƒ£ ×—×™×©×•×‘ ×¢×¨×š scrollTop ××¨×‘×™.
 * 4ï¸âƒ£ ×’×œ×™×œ×” ×œ×ª×—×ª×™×ª ×‘×”×ª× ×”×’×•×ª ×—×œ×§×”.
 * 5ï¸âƒ£ ×¨×™×©×•× ×œ×•×’×™× ×œ××•×¨×š ×”×“×¨×š.
 */
function scrollToBottom() {
  console.log("ğŸ”½ [scrollToBottom] â–¶ ×”×ª×—×œ×ª ×’×œ×™×œ×” ×œ×ª×—×ª×™×ª ×”×˜×•×¤×¡");

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ××™×ª×•×¨ ×”×§×•× ×˜×™×™× ×¨
  const container = document.getElementById("form-container");

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ×‘×“×™×§×” ×©×”×§×•× ×˜×™×™× ×¨ ×§×™×™×
  if (!container) {
    console.error("âŒ [scrollToBottom] ×§×•× ×˜×™×™× ×¨ 'form-container' ×œ× × ××¦×");
    return;
  }

  // ×©×œ×‘ 3ï¸âƒ£ â€“ ×—×™×©×•×‘ × ×§×•×“×ª ×’×œ×™×œ×”
  const maxScrollTop = container.scrollHeight - container.clientHeight;
  console.log(`ğŸ“ [scrollToBottom] ×’×•×‘×” ×’×œ×™×œ×” ××¨×‘×™: ${maxScrollTop}`);

  // ×©×œ×‘ 4ï¸âƒ£ â€“ ×‘×™×¦×•×¢ ×’×œ×™×œ×” ×—×œ×§×”
  container.scrollTo({
    top: maxScrollTop,
    behavior: "smooth"
  });

  // ×©×œ×‘ 5ï¸âƒ£ â€“ ×œ×•×’ ×¡×™×•×
  console.log("âœ… [scrollToBottom] ×’×œ×™×œ×” ×œ×ª×—×ª×™×ª ×”×•×©×œ××” ×‘×”×¦×œ×—×”");
}
/**
 * ğŸ§  ×¤×•× ×§×¦×™×”: monitorScrollPosition
 *
 * ğŸ¯ ××˜×¨×”:
 * ×œ×¢×§×•×‘ ××—×¨×™ ××¦×‘ ×”×’×œ×™×œ×” ×‘×§×•× ×˜×™×™× ×¨ ×”×˜×•×¤×¡,
 * ×•×œ×¢×“×›×Ÿ ××ª ×–××™× ×•×ª ×›×¤×ª×•×¨×™ ×”×’×œ×™×œ×” (×œ××¢×œ×” / ×œ××˜×”) ×‘×”×ª××.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ××™×ª×•×¨ ×”××œ×× ×˜×™× ×”× ×“×¨×©×™×
 * 2ï¸âƒ£ ×”×’×“×¨×ª ×œ×•×’×™×§×” ×œ×‘×“×™×§×ª ××™×§×•× ×”×’×œ×™×œ×”
 * 3ï¸âƒ£ ×”×¦××“×” ×œ××™×¨×•×¢ ×’×œ×™×œ×”
 * 4ï¸âƒ£ ×‘×“×™×§×” ××™×™×“×™×ª ×’× ×œ××—×¨ ×˜×¢×™× ×”
 */
function monitorScrollPosition() {
  console.log("ğŸ§­ [monitorScrollPosition] â–¶ ×”×ª×—×œ×ª × ×™×˜×•×¨ ××¦×‘ ×’×œ×™×œ×”");

  // ×©×œ×‘ 1ï¸âƒ£ â€“ ××™×ª×•×¨ ××œ×× ×˜×™×
  const container = document.getElementById("form-container");
  const upBtn = document.getElementById("scrollUpBtn");
  const downBtn = document.getElementById("scrollDownBtn");

  if (!container || !upBtn || !downBtn) {
    console.error("âŒ [monitorScrollPosition] ×§×•× ×˜×™×™× ×¨ ××• ×›×¤×ª×•×¨×™× ×œ× × ××¦××• ×‘Ö¾DOM");
    return;
  }

  // ×©×œ×‘ 2ï¸âƒ£ â€“ ×¤×•× ×§×¦×™×” ×¤× ×™××™×ª ×œ×‘×“×™×§×ª ××¦×‘ ×’×œ×™×œ×”
  const updateScrollButtons = () => {
    const scrollTop = container.scrollTop;
    const maxScrollTop = container.scrollHeight - container.clientHeight;

    const isAtTop = scrollTop <= 5;
    const isAtBottom = scrollTop >= maxScrollTop - 5;

    console.log(`ğŸ“ [monitorScrollPosition] scrollTop=${scrollTop}, max=${maxScrollTop}`);
    console.log(`ğŸ” ××¦×‘: isAtTop=${isAtTop}, isAtBottom=${isAtBottom}`);

    upBtn.disabled = isAtTop;
    downBtn.disabled = isAtBottom;

    console.log(`ğŸ” ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™×: â¬† upBtn.disabled=${upBtn.disabled}, â¬‡ downBtn.disabled=${downBtn.disabled}`);
  };

  // ×©×œ×‘ 3ï¸âƒ£ â€“ ×”××–× ×” ×œ××™×¨×•×¢ scroll
  container.addEventListener("scroll", updateScrollButtons);

  // ×©×œ×‘ 4ï¸âƒ£ â€“ ×‘×“×™×§×” ××™×™×“×™×ª ×œ××—×¨ ×”×˜×¢×™× ×” (×œ××§×¨×” ×©×›×‘×¨ ×’×•×œ×œ)
  setTimeout(updateScrollButtons, 100); // ×”×©×”×™×™×” ×§×¦×¨×” ×›×“×™ ×œ×”×‘×˜×™×— render

  console.log("âœ… [monitorScrollPosition] × ×™×˜×•×¨ ×’×œ×™×œ×” ×”×•×¤×¢×œ");
}
