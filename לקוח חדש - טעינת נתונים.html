/**
 * ×¤×•× ×§×¦×™×” 001: handleFormData
 * 
 * ğŸ“¦ ×¤×•× ×§×¦×™×” ××¨×›×–×™×ª ×œ×˜×¢×™× ×ª × ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××”×©×¨×ª ××œ ×ª×•×š ×˜×•×¤×¡ ×“×™× ×××™.
 * 
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×›×œ×œ×™×ª ×©×œ ××•×‘×™×™×§×˜ ×”× ×ª×•× ×™×.
 * 2ï¸âƒ£ ××™×œ×•×™ ×©×“×•×ª ××¢×¨×›×ª×™×™× (××–×”×™×, ×ª××¨×™×›×™×, ×©× ×¤×¨×•×™×§×˜).
 * 3ï¸âƒ£ ×©××™×¨×ª ×¨×©×™××ª ×œ×§×•×—×•×ª ×§×™×™××™× ×‘××©×ª× ×” ×’×œ×•×‘×œ×™.
 * 4ï¸âƒ£ ×˜×¢×™× ×ª ××§×‘×œ×™ ×¢××œ×” ×œ×¨×©×™××ª ×‘×—×™×¨×” ×•×¢×“×›×•×Ÿ ×©×“×•×ª ×¢××œ×”.
 * 5ï¸âƒ£ ×‘×“×™×§×” ×”×× × ×™×ª×Ÿ ×œ×”×¤×¢×™×œ ××ª ×”×˜×•×¤×¡.
 * 6ï¸âƒ£ ×”×¦×’×ª ×”×•×“×¢×•×ª ×©×’×™××” ×‘××§×¨×” ×©×œ ×ª×§×œ×”.
 * 
 * @param {Object} data - ××•×‘×™×™×§×˜ ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ ×Ö¾Google Apps Script
 */
function handleFormData(data) {
  console.log("ğŸ“¡ [handleFormData] â–¶ ×”×ª×—×œ×ª ×¢×™×‘×•×“ × ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××”×©×¨×ª...");

  try {
    // ×©×œ×‘ 1ï¸âƒ£ - ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×›×œ×œ×™×ª
    if (!data || typeof data !== "object") {
      console.error("âŒ [handleFormData] ××•×‘×™×™×§×˜ ×”× ×ª×•× ×™× ×¨×™×§ ××• ×œ× ×ª×§×™×Ÿ:", data);
      showGlobalErrorMessage("âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× â€“ × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.");
      return;
    }

    // ×©×œ×‘ 2ï¸âƒ£ - ××™×œ×•×™ ×©×“×•×ª ××¢×¨×›×ª×™×™×
    fillSystemFields(data.generatedFields);

    // ×©×œ×‘ 3ï¸âƒ£ - ×©××™×¨×ª ×¨×©×™××ª ×œ×§×•×—×•×ª ×§×™×™××™×
    populateCustomerList(data.existingCustomers);

    // ×©×œ×‘ 4ï¸âƒ£ - ×˜×¢×™× ×ª ×¨×©×™××ª ××§×‘×œ×™ ×”×¢××œ×”
    initializeCommissionSelector(data.commissionRecipients);

    // ×©×œ×‘ 5ï¸âƒ£ - ×‘×“×™×§×” ×¡×•×¤×™×ª
    const allDataReady = validateInitialData(data);
    if (allDataReady) {
      enableForm();
      console.log("âœ… [handleFormData] ×›×œ ×”× ×ª×•× ×™× × ×§×œ×˜×• ×•×”×˜×•×¤×¡ ××•×›×Ÿ ×œ×©×™××•×©.");
    } else {
      console.warn("âš ï¸ [handleFormData] ×—×œ×§ ××”× ×ª×•× ×™× ×—×¡×¨×™× - ×—×¡×™××” ×–×× ×™×ª ×©×œ ×”×˜×•×¤×¡.");
      showGlobalErrorMessage("âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™× - × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×˜×•×¤×¡.");
    }

  } catch (error) {
    console.error("âŒ [handleFormData] ×©×’×™××” ×›×œ×œ×™×ª ×‘×¢×ª ×˜×¢×™× ×ª ×”× ×ª×•× ×™×:", error);
    showGlobalErrorMessage("âŒ ×©×’×™××” ×›×œ×œ×™×ª. × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.");
  }
}
/**
 * ×¤×•× ×§×¦×™×” 002: fillSystemFields
 * 
 * ğŸ¯ ×××œ××ª ××ª ×©×“×•×ª ×”××¢×¨×›×ª ×‘×˜×•×¤×¡ â€“ ×ª××¨×™×š ×™×¦×™×¨×”, ××–×”×” ×œ×§×•×—, ×ª××¨×™×š ×›× ×™×¡×”, ××–×”×” ×¤×¨×•×™×§×˜, ×©× ×¤×¨×•×™×§×˜.
 * 
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×××ª×¨×ª ×›×œ ×©×“×” ×œ×¤×™ ××–×”×” ×‘-DOM.
 * 2ï¸âƒ£ ×‘×•×“×§×ª ×× ×”×©×“×” ×§×™×™×.
 * 3ï¸âƒ£ ×××œ××ª ××ª ×”×¢×¨×š ×©×”×’×™×¢ ××”×©×¨×ª.
 * 4ï¸âƒ£ ××™×™×¦×¨×ª ×¢×¨×š ×œ×©× ×¤×¨×•×™×§×˜ ×œ×¤×™ ×ª××¨×™×š ×‘××™×“×ª ×”×¦×•×¨×š.
 * 5ï¸âƒ£ ×¨×•×©××ª ×œ×•×’ ×œ×›×œ ×¤×¢×•×œ×”.
 * 
 * @param {Object} fields - ××•×‘×™×™×§×˜ ×”××›×™×œ ××ª ×©×“×•×ª ×”××¢×¨×›×ª (creationDate, customerID, entryDate, projectID)
 */
function fillSystemFields(fields) {
  console.log("ğŸ”§ [fillSystemFields] â–¶ ×”×ª×—×œ×ª ××™×œ×•×™ ×©×“×•×ª ××¢×¨×›×ª×™×™×...");

  try {
    const mapping = {
      creationDate: "×ª××¨×™×š ×™×¦×™×¨×”",
      customerID: "××–×”×” ×œ×§×•×—",
      entryDate: "×ª××¨×™×š ×›× ×™×¡×” ×œ××¢×¨×›×ª",
      projectID: "××–×”×” ×¤×¨×•×™×§×˜",
      projectName: "×©× ×¤×¨×•×™×§×˜"
    };

    for (const [id, label] of Object.entries(mapping)) {
      const element = document.getElementById(id);

      const value = fields?.[id] || (id === "projectName"
        ? `×©×™×•×•×§ ${fields?.creationDate || ''}` : "");

      if (!element) {
        console.warn(`âš ï¸ [fillSystemFields] ×”××œ×× ×˜ '${id}' (${label}) ×œ× × ××¦× ×‘-DOM`);
        continue;
      }

      element.value = value;
      console.log(`âœ… [fillSystemFields] ×©×“×” '${label}' ××•×œ× ×‘×¢×¨×š: ${value}`);
    }

    console.log("âœ… [fillSystemFields] ×¡×™×•× ××™×œ×•×™ ×©×“×•×ª ××¢×¨×›×ª×™×™×.");

  } catch (error) {
    console.error("âŒ [fillSystemFields] ×©×’×™××” ×›×œ×œ×™×ª:", error);
  }
}
/**
 * ×¤×•× ×§×¦×™×” 003: populateCustomerList
 * 
 * ğŸ‘¥ ×˜×•×¢× ×ª ××ª ×¨×©×™××ª ×”×œ×§×•×—×•×ª ×”×§×™×™××™× ×œ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×©×™××•×© ×‘×˜×•×¤×¡.
 * 
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×‘×•×“×§×ª ×× ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××”×©×¨×ª ×”× ××¢×¨×š ×ª×§×™×Ÿ.
 * 2ï¸âƒ£ ×××™×™× ×ª ××ª ×”×œ×§×•×—×•×ª ×œ×¤×™ ×¡×“×¨ ××´×‘ ×‘×¢×‘×¨×™×ª.
 * 3ï¸âƒ£ ×©×•××¨×ª ××ª ×”×¨×©×™××” ×‘××©×ª× ×” ×’×œ×•×‘×œ×™ `existingCustomers`.
 * 4ï¸âƒ£ ×¨×•×©××ª ××ª ×”×¨×©×™××” ×œ×œ×•×’.
 * 
 * @param {Array} customers - ××¢×¨×š ×©×œ ×©××•×ª ×œ×§×•×—×•×ª ××”×©×¨×ª.
 */
function populateCustomerList(customers) {
  console.log("ğŸ“¥ [populateCustomerList] ×”×ª×—×œ×ª ×˜×¢×™× ×ª ×¨×©×™××ª ×œ×§×•×—×•×ª...");

  try {
    if (!Array.isArray(customers)) {
      console.warn("âš ï¸ [populateCustomerList] ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××™× × ××¢×¨×š ×ª×§×™×Ÿ:", customers);
      return;
    }

    customers.sort((a, b) => a.trim().localeCompare(b.trim(), "he", { sensitivity: "base" }));

    existingCustomers = customers;

    console.log("âœ… [populateCustomerList] ×¨×©×™××ª ×”×œ×§×•×—×•×ª × ×˜×¢× ×” ×•××•×™× ×”:", existingCustomers);

  } catch (error) {
    console.error("âŒ [populateCustomerList] ×©×’×™××” ×›×œ×œ×™×ª:", error);
  }
}
/**
 * ×¤×•× ×§×¦×™×” 004: initializeCommissionSelector
 * 
 * ğŸ’¼ ×××›×œ×¡×ª ××ª ×¨×©×™××ª ××§×‘×œ×™ ×”×¢××œ×” ×œ×ª×•×š ××œ×× ×˜ select ×‘×˜×•×¤×¡, ×•××’×“×™×¨×” ×”××–× ×” ×œ×¢×“×›×•×Ÿ ×©×“×•×ª × ×œ×•×•×™×.
 * 
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×‘×•×“×§×ª ×× ×”××œ×× ×˜×™× ×”×“×¨×•×©×™× ×§×™×™××™× (select + ×©×“×•×ª ×¢××œ×”).
 * 2ï¸âƒ£ ×××¤×¡×ª ××ª ×”×ª×•×›×Ÿ ×”×§×™×™× ×•×™×•×¦×¨×ª ××¤×©×¨×•×ª ×‘×¨×™×¨×ª ××—×“×œ.
 * 3ï¸âƒ£ ××•×¡×™×¤×” ×›×œ ××§×‘×œ ×¢××œ×” ×›Ö¾<option>.
 * 4ï¸âƒ£ ×××–×™× ×” ×œ×©×™× ×•×™ ×¢×¨×š ×•×‘×•×—×¨×ª ××ª ××—×•×– ×”×¢××œ×” ×•×”×—×•×“×©×™× ××ª×•×š ××§×‘×œ ×”×¢××œ×” ×©× ×‘×—×¨.
 * 5ï¸âƒ£ ×¨×•×©××ª ×œ×•×’×™× ××œ××™×.
 * 
 * @param {Array<{name: string, rate: number, months: number}>} recipients - ××¢×¨×š ××§×‘×œ×™ ×”×¢××œ×” ××”×©×¨×ª.
 */
function initializeCommissionSelector(recipients) {
  console.log("ğŸ“¥ [initializeCommissionSelector] ×˜×¢×™× ×ª ×¨×©×™××ª ××§×‘×œ×™ ×¢××œ×”...");

  try {
    const select = document.getElementById("commissionRecipient");
    const rateField = document.getElementById("commissionRate");
    const monthsField = document.getElementById("commissionMonths");

    if (!select || !rateField || !monthsField) {
      console.warn("âš ï¸ [initializeCommissionSelector] ××—×“ ××”×©×“×•×ª commissionRecipient / commissionRate / commissionMonths ×œ× × ××¦× ×‘Ö¾DOM.");
      return;
    }

    // ×©×œ×‘ 1ï¸âƒ£: ××™×¤×•×¡ ×”×¨×©×™××” ×•×”×•×¡×¤×ª ×‘×¨×™×¨×ª ××—×“×œ
    select.innerHTML = "";
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "-- ×œ×œ× ××§×‘×œ ×¢××œ×” --";
    select.appendChild(defaultOption);

    // ×©×œ×‘ 2ï¸âƒ£: ×”×•×¡×¤×ª ×›×œ ××§×‘×œ ×œ×¨×©×™××”
    recipients.forEach(recipient => {
      const option = document.createElement("option");
      option.value = recipient.name;
      option.textContent = recipient.name;
      select.appendChild(option);
    });

    // ×©×œ×‘ 3ï¸âƒ£: ×”××–× ×” ×œ×‘×—×™×¨×”
    select.addEventListener("change", () => {
      const selected = select.value;
      const found = recipients.find(r => r.name === selected);
      rateField.value = found ? found.rate : "";
      monthsField.value = found ? found.months : "";
      console.log(`âœ… [initializeCommissionSelector] ××§×‘×œ ×¢××œ×” × ×‘×—×¨: ${selected} | ××—×•×–: ${rateField.value} | ×—×•×“×©×™×: ${monthsField.value}`);
    });

    console.log("âœ… [initializeCommissionSelector] ×”×¨×©×™××” × ×˜×¢× ×” ×‘×”×¦×œ×—×”.");

  } catch (error) {
    console.error("âŒ [initializeCommissionSelector] ×©×’×™××” ×›×œ×œ×™×ª:", error);
  }
}
