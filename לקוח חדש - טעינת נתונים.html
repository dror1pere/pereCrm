/**
 * 🧠 פונקציה: handleFormData
 *
 * 🎯 מטרה:
 * עיבוד נתונים שהתקבלו מהשרת והזרמתם אל תוך טופס דינאמי.
 * כולל מילוי שדות מערכתיים, טעינת מקורות נתונים, חיבור הולידציה, הסרת שכבת טעינה והגדרת focus אוטומטי.
 *
 * 📦 תומך בסכמה גנרית לכל סוגי הטפסים, מותאם למודל עבודה מבוסס FORM_CONTEXT.
 *
 * 📌 שלבים:
 * 1️⃣ בדיקת תקינות בסיסית של הנתונים.
 * 2️⃣ ולידציה של שלמות הנתונים (validateNewCustomerFormData).
 * 3️⃣ מילוי שדות מערכתיים אוטומטיים.
 * 4️⃣ טעינת רשימות לקוחות קיימים ל־FORM_CONTEXT.
 * 5️⃣ טעינת מקבלי עמלות ל־FORM_CONTEXT.
 * 6️⃣ טעינת סכמת שדות והצמדת הולידציות.
 * 7️⃣ סיום – הסרת שכבת טעינה והגדרת focus אוטומטי.
 * 8️⃣ טיפול בשגיאות כלליות במקרה של כשל.
 *
 * @param {Object} data - אובייקט הנתונים שהתקבל מהשרת (Google Apps Script)
 */
function handleFormData(data) {
  console.log("📡 [handleFormData] ▶ התחלת עיבוד נתונים מהשרת...");

  try {
    // שלב 1️⃣ – בדיקת תקינות בסיסית
    if (!data || typeof data !== "object") {
      console.error("❌ [1️⃣] אובייקט הנתונים לא תקין או ריק:", data);
      updateLoadingOverlayText("❌ שגיאה בטעינת הנתונים – נסה לרענן את הדף.");
      return;
    }
    console.log("✅ [1️⃣] אובייקט הנתונים עבר בדיקת תקינות ראשונית");

    // שלב 2️⃣ – ולידציה של שלמות הנתונים
    const allDataReady = validateNewCustomerFormData(data);
    if (!allDataReady) {
      console.warn("⚠️ [2️⃣] ולידציה נכשלה – נתונים חסרים או לא תקינים.");
      updateLoadingOverlayText("⚠️ הנתונים אינם שלמים – לא ניתן להמשיך.");
      return;
    }
    console.log("✅ [2️⃣] הנתונים עברו ולידציה כללית");

    // שלב 3️⃣ – מילוי שדות מערכתיים
    console.log("🧩 [3️⃣] מילוי שדות מערכתיים...");
    fillSystemFields(data.generatedFields);
    console.log("✅ [3️⃣] שדות מערכתיים מולאו");

    // שלב 4️⃣ – טעינת רשימת לקוחות קיימים
    console.log("📋 [4️⃣] טעינת רשימת לקוחות...");
    populateCustomerList(data.existingCustomers);
    console.log("✅ [4️⃣] רשימת לקוחות נטענה בהצלחה");

    // שלב 5️⃣ – טעינת מקבלי עמלות
    console.log("💸 [5️⃣] טעינת מקבלי עמלות...");
    FORM_CONTEXT.dataSources.commissionRecipients = data.commissionRecipients || [];
    initializeCommissionSelector();
    console.log("✅ [5️⃣] מקבלי עמלות הוזנו בהצלחה");

    // שלב 6️⃣ – טעינת סכמה והצמדת הולידציות
    console.log("🧠 [6️⃣] טעינת סכמת טופס...");
    const schema = loadSchemaFromDOM("schema-dynamic");
    if (schema) {
      const flatSchema = flattenSchemaToFields(schema);
      attachValidatorsFromSchema(flatSchema);
      FORM_CONTEXT.flatFields = flatSchema;
      console.log("✅ [6️⃣] סכמה נטענה והולידציות חוברו");

      // שלב 7️⃣ – סיום: הסרת שכבת טעינה + פוקוס
      hideLoadingOverlay();
      console.log("✅ [7️⃣] שכבת טעינה הוסרה");

      focusFirstEditableField();
      console.log("✅ [7️⃣] focus הוגדר בשדה הראשון המתאים");

    } else {
      console.warn("⚠️ [6️⃣] לא ניתן לטעון סכמה - סיום טעינה בכל זאת");
      hideLoadingOverlay();
    }

    console.log("🏁 [handleFormData] סיום מלא של תהליך טעינת הטופס.");

  } catch (error) {
    // שלב 8️⃣ – טיפול בשגיאה כללית
    console.error("❌ [8️⃣] שגיאה בלתי צפויה בעת עיבוד הנתונים:", error);
    updateLoadingOverlayText("❌ שגיאה כללית – נסה לרענן את הדף.");
  }
}


/**
 * פונקציה 002: fillSystemFields
 * 
 * 🎯 ממלאת את שדות המערכת בטופס – תאריך יצירה, מזהה לקוח, תאריך כניסה, מזהה פרויקט, שם פרויקט.
 * 
 * 📌 שלבי פעולה:
 * 1️⃣ מאתרת כל שדה לפי מזהה ב-DOM.
 * 2️⃣ בודקת אם השדה קיים.
 * 3️⃣ ממלאת את הערך שהגיע מהשרת.
 * 4️⃣ מייצרת ערך לשם פרויקט לפי תאריך במידת הצורך.
 * 5️⃣ רושמת לוג לכל פעולה.
 * 
 * @param {Object} fields - אובייקט המכיל את שדות המערכת (creationDate, customerID, entryDate, projectID)
 */
function fillSystemFields(fields) {
  console.log("🔧 [fillSystemFields] ▶ התחלת מילוי שדות מערכתיים...");

  try {
    const mapping = {
      creationDate: "תאריך יצירה",
      customerID: "מזהה לקוח",
      entryDate: "תאריך כניסה למערכת",
      projectID: "מזהה פרויקט",
      projectName: "שם פרויקט"
    };

    for (const [id, label] of Object.entries(mapping)) {
      const element = document.getElementById(id);

      const value = fields?.[id] || (id === "projectName"
        ? `שיווק ${fields?.creationDate || ''}` : "");

      if (!element) {
        console.warn(`⚠️ [fillSystemFields] האלמנט '${id}' (${label}) לא נמצא ב-DOM`);
        continue;
      }

      element.value = value;
      console.log(`✅ [fillSystemFields] שדה '${label}' מולא בערך: ${value}`);
    }

    console.log("✅ [fillSystemFields] סיום מילוי שדות מערכתיים.");

  } catch (error) {
    console.error("❌ [fillSystemFields] שגיאה כללית:", error);
  }
}
/**
 * 🧠 פונקציה 003: populateCustomerList
 * 
 * 🎯 מטרה:
 * טוענת את רשימת הלקוחות הקיימים ומסדרת אותם לפי סדר א״ב לשימוש עתידי.
 * לאחר המיון – הרשימה נשמרת ב־FORM_CONTEXT.validation.customerList לצורך בדיקת ייחודיות.
 *
 * 📌 שלבי פעולה:
 * 1️⃣ בדיקה האם הנתונים תקינים (Array)
 * 2️⃣ נרמול ומיון הרשימה
 * 3️⃣ שמירה בתוך FORM_CONTEXT.validation
 * 4️⃣ רישום ללוג
 *
 * @param {Array<string>} customers - רשימת לקוחות מהשרת
 */
function populateCustomerList(customers) {
  console.log("📥 [populateCustomerList] ▶ התחלת טעינת רשימת לקוחות...");

  try {
    // שלב 1️⃣ – בדיקת תקינות
    if (!Array.isArray(customers)) {
      console.warn("⚠️ [populateCustomerList] הנתונים שהתקבלו אינם מערך תקין:", customers);
      return;
    }

    // שלב 2️⃣ – נרמול ומיון
    const sorted = customers
      .map(name => typeof name === "string" ? name.trim() : name?.name?.trim())
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b, "he", { sensitivity: "base" }));

    // שלב 3️⃣ – שמירה בקונטקסט
    FORM_CONTEXT.validation.customerList = sorted;

    // שלב 4️⃣ – לוג
    console.log("✅ [populateCustomerList] רשימת הלקוחות נשמרה ל־FORM_CONTEXT:", FORM_CONTEXT.validation.customerList);

  } catch (error) {
    console.error("❌ [populateCustomerList] שגיאה כללית בעת עיבוד רשימת לקוחות:", error);
  }
}
/**
 * 🧠 פונקציה 004: initializeCommissionSelector
 *
 * 🎯 מטרה:
 * מאכלסת את אלמנט הבחירה של מקבלי העמלה (`select`) מתוך הנתונים שב־FORM_CONTEXT.
 * בעת בחירת מקבל עמלה – ממלאת אוטומטית את אחוזי העמלה ומספר החודשים.
 *
 * 📌 שלבי פעולה:
 * 1️⃣ איתור אלמנטי DOM: select, אחוז, חודשים
 * 2️⃣ איפוס הרשימה והוספת אפשרות ברירת מחדל
 * 3️⃣ יצירת אופציות מתוך FORM_CONTEXT.dataSources.commissionRecipients
 * 4️⃣ חיבור מאזין שמעדכן ערכים לפי הבחירה
 * 5️⃣ רישום ללוג
 */
function initializeCommissionSelector() {
  console.log("📥 [initializeCommissionSelector] ▶ טעינת מקבלי עמלות מה־FORM_CONTEXT");

  try {
    // שלב 1️⃣ – איתור אלמנטים
    const select = document.getElementById("commissionRecipient");
    const rateField = document.getElementById("commissionRate");
    const monthsField = document.getElementById("commissionMonths");

    if (!select || !rateField || !monthsField) {
      console.warn("⚠️ [initializeCommissionSelector] אחד האלמנטים לא נמצא ב־DOM");
      return;
    }

    // שלב 2️⃣ – איפוס והרשאה לברירת מחדל
    select.innerHTML = "";
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "-- ללא מקבל עמלה --";
    select.appendChild(defaultOption);

    // שלב 3️⃣ – יצירת אופציות מהרשימה בקונטקסט
    const recipients = FORM_CONTEXT.dataSources.commissionRecipients || [];
    recipients.forEach(recipient => {
      const option = document.createElement("option");
      option.value = recipient.name;
      option.textContent = recipient.name;
      select.appendChild(option);
    });

    // שלב 4️⃣ – חיבור מאזין לעדכון אחוז וחודשים
    select.addEventListener("change", () => {
      const selected = select.value;
      const found = recipients.find(r => r.name === selected);
      rateField.value = found ? found.rate : "";
      monthsField.value = found ? found.months : "";
      console.log(`✅ [initializeCommissionSelector] נבחר: ${selected} | אחוז: ${rateField.value} | חודשים: ${monthsField.value}`);
    });

    // שלב 5️⃣ – סיום
    console.log("✅ [initializeCommissionSelector] רשימת מקבלי העמלה נטענה בהצלחה");

  } catch (error) {
    console.error("❌ [initializeCommissionSelector] שגיאה כללית:", error);
  }
}
/**
 * 🧠 פונקציה 005: validateNewCustomerFormData
 *
 * 🎯 מטרת הפונקציה:
 * בדיקת תקינות ושלמות של אובייקט הנתונים המתקבל מהשרת עבור טופס 'לקוח חדש'.
 * מונעת המשך הרצת הטופס אם חסרים נתוני ליבה נדרשים.
 *
 * 📌 שלבי פעולה:
 * 1️⃣ בדיקה שהאובייקט הראשי קיים ותקין (Object)
 * 2️⃣ בדיקה שכל שדות המערכת החיוניים קיימים
 * 3️⃣ בדיקה שקיימת רשימת לקוחות קיימים מסוג Array
 * 4️⃣ רישום לוגים על תוצאות כל שלב
 * 5️⃣ החזרת true אם כל התנאים מתקיימים, אחרת false
 *
 * @param {Object} data - הנתונים שהתקבלו מהשרת
 * @returns {boolean} האם הנתונים תקינים וניתן להמשיך בטעינה
 */
function validateNewCustomerFormData(data) {
  console.log("🧪 [validateNewCustomerFormData] ▶ התחלת בדיקת נתונים מהשרת");

  try {
    // שלב 1️⃣ – בדיקה כללית לאובייקט
    if (!data || typeof data !== "object") {
      console.error("❌ [validateNewCustomerFormData] הנתון שהתקבל אינו אובייקט:", data);
      return false;
    }

    const fields = data.generatedFields;

    // שלב 2️⃣ – בדיקת שדות מערכת חיוניים
    const hasRequiredFields =
      !!fields?.creationDate &&
      !!fields?.customerID &&
      !!fields?.entryDate &&
      !!fields?.projectID;

    if (!hasRequiredFields) {
      console.warn("⚠️ [validateNewCustomerFormData] שדות מערכתיים חסרים:", fields);
    } else {
      console.log("✅ [validateNewCustomerFormData] כל שדות המערכת קיימים");
    }

    // שלב 3️⃣ – בדיקת רשימת לקוחות
    const hasCustomerList = Array.isArray(data.existingCustomers);
    if (!hasCustomerList) {
      console.warn("⚠️ [validateNewCustomerFormData] רשימת לקוחות אינה תקפה:", data.existingCustomers);
    } else {
      console.log(`✅ [validateNewCustomerFormData] קיימת רשימת לקוחות (${data.existingCustomers.length})`);
    }

    // שלב 4️⃣ – סיכום
    const result = hasRequiredFields && hasCustomerList;
    console.log(`📊 [validateNewCustomerFormData] תוצאת בדיקה כוללת: ${result ? "✅ תקין" : "❌ חסר"}`);
    return result;

  } catch (error) {
    console.error("❌ [validateNewCustomerFormData] שגיאה כללית בבדיקת נתונים:", error);
    return false;
  }
}

