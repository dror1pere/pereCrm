/**
 * ×¤×•× ×§×¦×™×” 001: handleFormData
 * 
 * ğŸ“¦ ××˜×¨×”:
 * ×˜×¢×™× ×ª × ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××”×©×¨×ª ××œ ×ª×•×š ×˜×•×¤×¡ ×“×™× ×××™ ××¡×•×’ "×œ×§×•×— ×—×“×©".
 * ×ª×•××›×ª ×‘××›×œ×•×¡ ×©×“×•×ª, ×©××™×¨×ª × ×ª×•× ×™ ××¢×¨×›×ª, ×•×˜×¢×™× ×ª ××§×•×¨×•×ª ××™×“×¢ ×œ×¨×©×™××•×ª.
 * ×”×•×œ×™×“×¦×™×” ××‘×•×¡×¡×ª ×¡×›××” ×‘×œ×‘×“ â€“ ×œ×œ× ×—×™×‘×•×¨×™× ×™×“× ×™×™×.
 * 
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×‘×“×™×§×” ×©×”××•×‘×™×™×§×˜ ×©×”×ª×§×‘×œ ××”×©×¨×ª ×§×™×™× ×•×ª×§×™×Ÿ.
 * 2ï¸âƒ£ ×‘×“×™×§×ª ×©×œ××•×ª ×”× ×ª×•× ×™× (validateNewCustomerFormData).
 * 3ï¸âƒ£ ××™×œ×•×™ ×©×“×•×ª ××¢×¨×›×ª×™×™× (×ª××¨×™×š, ××–×”×™× ×•×›×•').
 * 4ï¸âƒ£ ×˜×¢×™× ×ª ×¨×©×™××ª ×œ×§×•×—×•×ª ×œ×ª×•×š FORM_CONTEXT ×œ×¦×•×¨×š ×•×œ×™×“×¦×™×” ×™×™×—×•×“×™×•×ª.
 * 5ï¸âƒ£ ×˜×¢×™× ×ª ××§×‘×œ×™ ×¢××œ×•×ª ×œÖ¾FORM_CONTEXT ×•×”×¤×¢×œ×ª ×¡×œ×§×˜.
 * 6ï¸âƒ£ ×—×™×‘×•×¨ ×”×•×œ×™×“×¦×™×” ×“×™× ×××™×ª ×œ×©×“×•×ª ××ª×•×š ×”×¡×›××” â€“ ×œ××—×¨ ×˜×¢×™× ×ª × ×ª×•× ×™×.
 * 7ï¸âƒ£ ×”×¡×¨×ª ×©×›×‘×ª ×˜×¢×™× ×”.
 * 8ï¸âƒ£ ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×›×œ×œ×™×•×ª.
 * 
 * @param {Object} data - ××•×‘×™×™×§×˜ ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ ×Ö¾Google Apps Script
 */
function handleFormData(data) {
  console.log("ğŸ“¡ [handleFormData] â–¶ ×”×ª×—×œ×ª ×¢×™×‘×•×“ × ×ª×•× ×™× ××”×©×¨×ª...");

  try {
    // ×©×œ×‘ 1ï¸âƒ£ â€“ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”× ×ª×•× ×™×
    if (!data || typeof data !== "object") {
      console.error("âŒ [handleFormData] ××•×‘×™×™×§×˜ ×”× ×ª×•× ×™× ×œ× ×ª×§×™×Ÿ ××• ×¨×™×§:", data);
      updateLoadingOverlayText("âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× â€“ × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.");
      return;
    }

    // ×©×œ×‘ 2ï¸âƒ£ â€“ ×•×œ×™×“×¦×™×” ×©×œ ×©×œ××•×ª ×”× ×ª×•× ×™×
    const allDataReady = validateNewCustomerFormData(data);
    if (!allDataReady) {
      console.warn("âš ï¸ [handleFormData] ×•×œ×™×“×¦×™×” × ×›×©×œ×” â€“ × ×ª×•× ×™× ×—×¡×¨×™× ××• ×œ× ×ª×§×™× ×™×.");
      updateLoadingOverlayText("âš ï¸ ×”× ×ª×•× ×™× ××™× × ×©×œ××™× â€“ ×œ× × ×™×ª×Ÿ ×œ×”××©×™×š.");
      return;
    }

    // ×©×œ×‘ 3ï¸âƒ£ â€“ ××™×œ×•×™ ×©×“×•×ª ××¢×¨×›×ª×™×™×
    console.log("ğŸ§© [handleFormData] ××™×œ×•×™ ×©×“×•×ª ××¢×¨×›×ª×™×™×...");
    fillSystemFields(data.generatedFields);

    // ×©×œ×‘ 4ï¸âƒ£ â€“ ×˜×¢×™× ×ª ×¨×©×™××ª ×œ×§×•×—×•×ª
    console.log("ğŸ“‹ [handleFormData] ×˜×¢×™× ×ª ×¨×©×™××ª ×œ×§×•×—×•×ª...");
    populateCustomerList(data.existingCustomers);

    // ×©×œ×‘ 5ï¸âƒ£ â€“ ×˜×¢×™× ×ª ××§×‘×œ×™ ×¢××œ×•×ª
    console.log("ğŸ’¸ [handleFormData] ×˜×¢×™× ×ª ××§×‘×œ×™ ×¢××œ×•×ª...");
    FORM_CONTEXT.dataSources.commissionRecipients = data.commissionRecipients || [];
    initializeCommissionSelector();

    // ×©×œ×‘ 6ï¸âƒ£ â€“ ×—×™×‘×•×¨ ×”×•×œ×™×“×¦×™×” ××ª×•×š ×”×¡×›××” (×¨×§ ××—×¨×™ ×˜×¢×™× ×ª × ×ª×•× ×™×)
    const schema = loadSchemaFromDOM("schema-dynamic");
    if (schema) {
      const flatSchema = flattenSchemaToFields(schema);
      attachValidatorsFromSchema(flatSchema);
    } else {
      console.warn("âš ï¸ [handleFormData] ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¡×›××” ×œÖ¾attachValidatorsFromSchema");
    }

    // ×©×œ×‘ 7ï¸âƒ£ â€“ ×¡×™×•×
    hideLoadingOverlay();
    console.log("âœ… [handleFormData] ×”× ×ª×•× ×™× × ×§×œ×˜×• ×•×”×˜×•×¤×¡ ××•×›×Ÿ ×œ×©×™××•×©.");

  } catch (error) {
    // ×©×œ×‘ 8ï¸âƒ£ â€“ ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×›×œ×œ×™×•×ª
    console.error("âŒ [handleFormData] ×©×’×™××” ×›×œ×œ×™×ª ×‘×¢×ª ×¢×™×‘×•×“ ×”× ×ª×•× ×™×:", error);
    updateLoadingOverlayText("âŒ ×©×’×™××” ×›×œ×œ×™×ª â€“ × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.");
  }
}


/**
 * ×¤×•× ×§×¦×™×” 002: fillSystemFields
 * 
 * ğŸ¯ ×××œ××ª ××ª ×©×“×•×ª ×”××¢×¨×›×ª ×‘×˜×•×¤×¡ â€“ ×ª××¨×™×š ×™×¦×™×¨×”, ××–×”×” ×œ×§×•×—, ×ª××¨×™×š ×›× ×™×¡×”, ××–×”×” ×¤×¨×•×™×§×˜, ×©× ×¤×¨×•×™×§×˜.
 * 
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×××ª×¨×ª ×›×œ ×©×“×” ×œ×¤×™ ××–×”×” ×‘-DOM.
 * 2ï¸âƒ£ ×‘×•×“×§×ª ×× ×”×©×“×” ×§×™×™×.
 * 3ï¸âƒ£ ×××œ××ª ××ª ×”×¢×¨×š ×©×”×’×™×¢ ××”×©×¨×ª.
 * 4ï¸âƒ£ ××™×™×¦×¨×ª ×¢×¨×š ×œ×©× ×¤×¨×•×™×§×˜ ×œ×¤×™ ×ª××¨×™×š ×‘××™×“×ª ×”×¦×•×¨×š.
 * 5ï¸âƒ£ ×¨×•×©××ª ×œ×•×’ ×œ×›×œ ×¤×¢×•×œ×”.
 * 
 * @param {Object} fields - ××•×‘×™×™×§×˜ ×”××›×™×œ ××ª ×©×“×•×ª ×”××¢×¨×›×ª (creationDate, customerID, entryDate, projectID)
 */
function fillSystemFields(fields) {
  console.log("ğŸ”§ [fillSystemFields] â–¶ ×”×ª×—×œ×ª ××™×œ×•×™ ×©×“×•×ª ××¢×¨×›×ª×™×™×...");

  try {
    const mapping = {
      creationDate: "×ª××¨×™×š ×™×¦×™×¨×”",
      customerID: "××–×”×” ×œ×§×•×—",
      entryDate: "×ª××¨×™×š ×›× ×™×¡×” ×œ××¢×¨×›×ª",
      projectID: "××–×”×” ×¤×¨×•×™×§×˜",
      projectName: "×©× ×¤×¨×•×™×§×˜"
    };

    for (const [id, label] of Object.entries(mapping)) {
      const element = document.getElementById(id);

      const value = fields?.[id] || (id === "projectName"
        ? `×©×™×•×•×§ ${fields?.creationDate || ''}` : "");

      if (!element) {
        console.warn(`âš ï¸ [fillSystemFields] ×”××œ×× ×˜ '${id}' (${label}) ×œ× × ××¦× ×‘-DOM`);
        continue;
      }

      element.value = value;
      console.log(`âœ… [fillSystemFields] ×©×“×” '${label}' ××•×œ× ×‘×¢×¨×š: ${value}`);
    }

    console.log("âœ… [fillSystemFields] ×¡×™×•× ××™×œ×•×™ ×©×“×•×ª ××¢×¨×›×ª×™×™×.");

  } catch (error) {
    console.error("âŒ [fillSystemFields] ×©×’×™××” ×›×œ×œ×™×ª:", error);
  }
}
/**
 * ğŸ§  ×¤×•× ×§×¦×™×” 003: populateCustomerList
 * 
 * ğŸ¯ ××˜×¨×”:
 * ×˜×•×¢× ×ª ××ª ×¨×©×™××ª ×”×œ×§×•×—×•×ª ×”×§×™×™××™× ×•××¡×“×¨×ª ××•×ª× ×œ×¤×™ ×¡×“×¨ ××´×‘ ×œ×©×™××•×© ×¢×ª×™×“×™.
 * ×œ××—×¨ ×”××™×•×Ÿ â€“ ×”×¨×©×™××” × ×©××¨×ª ×‘Ö¾FORM_CONTEXT.validation.customerList ×œ×¦×•×¨×š ×‘×“×™×§×ª ×™×™×—×•×“×™×•×ª.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×‘×“×™×§×” ×”×× ×”× ×ª×•× ×™× ×ª×§×™× ×™× (Array)
 * 2ï¸âƒ£ × ×¨××•×œ ×•××™×•×Ÿ ×”×¨×©×™××”
 * 3ï¸âƒ£ ×©××™×¨×” ×‘×ª×•×š FORM_CONTEXT.validation
 * 4ï¸âƒ£ ×¨×™×©×•× ×œ×œ×•×’
 *
 * @param {Array<string>} customers - ×¨×©×™××ª ×œ×§×•×—×•×ª ××”×©×¨×ª
 */
function populateCustomerList(customers) {
  console.log("ğŸ“¥ [populateCustomerList] â–¶ ×”×ª×—×œ×ª ×˜×¢×™× ×ª ×¨×©×™××ª ×œ×§×•×—×•×ª...");

  try {
    // ×©×œ×‘ 1ï¸âƒ£ â€“ ×‘×“×™×§×ª ×ª×§×™× ×•×ª
    if (!Array.isArray(customers)) {
      console.warn("âš ï¸ [populateCustomerList] ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××™× × ××¢×¨×š ×ª×§×™×Ÿ:", customers);
      return;
    }

    // ×©×œ×‘ 2ï¸âƒ£ â€“ × ×¨××•×œ ×•××™×•×Ÿ
    const sorted = customers
      .map(name => typeof name === "string" ? name.trim() : name?.name?.trim())
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b, "he", { sensitivity: "base" }));

    // ×©×œ×‘ 3ï¸âƒ£ â€“ ×©××™×¨×” ×‘×§×•× ×˜×§×¡×˜
    FORM_CONTEXT.validation.customerList = sorted;

    // ×©×œ×‘ 4ï¸âƒ£ â€“ ×œ×•×’
    console.log("âœ… [populateCustomerList] ×¨×©×™××ª ×”×œ×§×•×—×•×ª × ×©××¨×” ×œÖ¾FORM_CONTEXT:", FORM_CONTEXT.validation.customerList);

  } catch (error) {
    console.error("âŒ [populateCustomerList] ×©×’×™××” ×›×œ×œ×™×ª ×‘×¢×ª ×¢×™×‘×•×“ ×¨×©×™××ª ×œ×§×•×—×•×ª:", error);
  }
}
/**
 * ğŸ§  ×¤×•× ×§×¦×™×” 004: initializeCommissionSelector
 *
 * ğŸ¯ ××˜×¨×”:
 * ×××›×œ×¡×ª ××ª ××œ×× ×˜ ×”×‘×—×™×¨×” ×©×œ ××§×‘×œ×™ ×”×¢××œ×” (`select`) ××ª×•×š ×”× ×ª×•× ×™× ×©×‘Ö¾FORM_CONTEXT.
 * ×‘×¢×ª ×‘×—×™×¨×ª ××§×‘×œ ×¢××œ×” â€“ ×××œ××ª ××•×˜×•××˜×™×ª ××ª ××—×•×–×™ ×”×¢××œ×” ×•××¡×¤×¨ ×”×—×•×“×©×™×.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ××™×ª×•×¨ ××œ×× ×˜×™ DOM: select, ××—×•×–, ×—×•×“×©×™×
 * 2ï¸âƒ£ ××™×¤×•×¡ ×”×¨×©×™××” ×•×”×•×¡×¤×ª ××¤×©×¨×•×ª ×‘×¨×™×¨×ª ××—×“×œ
 * 3ï¸âƒ£ ×™×¦×™×¨×ª ××•×¤×¦×™×•×ª ××ª×•×š FORM_CONTEXT.dataSources.commissionRecipients
 * 4ï¸âƒ£ ×—×™×‘×•×¨ ×××–×™×Ÿ ×©××¢×“×›×Ÿ ×¢×¨×›×™× ×œ×¤×™ ×”×‘×—×™×¨×”
 * 5ï¸âƒ£ ×¨×™×©×•× ×œ×œ×•×’
 */
function initializeCommissionSelector() {
  console.log("ğŸ“¥ [initializeCommissionSelector] â–¶ ×˜×¢×™× ×ª ××§×‘×œ×™ ×¢××œ×•×ª ××”Ö¾FORM_CONTEXT");

  try {
    // ×©×œ×‘ 1ï¸âƒ£ â€“ ××™×ª×•×¨ ××œ×× ×˜×™×
    const select = document.getElementById("commissionRecipient");
    const rateField = document.getElementById("commissionRate");
    const monthsField = document.getElementById("commissionMonths");

    if (!select || !rateField || !monthsField) {
      console.warn("âš ï¸ [initializeCommissionSelector] ××—×“ ×”××œ×× ×˜×™× ×œ× × ××¦× ×‘Ö¾DOM");
      return;
    }

    // ×©×œ×‘ 2ï¸âƒ£ â€“ ××™×¤×•×¡ ×•×”×¨×©××” ×œ×‘×¨×™×¨×ª ××—×“×œ
    select.innerHTML = "";
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "-- ×œ×œ× ××§×‘×œ ×¢××œ×” --";
    select.appendChild(defaultOption);

    // ×©×œ×‘ 3ï¸âƒ£ â€“ ×™×¦×™×¨×ª ××•×¤×¦×™×•×ª ××”×¨×©×™××” ×‘×§×•× ×˜×§×¡×˜
    const recipients = FORM_CONTEXT.dataSources.commissionRecipients || [];
    recipients.forEach(recipient => {
      const option = document.createElement("option");
      option.value = recipient.name;
      option.textContent = recipient.name;
      select.appendChild(option);
    });

    // ×©×œ×‘ 4ï¸âƒ£ â€“ ×—×™×‘×•×¨ ×××–×™×Ÿ ×œ×¢×“×›×•×Ÿ ××—×•×– ×•×—×•×“×©×™×
    select.addEventListener("change", () => {
      const selected = select.value;
      const found = recipients.find(r => r.name === selected);
      rateField.value = found ? found.rate : "";
      monthsField.value = found ? found.months : "";
      console.log(`âœ… [initializeCommissionSelector] × ×‘×—×¨: ${selected} | ××—×•×–: ${rateField.value} | ×—×•×“×©×™×: ${monthsField.value}`);
    });

    // ×©×œ×‘ 5ï¸âƒ£ â€“ ×¡×™×•×
    console.log("âœ… [initializeCommissionSelector] ×¨×©×™××ª ××§×‘×œ×™ ×”×¢××œ×” × ×˜×¢× ×” ×‘×”×¦×œ×—×”");

  } catch (error) {
    console.error("âŒ [initializeCommissionSelector] ×©×’×™××” ×›×œ×œ×™×ª:", error);
  }
}
/**
 * ğŸ§  ×¤×•× ×§×¦×™×” 005: validateNewCustomerFormData
 *
 * ğŸ¯ ××˜×¨×ª ×”×¤×•× ×§×¦×™×”:
 * ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×•×©×œ××•×ª ×©×œ ××•×‘×™×™×§×˜ ×”× ×ª×•× ×™× ×”××ª×§×‘×œ ××”×©×¨×ª ×¢×‘×•×¨ ×˜×•×¤×¡ '×œ×§×•×— ×—×“×©'.
 * ××•× ×¢×ª ×”××©×š ×”×¨×¦×ª ×”×˜×•×¤×¡ ×× ×—×¡×¨×™× × ×ª×•× ×™ ×œ×™×‘×” × ×“×¨×©×™×.
 *
 * ğŸ“Œ ×©×œ×‘×™ ×¤×¢×•×œ×”:
 * 1ï¸âƒ£ ×‘×“×™×§×” ×©×”××•×‘×™×™×§×˜ ×”×¨××©×™ ×§×™×™× ×•×ª×§×™×Ÿ (Object)
 * 2ï¸âƒ£ ×‘×“×™×§×” ×©×›×œ ×©×“×•×ª ×”××¢×¨×›×ª ×”×—×™×•× ×™×™× ×§×™×™××™×
 * 3ï¸âƒ£ ×‘×“×™×§×” ×©×§×™×™××ª ×¨×©×™××ª ×œ×§×•×—×•×ª ×§×™×™××™× ××¡×•×’ Array
 * 4ï¸âƒ£ ×¨×™×©×•× ×œ×•×’×™× ×¢×œ ×ª×•×¦××•×ª ×›×œ ×©×œ×‘
 * 5ï¸âƒ£ ×”×—×–×¨×ª true ×× ×›×œ ×”×ª× ××™× ××ª×§×™×™××™×, ××—×¨×ª false
 *
 * @param {Object} data - ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××”×©×¨×ª
 * @returns {boolean} ×”×× ×”× ×ª×•× ×™× ×ª×§×™× ×™× ×•× ×™×ª×Ÿ ×œ×”××©×™×š ×‘×˜×¢×™× ×”
 */
function validateNewCustomerFormData(data) {
  console.log("ğŸ§ª [validateNewCustomerFormData] â–¶ ×”×ª×—×œ×ª ×‘×“×™×§×ª × ×ª×•× ×™× ××”×©×¨×ª");

  try {
    // ×©×œ×‘ 1ï¸âƒ£ â€“ ×‘×“×™×§×” ×›×œ×œ×™×ª ×œ××•×‘×™×™×§×˜
    if (!data || typeof data !== "object") {
      console.error("âŒ [validateNewCustomerFormData] ×”× ×ª×•×Ÿ ×©×”×ª×§×‘×œ ××™× ×• ××•×‘×™×™×§×˜:", data);
      return false;
    }

    const fields = data.generatedFields;

    // ×©×œ×‘ 2ï¸âƒ£ â€“ ×‘×“×™×§×ª ×©×“×•×ª ××¢×¨×›×ª ×—×™×•× ×™×™×
    const hasRequiredFields =
      !!fields?.creationDate &&
      !!fields?.customerID &&
      !!fields?.entryDate &&
      !!fields?.projectID;

    if (!hasRequiredFields) {
      console.warn("âš ï¸ [validateNewCustomerFormData] ×©×“×•×ª ××¢×¨×›×ª×™×™× ×—×¡×¨×™×:", fields);
    } else {
      console.log("âœ… [validateNewCustomerFormData] ×›×œ ×©×“×•×ª ×”××¢×¨×›×ª ×§×™×™××™×");
    }

    // ×©×œ×‘ 3ï¸âƒ£ â€“ ×‘×“×™×§×ª ×¨×©×™××ª ×œ×§×•×—×•×ª
    const hasCustomerList = Array.isArray(data.existingCustomers);
    if (!hasCustomerList) {
      console.warn("âš ï¸ [validateNewCustomerFormData] ×¨×©×™××ª ×œ×§×•×—×•×ª ××™× ×” ×ª×§×¤×”:", data.existingCustomers);
    } else {
      console.log(`âœ… [validateNewCustomerFormData] ×§×™×™××ª ×¨×©×™××ª ×œ×§×•×—×•×ª (${data.existingCustomers.length})`);
    }

    // ×©×œ×‘ 4ï¸âƒ£ â€“ ×¡×™×›×•×
    const result = hasRequiredFields && hasCustomerList;
    console.log(`ğŸ“Š [validateNewCustomerFormData] ×ª×•×¦××ª ×‘×“×™×§×” ×›×•×œ×œ×ª: ${result ? "âœ… ×ª×§×™×Ÿ" : "âŒ ×—×¡×¨"}`);
    return result;

  } catch (error) {
    console.error("âŒ [validateNewCustomerFormData] ×©×’×™××” ×›×œ×œ×™×ª ×‘×‘×“×™×§×ª × ×ª×•× ×™×:", error);
    return false;
  }
}

