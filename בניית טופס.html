/**
 * פונקציה 011: renderField
 *
 * 🎨 מטרה:
 * רינדור שדה יחיד לטופס על סמך תבנית HTML מוכנה מראש, לפי הנתונים המוגדרים בסכמה.
 * תומכת ברינדור סוגים שונים של שדות (text, email, select וכו'), ומחזירה HTML גולמי לשימוש.
 *
 * 📌 שלבי פעולה:
 * 1️⃣ איתור תבנית מתאימה לפי סוג השדה (`template-text`, `template-email` וכו').
 * 2️⃣ החלפת מזהים בתוך ה־template: {{id}}, {{label}}, {{readonly}}.
 * 3️⃣ החזרת HTML גולמי מוכן להצבה בתוך innerHTML.
 * 4️⃣ במקרה של כשל – לוג שגיאה והחזרת מחרוזת ריקה.
 *
 * 🛑 נדרשת נוכחות של תבניות בקובץ HTML הראשי.
 *
 * @param {Object} field - אובייקט שדה מתוך הסכמה.
 * @param {string} field.id - מזהה ייחודי לשדה (id ול־name).
 * @param {string} field.type - סוג שדה ("text", "email", "select", וכו').
 * @param {string} [field.label] - תווית מוצגת לשדה.
 * @param {boolean} [field.readonly] - האם השדה לקריאה בלבד.
 * 
 * @returns {string} HTML מוכן להצבה, או מחרוזת ריקה אם יש שגיאה.
 */
function renderField(field) {
  console.log(`[renderField] ▶ התחלת רינדור שדה: '${field.id}', סוג: '${field.type}'`);

  try {
    // שלב 1️⃣ – איתור תבנית מתאימה
    const template = document.getElementById(`template-${field.type}`);
    if (!template) {
      console.warn(`⚠️ [renderField] לא נמצאה תבנית לסוג '${field.type}' (שדה: '${field.id}')`);
      return "";
    }

    // שלב 2️⃣ – החלפת מזהים בתבנית
    let html = template.innerHTML
      .replace(/{{id}}/g, field.id)
      .replace(/{{label}}/g, field.label || "")
      .replace(/{{readonly}}/g, field.readonly ? "readonly" : "");

    // שלב 3️⃣ – החזרת HTML
    console.log(`✅ [renderField] רינדור הושלם לשדה '${field.id}'`);
    return html;

  } catch (error) {
    // שלב 4️⃣ – טיפול בשגיאה
    console.error(`❌ [renderField] שגיאה ברינדור שדה '${field.id}':`, error);
    return "";
  }
}

/**
 * פונקציה 012: renderButton
 * רינדור כפתור HTML על בסיס תבנית מוגדרת מראש.
 *
 * 📌 שלבי פעולה:
 * 1️⃣ בניית מזהה תבנית (template ID) לפי סוג הכפתור.
 * 2️⃣ טעינת תבנית מתאימה מה־DOM.
 * 3️⃣ החלפת מזהים בתוך ה־template (id, label, class, onclick).
 * 4️⃣ החזרת HTML גולמי או מחרוזת ריקה במקרה של שגיאה.
 *
 * 🛑 נדרשת נוכחות של template עם id מתאים: template-button-<type>
 *
 * @param {Object} button - אובייקט הגדרת כפתור
 * @param {string} button.id - מזהה ייחודי של הכפתור
 * @param {string} button.label - טקסט שיוצג בכפתור
 * @param {string} button.type - סוג הכפתור ("submit", "cancel", "button-custom")
 * @param {string} [button.class] - מחלקת CSS (רלוונטי ל־custom)
 * @param {string} [button.onclick] - פונקציית onclick (רלוונטי ל־custom)
 * @returns {string} HTML מוכן להצבה או מחרוזת ריקה אם נכשל
 */
function renderButton(button) {
  console.log(`[renderButton] ▶ התחלה: סוג=${button.type}, id=${button.id}`);

  try {
    // 1️⃣ קביעת מזהה תבנית לפי סוג
    let templateId = `template-button-${button.type}`;
    if (button.type === "button-custom") {
      templateId = "template-button-custom";
    }

    // 2️⃣ איתור תבנית מתאימה
    const template = document.getElementById(templateId);
    if (!template) {
      console.warn(`[renderButton] ⚠️ תבנית לא נמצאה עבור סוג הכפתור: '${button.type}'`);
      return "";
    }

    // 3️⃣ החלפת מזהים בתוך התבנית
    let html = template.innerHTML
      .replace(/{{id}}/g, button.id)
      .replace(/{{label}}/g, button.label || "");

    if (button.type === "button-custom") {
      html = html
        .replace(/{{class}}/g, button.class || "btn")
        .replace(/{{onclick}}/g, button.onclick || "");
    }

    console.log(`[renderButton] ✅ כפתור '${button.id}' נוצר בהצלחה`);
    return html;

  } catch (error) {
    console.error(`[renderButton] ❌ שגיאה ברינדור כפתור '${button.id}':`, error);
    return "";
  }
}

/**
 * 🚀 פונקציה 001: renderForm
 *
 * 📦 מטרה:
 * רינדור טופס דינאמי מלא על פי סכמה JSON הכוללת מקטעים, שדות וכפתורים.
 * כל הרכיבים מרונדרים ישירות ל־form-body ללא חריגות או מיכלים מיוחדים.
 *
 * 📌 שלבי פעולה:
 * 1️⃣ איתור אלמנט יעד להצגת הטופס.
 * 2️⃣ בדיקת תקינות הסכמה.
 * 3️⃣ מעבר על כל מקטע – רינדור כותרת ושדות.
 * 4️⃣ הסתרת שכבת הטעינה עם סיום הרינדור.
 *
 * 🧱 דרישות:
 * - תבניות `template-<type>` קיימות ב־HTML (לדוגמה: `template-text`, `template-button-custom`)
 *
 * @param {Object} schema - סכמה במבנה JSON, כולל sections
 * @param {string} targetElementId - מזהה האלמנט שבו יוצג הטופס (למשל: 'form-body')
 */
function renderForm(schema, targetElementId) {
  console.log("📋 [renderForm] ▶ התחלת רינדור טופס עם מקטעים");

  try {
    // שלב 1️⃣ – איתור אלמנט יעד
    const container = document.getElementById(targetElementId);
    if (!container) {
      console.error(`❌ [renderForm] אלמנט יעד '${targetElementId}' לא נמצא`);
      return;
    }

    // שלב 2️⃣ – בדיקת תקינות סכמה
    if (!schema || !Array.isArray(schema.sections)) {
      console.error("❌ [renderForm] סכמה לא תקינה – חסרים sections");
      return;
    }

    container.innerHTML = ""; // איפוס תוכן קודם

    // כותרת דינאמית
    const formTitleEl = document.getElementById("form-title");
    if (formTitleEl && schema.title) {
      formTitleEl.textContent = schema.title;
      console.log(`📛 [renderForm] כותרת עודכנה ל: '${schema.title}'`);
    }

    // שלב 3️⃣ – רינדור כל מקטע בטופס
    schema.sections.forEach((section, sectionIndex) => {
      console.log(`📦 [renderForm] ▶ מקטע #${sectionIndex + 1}: ${section.title || "(ללא כותרת)"}`);

      // רינדור כותרת מקטע אם קיימת
      if (section.title) {
        const titleEl = document.createElement("h3");
        titleEl.className = "section-title";
        titleEl.textContent = section.title;
        container.appendChild(titleEl);
      }

      // רינדור שדות/כפתורים
      section.fields.forEach((item, i) => {
        console.log(`🔧 [renderForm] ▶ פריט #${i + 1}: id=${item.id}, type=${item.type}`);
        const isButton = item.type?.startsWith("button");
        const html = isButton ? renderButton(item) : renderField(item);

        if (!html) {
          console.warn(`⚠️ [renderForm] פריט '${item.id}' לא נרנדר`);
          return;
        }

        const wrapper = document.createElement("div");
        wrapper.innerHTML = html;
        container.appendChild(wrapper.firstElementChild);
      });
    });

    // שלב 4️⃣ – הסתרת שכבת טעינה
    const overlay = document.getElementById("loadingOverlay");
    if (overlay) {
      overlay.style.display = "none";
      console.log("✅ [renderForm] ▶ שכבת טעינה הוסתרה");
    }

    console.log("✅ [renderForm] ▶ סיום רינדור טופס");

  } catch (error) {
    console.error("❌ [renderForm] שגיאה כללית:", error);
  }
}



/**
 * פונקציה 001: showLoadingOverlay
 * מציגה את שכבת הטעינה (overlay) מעל הטופס.
 *
 * 📌 שלבי פעולה:
 * 1️⃣ מאתרת את האלמנט עם id="loadingOverlay"
 * 2️⃣ מגדירה display כ־flex לצורך הצגה
 * 3️⃣ רושמת לוגים למציאת האלמנט ולמצב הפעולה
 */
function showLoadingOverlay() {
  console.log("🟡 [showLoadingOverlay] ▶ מנסה להציג שכבת טעינה");

  try {
    const overlay = document.getElementById("loadingOverlay");

    if (!overlay) {
      console.warn("⚠️ [showLoadingOverlay] אלמנט 'loadingOverlay' לא נמצא בדף");
      return;
    }

    overlay.style.display = "flex";
    console.log("✅ [showLoadingOverlay] שכבת טעינה מוצגת");

  } catch (error) {
    console.error("❌ [showLoadingOverlay] שגיאה בהצגת שכבת טעינה:", error);
  }
}

/**
 * פונקציה 002: hideLoadingOverlay
 * מסתירה את שכבת הטעינה (overlay) שמכסה את הטופס.
 *
 * 📌 שלבי פעולה:
 * 1️⃣ מאתרת את האלמנט עם id="loadingOverlay"
 * 2️⃣ מגדירה display כ־none
 * 3️⃣ רושמת לוגים למציאת האלמנט ולמצב הפעולה
 */
function hideLoadingOverlay() {
  console.log("🟡 [hideLoadingOverlay] ▶ מנסה להסתיר שכבת טעינה");

  try {
    const overlay = document.getElementById("loadingOverlay");

    if (!overlay) {
      console.warn("⚠️ [hideLoadingOverlay] אלמנט 'loadingOverlay' לא נמצא בדף");
      return;
    }

    overlay.style.display = "none";
    console.log("✅ [hideLoadingOverlay] שכבת טעינה הוסתרה");

  } catch (error) {
    console.error("❌ [hideLoadingOverlay] שגיאה בהסתרת שכבת טעינה:", error);
  }
}
/**
 * פונקציה 003: updateLoadingOverlayText
 * 
 * 🧠 מעדכנת את הטקסט שמופיע בשכבת הטעינה (overlay) לפי ההקשר הלוגי.
 * 
 * 📌 שלבי פעולה:
 * 1️⃣ מאתרת את האלמנט שמכיל את התוכן (`.loading-content`)
 * 2️⃣ משנה את הטקסט הראשי (node הראשון) בהתאם להודעה
 * 3️⃣ משאירה את הספינר פעיל
 * 
 * @param {string} message - טקסט שיוצג ב־overlay
 */
function updateLoadingOverlayText(message) {
  try {
    const content = document.querySelector("#loadingOverlay .loading-content");
    if (!content) {
      console.warn("⚠️ [updateLoadingOverlayText] לא נמצא האלמנט '.loading-content'");
      return;
    }

    // עדכון הטקסט הראשי – childNodes[0] מניח שזה טקסט ישיר לפני ה-spinner
    if (content.childNodes.length > 0) {
      content.childNodes[0].textContent = message + " ";
      console.log(`ℹ️ [updateLoadingOverlayText] טקסט עודכן ל: "${message}"`);
    }
  } catch (error) {
    console.error("❌ [updateLoadingOverlayText] שגיאה בעדכון טקסט overlay:", error);
  }
}
