<!DOCTYPE html>
<html lang="he">
  <head>
    <meta charset="UTF-8">
    <title>פרא</title>

    <!-- 🎨 עיצוב בסיסי של הטופס -->
    <style>
      <?!= include("עיצוב טופס לקוח חדש") ?>
    </style>

    <!-- 📦 סכמת JSON שנבחרה דינאמית -->
    <?!= include(dynamicSchema) ?>

    <!-- 🧠 קוד JS מרוכז -->
    <script>
      <?!= include("טעינת_סכמות") ?>
      <?!= include("בניית טופס") ?>
      <?!= include("כללי - הודעות בראש הטופס") ?>
      <?!= include("כללי - הודעות לשדה בטופס") ?>
      <?!= include("ניהול נתוני הטופס - קונטקסט + תקינות") ?>
      <?!= include("כללי - קוד לניהול לחיצה על כפתורים") ?>
      <?!= include("לקוח חדש - טעינת נתונים") ?>
    </script>
  </head>
  <body>

    <!-- 🧱 שלד טופס בסיסי -->
    <?!= include("שלד של טופס") ?>

    <!-- 🧩 קומפוננטות -->
    <?!= include("קומפוננטות שדות") ?>
    <?!= include("קומפוננטות כפתורים") ?>

    <!-- 🚀 הפעלת בניית הטופס + טעינת נתונים מהשרת לפי הסכמה -->
  <script>
  /**
   * 🧠 DOMContentLoaded
   *
   * 🎯 מטרה:
   * תהליך אתחול מלא של טופס דינאמי:
   * כולל טעינת סכמה, בניית קונטקסט (schema + flatFields),
   * רינדור השדות, טעינת נתונים מהשרת לפי סוג הטופס,
   * והפעלת ניטור גלילה לשיפור חוויית משתמש.
   *
   * 📌 שלבי פעולה:
   * 1️⃣ טעינת הסכמה מתוך תגית JSON.
   * 2️⃣ המרת הסכמה למבנה שטוח ושמירתה בקונטקסט.
   * 3️⃣ רינדור הטופס לתוך ה־DOM.
   * 4️⃣ שמירת סוג הטופס והפעלת טעינת נתונים לפי סוג.
   * 5️⃣ הפעלת ניטור גלילה ועדכון כפתורי הגלילה.
   * 6️⃣ טיפול בשגיאות כלליות.
   */

  document.addEventListener("DOMContentLoaded", () => {
    console.log("🚀 [DOMContentLoaded] ▶ התחלת תהליך טעינת טופס");

    try {
      // שלב 1️⃣ – טעינת הסכמה מתוך תגית <script id="schema-dynamic">
      FORM_CONTEXT.schema = loadSchemaFromDOM("schema-dynamic");
      if (!FORM_CONTEXT.schema) {
        console.error("❌ [1️⃣] לא ניתן לטעון את הסכמה מה־DOM");
        showGlobalErrorMessage("❌ לא ניתן לטעון את הסכמה.");
        return;
      }
      console.log("✅ [1️⃣] סכמה נטענה בהצלחה:", FORM_CONTEXT.schema.title);

      // שלב 2️⃣ – המרת הסכמה למבנה שטוח ושמירה בקונטקסט
      FORM_CONTEXT.flatFields = flattenSchemaToFields(FORM_CONTEXT.schema);
      console.log("✅ [2️⃣] סכמת שדות שוטחה ונשמרה בקונטקסט");

      // שלב 3️⃣ – רינדור הטופס לפי הסכמה
      renderForm(FORM_CONTEXT.schema, "form-body");
      console.log("✅ [3️⃣] רינדור הטופס בוצע");

      // שלב 4️⃣ – שמירת סוג הטופס בקונטקסט והפעלת טעינת נתונים לפי צורך
      FORM_CONTEXT.formType = FORM_CONTEXT.schema.title;
      console.log(`ℹ️ [4️⃣] סוג הטופס הנוכחי: "${FORM_CONTEXT.formType}"`);

      if (FORM_CONTEXT.formType === "פתיחת לקוח חדש") {
        console.log("📡 [4️⃣.1] טעינת נתונים מהשרת לטופס 'לקוח חדש'");

        updateLoadingOverlayText("⏳ טוען נתונים מהשרת...");
        showLoadingOverlay();

        google.script.run
          .withSuccessHandler(handleFormData)
          .processCustomerForm();
      }

      // שלב 5️⃣ – ניטור גלילה ועדכון כפתורי גלילה
      monitorScrollPosition();
      console.log("✅ [5️⃣] ניטור גלילה הופעל");

    } catch (error) {
      // שלב 6️⃣ – טיפול בשגיאות כלליות
      console.error("❌ [DOMContentLoaded] שגיאה כללית במהלך טעינת הטופס:", error);
      showGlobalErrorMessage("❌ שגיאה בלתי צפויה בעת טעינת הטופס.");
    }
  });
</script>


  </body>
</html>
